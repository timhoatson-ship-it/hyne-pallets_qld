<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hyne Pallets — Manufacturing Management</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="style.css" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            navy: '#07324C',
            red: { hp: '#ED1C24' },
            lightblue: '#ABBFC8',
          }
        }
      }
    }
  </script>
</head>
<body style="margin:0;padding:0;background:#F5F7FA;font-family:'Segoe UI',system-ui,sans-serif;">

<div id="root"></div>
<div id="toast-container"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback, createContext, useContext } = React;

// ═══════════════════════════════════════════════════════════════
// GLOBAL CONFIG
// ═══════════════════════════════════════════════════════════════
const API_BASE = "/api";
const localDateStr = (d = new Date()) => { const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; };

// Sandbox compatibility stubs (not needed on Railway — always-on server)
let _sandboxReady = true;
let _sandboxListeners = [];
const _notifySandbox = (msg) => _sandboxListeners.forEach(fn => { try { fn(msg); } catch(e){} });
const onSandboxStatus = (fn) => { _sandboxListeners.push(fn); return () => { _sandboxListeners = _sandboxListeners.filter(f => f !== fn); }; };
const ensureSandbox = () => Promise.resolve(true);

const _buildUrl = (path, token) => {
  let routeUrl = `${API_BASE}${path}`;
  if (token) {
    const sep = routeUrl.includes('?') ? '&' : '?';
    routeUrl += `${sep}_token=${encodeURIComponent(token)}`;
  }
  return routeUrl;
};

const api = async (path, options = {}, token = null) => {
  const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const routeUrl = _buildUrl(path, token);
  const res = await fetch(routeUrl, { ...options, headers });
  const text = await res.text();
  let data;
  try { data = JSON.parse(text); } catch { data = { error: text }; }
  if (!res.ok) {
    throw new Error(data.error || `HTTP ${res.status}`);
  }
  return data;
};

// ═══════════════════════════════════════════════════════════════
// TOAST
// ═══════════════════════════════════════════════════════════════
const toast = (msg, type = 'info') => {
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.textContent = msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3500);
};

// ═══════════════════════════════════════════════════════════════
// STATUS HELPERS
// ═══════════════════════════════════════════════════════════════
const STATUS_LABELS = { T:'New/Tray', C:'Cut List', R:'Ready', P:'In Production', F:'Finished', dispatched:'Dispatched', delivered:'Delivered', collected:'Collected' };
const StatusBadge = ({ status }) => (
  <span className={`badge badge-${status}`}>{STATUS_LABELS[status] || status}</span>
);

const Spinner = () => <div className="spinner" />;
const Empty = ({ msg = 'No data found' }) => (
  <div className="flex flex-col items-center py-12 text-gray-400">
    <svg width="40" height="40" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="3"/><path d="M9 9h6M9 12h6M9 15h4"/></svg>
    <p className="mt-3 text-sm font-medium">{msg}</p>
  </div>
);

// Lucide icon helper
const Icon = ({ name, size = 18, className = '', strokeWidth = 1.8 }) => {
  const ref = useRef(null);
  useEffect(() => {
    try {
      if (ref.current && window.lucide) {
        // Try lucide icon creation
        const iconFn = window.lucide[name];
        if (typeof iconFn === 'function') {
          const result = iconFn([size, size], { class: className, 'stroke-width': strokeWidth });
          ref.current.innerHTML = '';
          if (typeof result === 'string') {
            ref.current.innerHTML = result;
          } else if (result instanceof SVGElement || result instanceof HTMLElement) {
            ref.current.innerHTML = '';
            ref.current.appendChild(result);
          } else if (Array.isArray(result) && result.length >= 2) {
            // Lucide returns [tag, attrs, children]
            const [tag, attrs, children] = result;
            const svg = document.createElementNS('http://www.w3.org/2000/svg', tag);
            if (attrs) Object.entries(attrs).forEach(([k,v]) => svg.setAttribute(k, v));
            svg.setAttribute('width', size);
            svg.setAttribute('height', size);
            svg.setAttribute('stroke', 'currentColor');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('stroke-width', strokeWidth);
            if (children) children.forEach(([ct, ca]) => {
              const child = document.createElementNS('http://www.w3.org/2000/svg', ct);
              if (ca) Object.entries(ca).forEach(([k,v]) => child.setAttribute(k, v));
              svg.appendChild(child);
            });
            ref.current.innerHTML = '';
            ref.current.appendChild(svg);
          }
        } else if (window.lucide.icons && window.lucide.icons[name]) {
          // Alternative API: lucide.icons[name]
          const iconData = window.lucide.icons[name];
          const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          svg.setAttribute('width', size);
          svg.setAttribute('height', size);
          svg.setAttribute('viewBox', '0 0 24 24');
          svg.setAttribute('fill', 'none');
          svg.setAttribute('stroke', 'currentColor');
          svg.setAttribute('stroke-width', strokeWidth);
          svg.setAttribute('stroke-linecap', 'round');
          svg.setAttribute('stroke-linejoin', 'round');
          if (Array.isArray(iconData)) {
            iconData.forEach(([tag, attrs]) => {
              const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
              if (attrs) Object.entries(attrs).forEach(([k,v]) => el.setAttribute(k, v));
              svg.appendChild(el);
            });
          }
          ref.current.innerHTML = '';
          ref.current.appendChild(svg);
        }
      }
    } catch(e) { /* Silently fail - icon just won't show */ }
  }, [name, size]);
  return <span ref={ref} style={{ display: 'inline-flex', alignItems: 'center', flexShrink: 0, width: size, height: size }} />;
};

// ═══════════════════════════════════════════════════════════════
// LOGIN PAGE
// ═══════════════════════════════════════════════════════════════
const LoginPage = ({ onLogin }) => {
  const [tab, setTab] = useState('office');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [username, setUsername] = useState('');
  const [pin, setPin] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [floorUsers, setFloorUsers] = useState([]);
  const [warmupMsg, setWarmupMsg] = useState('Connecting to server...');
  const [sandboxOk, setSandboxOk] = useState(false);

  useEffect(() => {
    // Subscribe to sandbox status updates for live progress
    const unsub = onSandboxStatus(msg => setWarmupMsg(msg));
    // Pre-warm the sandbox while user sees the login form
    ensureSandbox().then(ok => {
      setSandboxOk(ok);
      if (ok) {
        setWarmupMsg('');
        api('/users').then(u => setFloorUsers(u.filter(x => x.role === 'floor_worker'))).catch(() => {});
      } else {
        setWarmupMsg('Server unavailable — please refresh the page');
      }
    });
    return unsub;
  }, []);

  const handleOfficeLogin = async (e) => {
    e.preventDefault();
    setLoading(true); setError('');
    try {
      const data = await api('/auth/login', { method: 'POST', body: JSON.stringify({ email, password }) });
      if (!data || !data.user) { setError('Login failed — invalid response from server'); setLoading(false); return; }
      onLogin(data.user, data.token);
    } catch (err) {
      setError(err.message || 'Login failed');
    }
    setLoading(false);
  };

  const handlePinLogin = async () => {
    if (!username) { setError('Please select a username'); return; }
    if (pin.length < 4) { setError('Enter at least 4 digits'); return; }
    setLoading(true); setError('');
    try {
      const data = await api('/auth/pin-login', { method: 'POST', body: JSON.stringify({ username, pin }) });
      if (!data || !data.user) { setError('Login failed — invalid response from server'); setLoading(false); return; }
      onLogin(data.user, data.token);
    } catch (err) { setError(err.message || 'Login failed'); setPin(''); }
    setLoading(false);
  };

  const PinKey = ({ val, label }) => (
    <button className="pin-key no-select" onClick={() => {
      if (val === 'del') setPin(p => p.slice(0,-1));
      else if (pin.length < 8) setPin(p => p + val);
    }}>
      {label || val}
    </button>
  );

  return (
    <div className="min-h-screen flex flex-col" style={{background:'linear-gradient(135deg,#07324C 0%,#0a4a6e 60%,#0d5a88 100%)'}}>
      {/* Header */}
      <div className="flex items-center gap-4 p-8">
        <div className="logo-chevron" style={{width:40,height:40}}></div>
        <div>
          <div className="text-white text-2xl font-black tracking-widest">HYNE PALLETS</div>
          <div className="text-lightblue text-xs tracking-wider mt-0.5">MANUFACTURING MANAGEMENT SYSTEM</div>
        </div>
      </div>

      {/* Card */}
      <div className="flex-1 flex items-center justify-center px-4 pb-12">
        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
          {/* Tab bar */}
          <div className="flex">
            <button onClick={() => { setTab('office'); setError(''); }}
              className={`flex-1 py-4 text-sm font-bold transition-all ${tab==='office' ? 'bg-[#07324C] text-white' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}`}>
              Office Login
            </button>
            <button onClick={() => { setTab('floor'); setError(''); }}
              className={`flex-1 py-4 text-sm font-bold transition-all ${tab==='floor' ? 'bg-[#07324C] text-white' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}`}>
              Floor Login
            </button>
          </div>

          <div className="p-8">
            {warmupMsg && (
              <div className="mb-4 p-3 rounded-lg text-sm font-medium flex items-center gap-2" style={{background:'#eff6ff',border:'1px solid #bfdbfe',color:'#1e40af'}}>
                <svg className="animate-spin" style={{width:16,height:16}} viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="3" opacity="0.3"/>
                  <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" strokeWidth="3" strokeLinecap="round"/>
                </svg>
                {warmupMsg}
              </div>
            )}
            {error && <div className="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm font-medium">{error}</div>}

            {tab === 'office' ? (
              <form onSubmit={handleOfficeLogin} className="space-y-4">
                <div>
                  <label className="hp-label">Email Address</label>
                  <input className="hp-input" type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="you@hynepallets.com.au" required />
                </div>
                <div>
                  <label className="hp-label">Password</label>
                  <input className="hp-input" type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="••••••••" required />
                </div>
                <button className="btn btn-primary w-full justify-center py-3 text-base mt-2" disabled={loading}>
                  {loading ? <Spinner /> : 'Sign In'}
                </button>
                <p className="text-xs text-gray-400 text-center mt-2">Demo: tim@hynepallets.com.au / admin123</p>
              </form>
            ) : (
              <div>
                <div className="mb-4">
                  <label className="hp-label">Worker Name</label>
                  <select className="hp-input" value={username} onChange={e=>setUsername(e.target.value)}>
                    <option value="">— Select your name —</option>
                    {floorUsers.map(u => <option key={u.id} value={u.username}>{u.full_name}</option>)}
                    <option value="bob.floor">Bob Floor (demo)</option>
                  </select>
                </div>
                {/* PIN dots */}
                <div className="flex justify-center gap-3 my-4">
                  {[0,1,2,3,4,5].map(i => (
                    <div key={i} className={`pin-dot ${i < pin.length ? 'filled' : ''}`}></div>
                  ))}
                </div>
                {/* Numpad */}
                <div className="grid grid-cols-3 gap-3 justify-items-center mb-4">
                  {[1,2,3,4,5,6,7,8,9].map(n => <PinKey key={n} val={String(n)} />)}
                  <PinKey val="del" label="⌫" />
                  <PinKey val="0" />
                  <button className="pin-key no-select bg-[#07324C] text-white border-[#07324C]" onClick={handlePinLogin} disabled={loading}>
                    {loading ? '...' : '✓'}
                  </button>
                </div>
                <p className="text-xs text-gray-400 text-center">Demo PIN: 123456</p>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// ═══════════════════════════════════════════════════════════════
// SIDEBAR
// ═══════════════════════════════════════════════════════════════
const NAV_ITEMS = [
  { id: 'dashboard', label: 'Dashboard', icon: 'LayoutDashboard', roles: ['executive','admin','office','planner','qa','dispatch','ops_manager'] },
  { id: 'office', label: 'Office', icon: 'Briefcase', roles: ['executive','admin','office','ops_manager'] },
  { id: 'planning', label: 'Planning', icon: 'CalendarDays', roles: ['executive','admin','planner','ops_manager','production_manager'] },
  { id: 'allocation', label: 'Station Alloc', icon: 'Users', roles: ['production_manager','executive','admin','ops_manager','planner'] },
  { id: 'floor', label: 'Production', icon: 'Factory', roles: ['floor_worker','team_leader','production_manager','executive','admin','ops_manager','planner'] },
  { id: 'qa', label: 'QA', icon: 'ShieldCheck', roles: ['qa','team_leader','executive','admin','ops_manager'] },
  { id: 'dispatch', label: 'Dispatch', icon: 'Truck', roles: ['dispatch','executive','admin','ops_manager'] },
  { id: 'ops', label: 'Ops Manager', icon: 'BarChart3', roles: ['executive','admin','ops_manager'] },
  { id: 'admin', label: 'Admin', icon: 'Settings', roles: ['executive','admin'] },
];

const Sidebar = ({ page, onNav, user, onLogout, collapsed }) => {
  const visibleItems = NAV_ITEMS.filter(item => item.roles.includes(user?.role) || user?.role === 'executive' || user?.role === 'admin');

  return (
    <div id="sidebar" className={collapsed ? 'collapsed' : ''} style={{display:'flex',flexDirection:'column',height:'100vh',position:'sticky',top:0}}>
      {/* Logo */}
      <div className="logo-area" style={{display:'flex',alignItems:'center',gap:'10px',padding:'20px 16px',borderBottom:'1px solid rgba(171,191,200,0.2)',flexShrink:0}}>
        <div className="logo-chevron"></div>
        <div className="logo-text" style={{color:'white'}}>
          <div style={{fontWeight:900,fontSize:'15px',letterSpacing:'0.12em'}}>HYNE PALLETS</div>
          <div style={{fontSize:'10px',color:'#ABBFC8',letterSpacing:'0.08em'}}>MFG MANAGEMENT</div>
        </div>
      </div>

      {/* Nav */}
      <nav style={{flex:1,overflowY:'auto',padding:'8px 0'}}>
        {visibleItems.map(item => (
          <div key={item.id} className={`nav-item ${page===item.id?'active':''}`} onClick={() => onNav(item.id)}>
            <Icon name={item.icon} size={18} />
            <span className="nav-label" style={{fontSize:'14px',fontWeight:600}}>{item.label}</span>
          </div>
        ))}
      </nav>

      {/* User info */}
      <div style={{borderTop:'1px solid rgba(171,191,200,0.2)',padding:'12px 8px',flexShrink:0}}>
        <div className="user-info" style={{padding:'8px 12px',marginBottom:'4px'}}>
          <div style={{color:'#ABBFC8',fontSize:'12px',textTransform:'uppercase',letterSpacing:'0.05em',fontWeight:600}}>{user?.role?.replace('_',' ')}</div>
          <div style={{color:'white',fontSize:'14px',fontWeight:600,marginTop:'2px'}}>{user?.full_name}</div>
        </div>
        <div className="nav-item" onClick={onLogout}>
          <Icon name="LogOut" size={18} />
          <span className="nav-label" style={{fontSize:'14px',fontWeight:600}}>Logout</span>
        </div>
      </div>
    </div>
  );
};

// ═══════════════════════════════════════════════════════════════
// DASHBOARD / OPS MANAGER
// ═══════════════════════════════════════════════════════════════
const Dashboard = ({ token, isOps = false }) => {
  const [orderStats, setOrderStats] = useState(null);
  const [prodStats, setProdStats] = useState(null);
  const [loading, setLoading] = useState(true);

  const load = useCallback(async () => {
    try {
      const [os, ps] = await Promise.all([
        api('/stats/orders', {}, token),
        api('/stats/production', {}, token),
      ]);
      setOrderStats(os);
      setProdStats(ps);
    } catch (e) { toast(e.message, 'error'); }
    setLoading(false);
  }, [token]);

  useEffect(() => { load(); }, [load]);

  if (loading) return <div className="flex items-center justify-center h-64"><Spinner /></div>;

  const pipeline = orderStats?.by_status || [];
  const zones = prodStats?.zone_stats || [];
  const STATUS_ORDER = ['T','C','R','P','F','dispatched','delivered'];
  const pipelineMap = {};
  pipeline.forEach(s => pipelineMap[s.status] = s);
  // Item-level pipeline counts map
  const itemPipelineMap = {};
  (prodStats?.item_pipeline || []).forEach(ip => { itemPipelineMap[ip.status] = ip; });

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-black text-[#07324C]">{isOps ? 'Operations Overview' : 'Dashboard'}</h1>
          <p className="text-sm text-gray-500 mt-0.5">{new Date().toLocaleDateString('en-AU',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</p>
        </div>
        <button className="btn btn-outline btn-sm" onClick={load}><Icon name="RefreshCw" size={14}/> Refresh</button>
      </div>

      {/* Order pipeline */}
      <div className="hp-card">
        <h2 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4">Order Pipeline</h2>
        <div className="flex gap-2 overflow-x-auto pb-2">
          {STATUS_ORDER.map(s => {
            const d = pipelineMap[s];
            const colors = { T:'#6b7280', C:'#1d4ed8', R:'#92400e', P:'#9a3412', F:'#166534', dispatched:'#5b21b6', delivered:'#155e75' };
            const bgs = { T:'#f3f4f6', C:'#dbeafe', R:'#fef3c7', P:'#fed7aa', F:'#dcfce7', dispatched:'#ede9fe', delivered:'#cffafe' };
            return (
              <div key={s} className="funnel-step" style={{minWidth:100}}>
                <div style={{background:bgs[s]||'#f3f4f6',borderRadius:8,padding:'12px 16px',textAlign:'center',width:'100%'}}>
                  <div style={{fontSize:28,fontWeight:900,color:colors[s]||'#374151'}}>{d?.count||0}</div>
                  <div style={{fontSize:15,fontWeight:700,color:colors[s]||'#374151',marginTop:2}}>{STATUS_LABELS[s]}</div>
                  {d?.total_value > 0 && <div style={{fontSize:14,color:'#6b7280',marginTop:2}}>${Number(d.total_value).toLocaleString()}</div>}
                  {itemPipelineMap[s] && (
                    <div style={{fontSize:15,color:'#9ca3af',marginTop:3}}>
                      {itemPipelineMap[s].item_count} item{itemPipelineMap[s].item_count!==1?'s':''}
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Zone production cards */}
      <div>
        <h2 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Today's Production by Zone</h2>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          {['VIK','HMP','DTL','CRT'].map(code => zones.find(z=>z.code===code)).filter(Boolean).map(z => (
            <div key={z.code} className="stat-card" style={{borderLeftColor: z.sessions_today > 0 ? '#22C55E' : '#ABBFC8'}}>
              <div className="text-xs font-bold text-gray-400 uppercase tracking-wider">{z.zone_name}</div>
              <div className="text-3xl font-black text-[#07324C] mt-1">{z.units_produced.toLocaleString()}</div>
              <div className="text-xs text-gray-500 mt-1">{z.sessions_today} session{z.sessions_today !== 1 ? 's' : ''} today</div>
            </div>
          ))}
        </div>
      </div>

      {/* Summary row */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="stat-card" style={{borderLeftColor:'#F59E0B'}}>
          <div className="text-xs font-bold text-gray-400 uppercase tracking-wider">Total Orders</div>
          <div className="text-3xl font-black text-[#07324C] mt-1">{orderStats?.totals?.orders || 0}</div>
          <div className="text-xs text-gray-500 mt-1">All time</div>
        </div>
        <div className="stat-card" style={{borderLeftColor:'#ED1C24'}}>
          <div className="text-xs font-bold text-gray-400 uppercase tracking-wider">Active Sessions</div>
          <div className="text-3xl font-black text-[#07324C] mt-1">{prodStats?.active_sessions || 0}</div>
          <div className="text-xs text-gray-500 mt-1">On floor now</div>
        </div>
        <div className="stat-card" style={{borderLeftColor:'#22C55E'}}>
          <div className="text-xs font-bold text-gray-400 uppercase tracking-wider">Today's Value</div>
          <div className="text-3xl font-black text-[#07324C] mt-1">${Number(prodStats?.today_completed_value || 0).toLocaleString()}</div>
          <div className="text-xs text-gray-500 mt-1">Completed production</div>
        </div>
      </div>

      {/* Alerts */}
      {isOps && (
        <div className="hp-card">
          <h2 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Alerts</h2>
          {(pipelineMap['T']?.count > 0) && (
            <div className="flex items-center gap-3 p-3 bg-amber-50 border border-amber-200 rounded-lg mb-2">
              <Icon name="AlertTriangle" size={16} className="text-amber-600" />
              <span className="text-sm font-medium text-amber-800">{pipelineMap['T']?.count} orders awaiting office verification</span>
            </div>
          )}
          {(pipelineMap['F']?.count > 0) && (
            <div className="flex items-center gap-3 p-3 bg-blue-50 border border-blue-200 rounded-lg mb-2">
              <Icon name="Package" size={16} className="text-blue-600" />
              <span className="text-sm font-medium text-blue-800">{pipelineMap['F']?.count} finished orders awaiting dispatch</span>
            </div>
          )}
          {!pipelineMap['T']?.count && !pipelineMap['F']?.count && (
            <p className="text-sm text-gray-400">No active alerts.</p>
          )}
        </div>
      )}
    </div>
  );
};

// ═══════════════════════════════════════════════════════════════
// OFFICE DASHBOARD
// ═══════════════════════════════════════════════════════════════
const OfficeDashboard = ({ token }) => {
  const [tab, setTab] = useState('unverified');
  const [orders, setOrders] = useState([]);
  const [allOrders, setAllOrders] = useState([]);
  const [loading, setLoading] = useState(true);
  const [expanded, setExpanded] = useState(null);
  const [historySearch, setHistorySearch] = useState('');
  const [historyStatus, setHistoryStatus] = useState('');
  const [verifyData, setVerifyData] = useState({});
  const [expandedEtaOrder, setExpandedEtaOrder] = useState(null);
  const [etaOrderItems, setEtaOrderItems] = useState([]);
  const [etaOrderDetail, setEtaOrderDetail] = useState(null);

  // New Client form state
  const [clients, setClients] = useState([]);
  const [skus, setSkus] = useState([]);
  const [clientForm, setClientForm] = useState({ company_name:'', contact_name:'', email:'', phone:'', address:'', payment_terms:'30 days' });
  const [clientSaving, setClientSaving] = useState(false);
  const [clientSearch, setClientSearch] = useState('');
  const [selectedClient, setSelectedClient] = useState(null);
  const [clientContacts, setClientContacts] = useState([]);
  const [editingClient, setEditingClient] = useState(null);
  const [contactForm, setContactForm] = useState({ contact_name:'', email:'', phone:'', role_title:'', email_purpose:'general', receives_sensitive:0, notes:'' });

  // New Order form state
  const [orderForm, setOrderForm] = useState({ order_number:'', client_id:'', delivery_type:'delivery', requested_delivery_date:'', special_instructions:'', notes:'' });
  const [orderLines, setOrderLines] = useState([{ sku_id:'', quantity:1, special_instructions:'', skuSearch:'' }]);
  const [orderSaving, setOrderSaving] = useState(false);

  const loadOrders = useCallback(async () => {
    setLoading(true);
    try {
      const [unver, all] = await Promise.all([
        api('/orders?status=T', {}, token),
        api('/orders', {}, token),
      ]);
      setOrders(unver.filter(o => !o.is_verified));
      setAllOrders(all);
    } catch (e) { toast(e.message, 'error'); }
    setLoading(false);
  }, [token]);

  useEffect(() => { loadOrders(); }, [loadOrders]);

  // Load clients and SKUs for forms
  const loadRefData = useCallback(async () => {
    try {
      const [c, s] = await Promise.all([
        api('/clients', {}, token),
        api('/skus', {}, token),
      ]);
      setClients(c); setSkus(s);
    } catch (e) { console.error(e); }
  }, [token]);
  useEffect(() => { loadRefData(); }, [loadRefData]);

  // Generate next order number
  const generateOrderNumber = () => {
    const d = new Date();
    const prefix = 'ORD-' + d.getFullYear() + String(d.getMonth()+1).padStart(2,'0');
    const seq = String(Math.floor(Math.random()*9000)+1000);
    return prefix + '-' + seq;
  };

  // Submit new client
  const submitClient = async () => {
    if (!clientForm.company_name.trim()) { toast('Company name is required', 'warning'); return; }
    setClientSaving(true);
    try {
      await api('/clients', { method:'POST', body: JSON.stringify(clientForm) }, token);
      toast('Client created successfully', 'success');
      setClientForm({ company_name:'', contact_name:'', email:'', phone:'', address:'', payment_terms:'30 days' });
      loadRefData();
    } catch (e) { toast(e.message, 'error'); }
    setClientSaving(false);
  };

  // Client card functions
  const openClientCard = async (clientId) => {
    try {
      const client = await api(`/clients/${clientId}`, {}, token);
      setSelectedClient(client);
      setClientContacts(client.contacts || []);
      setEditingClient({...client});
      setContactForm({ contact_name:'', email:'', phone:'', role_title:'', email_purpose:'general', receives_sensitive:0, notes:'' });
    } catch(e) { toast(e.message, 'error'); }
  };

  const updateClient = async () => {
    if (!editingClient) return;
    try {
      const updated = await api(`/clients/${editingClient.id}`, {
        method: 'PUT',
        body: JSON.stringify({
          company_name: editingClient.company_name,
          contact_name: editingClient.contact_name,
          email: editingClient.email,
          phone: editingClient.phone,
          address: editingClient.address,
          payment_terms: editingClient.payment_terms
        })
      }, token);
      setSelectedClient(updated);
      setEditingClient({...updated});
      loadRefData();
      toast('Client updated', 'success');
    } catch(e) { toast(e.message, 'error'); }
  };

  const addContact = async () => {
    if (!selectedClient || !contactForm.contact_name) { toast('Contact name required', 'warning'); return; }
    try {
      const c = await api(`/clients/${selectedClient.id}/contacts`, {
        method: 'POST',
        body: JSON.stringify(contactForm)
      }, token);
      setClientContacts(prev => [...prev, c]);
      setContactForm({ contact_name:'', email:'', phone:'', role_title:'', email_purpose:'general', receives_sensitive:0, notes:'' });
      toast('Contact added', 'success');
    } catch(e) { toast(e.message, 'error'); }
  };

  const updateContact = async (contactId, updates) => {
    try {
      const c = await api(`/clients/${selectedClient.id}/contacts/${contactId}`, {
        method: 'PUT',
        body: JSON.stringify(updates)
      }, token);
      setClientContacts(prev => prev.map(x => x.id === contactId ? c : x));
      toast('Contact updated', 'success');
    } catch(e) { toast(e.message, 'error'); }
  };

  const deleteContact = async (contactId) => {
    try {
      await api(`/clients/${selectedClient.id}/contacts/${contactId}`, { method: 'DELETE' }, token);
      setClientContacts(prev => prev.filter(x => x.id !== contactId));
      toast('Contact removed', 'success');
    } catch(e) { toast(e.message, 'error'); }
  };

  // Submit new order
  const submitOrder = async () => {
    if (!orderForm.order_number.trim()) { toast('Order number is required', 'warning'); return; }
    if (!orderForm.client_id) { toast('Please select a client', 'warning'); return; }
    const validLines = orderLines.filter(l => l.sku_id && l.quantity > 0);
    if (validLines.length === 0) { toast('Add at least one line item with a SKU and quantity', 'warning'); return; }
    setOrderSaving(true);
    try {
      const order = await api('/orders', { method:'POST', body: JSON.stringify(orderForm) }, token);
      // Add line items
      for (const line of validLines) {
        const sku = skus.find(s => s.id === parseInt(line.sku_id));
        await api(`/orders/${order.id}/items`, { method:'POST', body: JSON.stringify({
          sku_id: parseInt(line.sku_id),
          sku_code: sku?.code || '',
          product_name: sku?.name || '',
          quantity: parseInt(line.quantity),
          zone_id: sku?.zone_id || null,
          special_instructions: line.special_instructions || null
        })}, token);
      }
      toast(`Order ${order.order_number} created with ${validLines.length} line item(s)`, 'success');
      setOrderForm({ order_number:'', client_id:'', delivery_type:'delivery', requested_delivery_date:'', special_instructions:'', notes:'' });
      setOrderLines([{ sku_id:'', quantity:1, special_instructions:'', skuSearch:'' }]);
      loadOrders();
      setTab('unverified');
    } catch (e) { toast(e.message, 'error'); }
    setOrderSaving(false);
  };

  // Order line helpers
  const addLine = () => setOrderLines(prev => [...prev, { sku_id:'', quantity:1, special_instructions:'', skuSearch:'' }]);
  const removeLine = (idx) => setOrderLines(prev => prev.length <= 1 ? prev : prev.filter((_,i) => i !== idx));
  const updateLine = (idx, field, val) => setOrderLines(prev => prev.map((l,i) => i === idx ? { ...l, [field]: val } : l));

  const verifyOrder = async (orderId) => {
    try {
      await api(`/orders/${orderId}/verify`, { method: 'PUT' }, token);
      toast('Order verified successfully', 'success');
      loadOrders();
      setExpanded(null);
    } catch (e) { toast(e.message, 'error'); }
  };

  const setETA = async (orderId, etaDate) => {
    if (!etaDate) { toast('Please select a date', 'warning'); return; }
    try {
      await api(`/orders/${orderId}/eta`, { method: 'PUT', body: JSON.stringify({ eta_date: etaDate }) }, token);
      toast('ETA set successfully', 'success');
      loadOrders();
    } catch (e) { toast(e.message, 'error'); }
  };

  const setItemETA = async (itemId, etaDate) => {
    if (!etaDate) { toast('Please select a date', 'warning'); return; }
    try {
      await api(`/order-items/${itemId}/eta`, { method: 'PUT', body: JSON.stringify({ eta_date: etaDate }) }, token);
      toast('Item ETA set', 'success');
      loadOrders();
    } catch (e) { toast(e.message, 'error'); }
  };

  // Orders needing ETA: any order in C/R/P status that has at least one item without eta_date
  const scheduledOrders = allOrders.filter(o => {
    if (o.is_stock_run) return false;
    if (!['C','R','P'].includes(o.status)) return false;
    const breakdown = o.item_status_breakdown || {};
    const hasActiveItems = ['C','R','P'].some(s => (breakdown[s] || 0) > 0);
    return hasActiveItems;
  });
  const historyFiltered = allOrders.filter(o => {
    const matchSearch = !historySearch || o.order_number?.toLowerCase().includes(historySearch.toLowerCase()) || o.client_name?.toLowerCase().includes(historySearch.toLowerCase());
    const matchStatus = !historyStatus || o.status === historyStatus;
    return matchSearch && matchStatus;
  });

  return (
    <div className="p-6 space-y-4">
      <h1 className="text-2xl font-black text-[#07324C]">Office Dashboard</h1>

      <div className="tab-bar">
        <div className={`tab-item ${tab==='unverified'?'active':''}`} onClick={()=>setTab('unverified')}>
          Order Confirmation {orders.length > 0 && <span className="ml-1.5 bg-red-500 text-white text-xs rounded-full px-2">{orders.length}</span>}
        </div>
        <div className={`tab-item ${tab==='eta'?'active':''}`} onClick={()=>setTab('eta')}>
          Set ETA {scheduledOrders.length > 0 && <span className="ml-1.5 bg-amber-500 text-white text-xs rounded-full px-2">{scheduledOrders.length}</span>}
        </div>
        <div className={`tab-item ${tab==='history'?'active':''}`} onClick={()=>setTab('history')}>Order Stage</div>
        <div className={`tab-item ${tab==='neworder'?'active':''}`} onClick={()=>{ setTab('neworder'); if(!orderForm.order_number) setOrderForm(f=>({...f, order_number: generateOrderNumber()})); }}>
          <Icon name="FilePlus" size={14} /> New Order
        </div>
        <div className={`tab-item ${tab==='newclient'?'active':''}`} onClick={()=>setTab('newclient')}>
          <Icon name="UserPlus" size={14} /> New Client
        </div>
      </div>

      {loading ? <div className="flex justify-center py-12"><Spinner /></div> : (
        <>
          {/* NEW ORDER */}
          {tab === 'neworder' && (
            <div className="hp-card">
              <h2 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4">Create New Order</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                  <label className="block text-xs font-bold text-gray-600 mb-1">Order Number *</label>
                  <div className="flex gap-2">
                    <input className="hp-input flex-1" value={orderForm.order_number} onChange={e => setOrderForm(f=>({...f, order_number: e.target.value}))} placeholder="ORD-202602-0001" />
                    <button className="btn btn-sm" style={{background:'#e2e8f0',color:'#07324C'}} onClick={() => setOrderForm(f=>({...f, order_number: generateOrderNumber()}))}>Generate</button>
                  </div>
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-600 mb-1">Client *</label>
                  <select className="hp-input" value={orderForm.client_id} onChange={e => setOrderForm(f=>({...f, client_id: e.target.value}))}>
                    <option value="">— Select Client —</option>
                    {clients.map(c => <option key={c.id} value={c.id}>{c.company_name}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-600 mb-1">Delivery Type</label>
                  <select className="hp-input" value={orderForm.delivery_type} onChange={e => setOrderForm(f=>({...f, delivery_type: e.target.value}))}>
                    <option value="delivery">Delivery</option>
                    <option value="collection">Collection</option>
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-600 mb-1">Special Instructions</label>
                  <input className="hp-input" value={orderForm.special_instructions} onChange={e => setOrderForm(f=>({...f, special_instructions: e.target.value}))} placeholder="e.g. Heat treated, specific stencil..." />
                </div>
                <div className="md:col-span-2">
                  <label className="block text-xs font-bold text-gray-600 mb-1">Notes</label>
                  <textarea className="hp-input" rows="2" value={orderForm.notes} onChange={e => setOrderForm(f=>({...f, notes: e.target.value}))} placeholder="Internal notes..." />
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-600 mb-1">Requested Delivery Date</label>
                  <input type="date" className="hp-input" value={orderForm.requested_delivery_date} onChange={e => setOrderForm(f=>({...f, requested_delivery_date: e.target.value}))} />
                  <span className="text-xs text-gray-400">Optional — customer-requested delivery deadline</span>
                </div>
              </div>

              <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Line Items</h3>
              <div className="space-y-3 mb-4">
                {orderLines.map((line, idx) => {
                  const selectedSku = skus.find(s => s.id === parseInt(line.sku_id));
                  return (
                    <div key={idx} className="flex flex-wrap items-end gap-3 p-3 bg-gray-50 rounded-lg border">
                      <div className="flex-1" style={{minWidth:260}}>
                        <label className="block text-xs font-bold text-gray-600 mb-1">Product / SKU *</label>
                        <input className="hp-input mb-1" placeholder="Type to search SKUs..." value={line.skuSearch} onChange={e => { updateLine(idx, 'skuSearch', e.target.value); if(line.sku_id) updateLine(idx, 'sku_id', ''); }} />
                        <select className="hp-input" value={line.sku_id} onChange={e => { updateLine(idx, 'sku_id', e.target.value); const s = skus.find(sk=>sk.id===parseInt(e.target.value)); if(s) updateLine(idx, 'skuSearch', s.code + ' ' + s.name); }}>
                          <option value="">— {line.skuSearch ? `${skus.filter(s => { const q = line.skuSearch.toLowerCase(); return s.code.toLowerCase().includes(q) || s.name.toLowerCase().includes(q); }).length} matches` : 'Select SKU'} —</option>
                          {skus.filter(s => { if (!line.skuSearch) return true; const q = line.skuSearch.toLowerCase(); return s.code.toLowerCase().includes(q) || s.name.toLowerCase().includes(q); }).map(s => <option key={s.id} value={s.id}>{s.code} — {s.name}</option>)}
                        </select>
                        {selectedSku && <span className="text-xs text-gray-400 mt-0.5 block">Zone: {selectedSku.zone_id === 1 ? 'Viking' : selectedSku.zone_id === 2 ? 'Handmade' : selectedSku.zone_id === 3 ? 'DTL' : 'Crates'}</span>}
                      </div>
                      <div style={{width:100}}>
                        <label className="block text-xs font-bold text-gray-600 mb-1">Qty *</label>
                        <input type="number" min="1" className="hp-input" value={line.quantity} onChange={e => updateLine(idx, 'quantity', e.target.value)} />
                      </div>
                      <div className="flex-1" style={{minWidth:180}}>
                        <label className="block text-xs font-bold text-gray-600 mb-1">Line Notes</label>
                        <input className="hp-input" value={line.special_instructions} onChange={e => updateLine(idx, 'special_instructions', e.target.value)} placeholder="Optional" />
                      </div>
                      <button className="btn btn-sm" style={{background:'#fee2e2',color:'#991b1b'}} onClick={() => removeLine(idx)} disabled={orderLines.length <= 1}>
                        <Icon name="Trash2" size={14} />
                      </button>
                    </div>
                  );
                })}
              </div>
              <div className="flex items-center gap-3">
                <button className="btn btn-sm" style={{background:'#e2e8f0',color:'#07324C'}} onClick={addLine}>
                  <Icon name="Plus" size={14} /> Add Line Item
                </button>
                <div className="flex-1" />
                <button className="btn btn-primary" onClick={submitOrder} disabled={orderSaving}>
                  {orderSaving ? 'Creating...' : 'Create Order'}
                </button>
              </div>
            </div>
          )}

          {/* NEW CLIENT */}
          {tab === 'newclient' && (
            <div className="hp-card">
              <h2 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4">Add New Client</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                  <label className="block text-xs font-bold text-gray-600 mb-1">Company Name *</label>
                  <input className="hp-input" value={clientForm.company_name} onChange={e => setClientForm(f=>({...f, company_name: e.target.value}))} placeholder="e.g. ABC Logistics Pty Ltd" />
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-600 mb-1">Contact Name</label>
                  <input className="hp-input" value={clientForm.contact_name} onChange={e => setClientForm(f=>({...f, contact_name: e.target.value}))} placeholder="e.g. John Smith" />
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-600 mb-1">Email</label>
                  <input type="email" className="hp-input" value={clientForm.email} onChange={e => setClientForm(f=>({...f, email: e.target.value}))} placeholder="john@abclogistics.com.au" />
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-600 mb-1">Phone</label>
                  <input className="hp-input" value={clientForm.phone} onChange={e => setClientForm(f=>({...f, phone: e.target.value}))} placeholder="07 3000 0000" />
                </div>
                <div className="md:col-span-2">
                  <label className="block text-xs font-bold text-gray-600 mb-1">Address</label>
                  <input className="hp-input" value={clientForm.address} onChange={e => setClientForm(f=>({...f, address: e.target.value}))} placeholder="Full address" />
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-600 mb-1">Payment Terms</label>
                  <select className="hp-input" value={clientForm.payment_terms} onChange={e => setClientForm(f=>({...f, payment_terms: e.target.value}))}>
                    <option value="7 days">7 Days</option>
                    <option value="14 days">14 Days</option>
                    <option value="30 days">30 Days</option>
                    <option value="60 days">60 Days</option>
                    <option value="COD">COD</option>
                    <option value="Prepaid">Prepaid</option>
                  </select>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <button className="btn btn-primary" onClick={submitClient} disabled={clientSaving}>
                  {clientSaving ? 'Saving...' : 'Add Client'}
                </button>
                <span className="text-xs text-gray-400">Client will be available for new orders immediately</span>
              </div>

              {/* Existing clients with search */}
              {clients.length > 0 && (
                <div className="mt-6 pt-4 border-t">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider">Existing Clients ({clients.length})</h3>
                    <input 
                      className="hp-input" 
                      style={{maxWidth:220,fontSize:15}} 
                      placeholder="Search clients…" 
                      value={clientSearch} 
                      onChange={e=>setClientSearch(e.target.value)} 
                    />
                  </div>
                  <div className="table-scroll">
                    <table className="hp-table">
                      <thead>
                        <tr><th>Company</th><th>Contact</th><th>Email</th><th>Phone</th><th>Terms</th><th></th></tr>
                      </thead>
                      <tbody>
                        {clients.filter(c => !clientSearch || c.company_name?.toLowerCase().includes(clientSearch.toLowerCase()) || c.contact_name?.toLowerCase().includes(clientSearch.toLowerCase()) || c.email?.toLowerCase().includes(clientSearch.toLowerCase())).map(c => (
                          <tr key={c.id}>
                            <td className="font-bold text-[#07324C] cursor-pointer hover:underline" onClick={() => openClientCard(c.id)}>{c.company_name}</td>
                            <td>{c.contact_name || '—'}</td>
                            <td className="text-xs">{c.email || '—'}</td>
                            <td className="text-xs">{c.phone || '—'}</td>
                            <td className="text-xs">{c.payment_terms || '—'}</td>
                            <td><button className="text-xs text-blue-600 hover:underline" onClick={() => openClientCard(c.id)}>View</button></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* UNVERIFIED */}
          {tab === 'unverified' && (
            <div className="hp-card">
              <h2 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4">Order Confirmation ({orders.length})</h2>
              {orders.length === 0 ? <Empty msg="All orders are verified — great work!" /> : (
                <div className="table-scroll">
                  <table className="hp-table">
                    <thead>
                      <tr><th>Order #</th><th>Client</th><th>Items</th><th>Date</th><th>Special Instructions</th><th></th></tr>
                    </thead>
                    <tbody>
                      {orders.map(o => (
                        <React.Fragment key={o.id}>
                          <tr>
                            <td className="font-bold text-[#07324C]">{o.order_number}</td>
                            <td>{o.client_name}</td>
                            <td>{o.item_count} item{o.item_count!==1?'s':''} · {o.total_qty} units</td>
                            <td>{o.created_at?.split('T')[0]}</td>
                            <td className="text-xs text-gray-500 max-w-48 truncate">{o.special_instructions || '—'}</td>
                            <td>
                              <button className="btn btn-primary btn-sm" onClick={() => setExpanded(expanded===o.id?null:o.id)}>
                                {expanded===o.id ? 'Close' : 'Review'}
                              </button>
                            </td>
                          </tr>
                          {expanded === o.id && (
                            <tr>
                              <td colSpan="6" className="p-0">
                                <OrderVerifyPanel order={o} token={token} onVerify={()=>verifyOrder(o.id)} />
                              </td>
                            </tr>
                          )}
                        </React.Fragment>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {/* SET ETA */}
          {tab === 'eta' && (
            <div className="hp-card">
              <div className="flex items-start justify-between mb-4">
                <div>
                  <h2 className="text-sm font-bold text-gray-500 uppercase tracking-wider">Orders Needing Manufacture ETA ({scheduledOrders.length})</h2>
                  <p className="text-xs text-gray-400 mt-1">Set dispatch ETA per line item. Expand an order to set individual item dates, or use the order-level date to apply to all items at once.</p>
                </div>
              </div>
              {scheduledOrders.length === 0 ? <Empty msg="All scheduled orders have ETAs set" /> : (
                <div className="space-y-3">
                  {scheduledOrders.map(o => {
                    const isExpanded = expandedEtaOrder === o.id;
                    const orderEtaKey = `eta_order_${o.id}`;
                    const orderEtaVal = verifyData[orderEtaKey] || '';
                    return (
                      <div key={o.id} style={{border:'1px solid #e2e8f0',borderRadius:8,overflow:'hidden'}}>
                        {/* Order header row */}
                        <div
                          style={{background:'#f8fafc',padding:'10px 14px',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'space-between',borderBottom: isExpanded ? '1px solid #e2e8f0' : 'none'}}
                          onClick={async () => {
                            if (isExpanded) {
                              setExpandedEtaOrder(null);
                              setEtaOrderItems([]);
                              setEtaOrderDetail(null);
                            } else {
                              setExpandedEtaOrder(o.id);
                              try {
                                const [detail, items] = await Promise.all([
                                  api(`/orders/${o.id}`, {}, token),
                                  api(`/orders/${o.id}/items`, {}, token)
                                ]);
                                setEtaOrderDetail(detail);
                                setEtaOrderItems(items);
                              } catch(e) { toast(e.message,'error'); }
                            }
                          }}
                        >
                          <div style={{display:'flex',alignItems:'center',gap:10}}>
                            <span style={{fontWeight:800,color:'#07324C',fontSize:14}}>{o.order_number}</span>
                            <span style={{fontSize:15,color:'#6b7280'}}>{o.client_name}</span>
                            <StatusBadge status={o.status} />
                            {o.progress && <span style={{fontSize:14,color:'#6b7280',background:'#f3f4f6',borderRadius:4,padding:'1px 6px'}}>{o.progress} items done</span>}
                          </div>
                          <div style={{display:'flex',alignItems:'center',gap:8}} onClick={e=>e.stopPropagation()}>
                            <input type="date" className="hp-input" style={{width:150,fontSize:15}}
                              value={orderEtaVal}
                              onChange={e=>setVerifyData(p=>({...p,[orderEtaKey]:e.target.value}))}
                              placeholder="Order ETA"
                            />
                            <button className="btn btn-primary btn-sm" onClick={()=>setETA(o.id, orderEtaVal)}>Set All</button>
                            <span style={{color:'#9ca3af',fontSize:14}}>{isExpanded ? '▲' : '▼'}</span>
                          </div>
                        </div>
                        {/* Expanded per-item rows */}
                        {isExpanded && etaOrderDetail && etaOrderDetail.id === o.id && (
                          <div style={{padding:'10px 14px',background:'white'}}>
                            {etaOrderDetail.requested_delivery_date && (
                              <div style={{fontSize:14,color:'#ef4444',fontWeight:700,marginBottom:8}}>⚡ Customer requested by: {etaOrderDetail.requested_delivery_date}</div>
                            )}
                            {etaOrderDetail.previous_eta && (
                              <div style={{fontSize:14,background:'#fffbeb',border:'1px solid #fcd34d',borderRadius:4,padding:'3px 8px',marginBottom:8}}>
                                <span style={{color:'#92400e',fontWeight:700}}>Previous ETA: {etaOrderDetail.previous_eta} (rescheduled)</span>
                              </div>
                            )}
                            {etaOrderItems.length === 0 ? (
                              <div style={{fontSize:15,color:'#9ca3af'}}>No items</div>
                            ) : (
                              <div className="space-y-2">
                                {etaOrderItems.map(item => {
                                  const itemKey = `eta_item_${item.id}`;
                                  const itemEtaVal = verifyData[itemKey] !== undefined ? verifyData[itemKey] : (item.eta_date || '');
                                  const statusColors = {T:'#6b7280',C:'#1d4ed8',R:'#92400e',P:'#9a3412',F:'#166534'};
                                  return (
                                    <div key={item.id} style={{display:'flex',alignItems:'center',gap:10,padding:'6px 8px',background:'#f8fafc',borderRadius:6,border:'1px solid #e2e8f0'}}>
                                      <span style={{background: statusColors[item.status]||'#6b7280',color:'white',fontSize:10,fontWeight:700,padding:'1px 5px',borderRadius:3,whiteSpace:'nowrap'}}>{item.status}</span>
                                      <span style={{fontFamily:'monospace',fontWeight:900,color:'#07324C',fontSize:14,minWidth:80}}>{item.sku_code}</span>
                                      <span style={{fontSize:15,color:'#4b5563',flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{item.product_name}</span>
                                      <span style={{fontSize:15,color:'#1d4ed8',fontWeight:700,whiteSpace:'nowrap'}}>&times;{item.quantity}</span>
                                      {item.special_instructions && <span style={{fontSize:15,color:'#d97706'}}>⚠</span>}
                                      <input type="date" className="hp-input" style={{width:145,fontSize:14}}
                                        value={itemEtaVal}
                                        onChange={e=>setVerifyData(p=>({...p,[itemKey]:e.target.value}))}
                                      />
                                      <button className="btn btn-sm" style={{background:'#07324C',color:'white',padding:'3px 8px',fontSize:14}} onClick={()=>setItemETA(item.id, itemEtaVal)}>Set</button>
                                    </div>
                                  );
                                })}
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          )}

          {/* HISTORY */}
          {tab === 'history' && (
            <div className="hp-card">
              <div className="flex flex-wrap gap-3 mb-4">
                <input className="hp-input" style={{maxWidth:250}} placeholder="Search order # or client…" value={historySearch} onChange={e=>setHistorySearch(e.target.value)} />
                <select className="hp-input" style={{maxWidth:160}} value={historyStatus} onChange={e=>setHistoryStatus(e.target.value)}>
                  <option value="">All Statuses</option>
                  {['T','C','R','P','F','dispatched','delivered','collected'].map(s => <option key={s} value={s}>{STATUS_LABELS[s]}</option>)}
                </select>
              </div>
              <div className="table-scroll">
                <table className="hp-table">
                  <thead>
                    <tr><th>Order #</th><th>Client</th><th>Status</th><th>Progress</th><th>Last Status Change</th><th>Items</th><th>Total Qty</th><th>ETA</th><th>Created</th></tr>
                  </thead>
                  <tbody>
                    {historyFiltered.slice(0,100).map(o => (
                      <tr key={o.id}>
                        <td className="font-bold text-[#07324C]">{o.order_number}</td>
                        <td>{o.client_name}</td>
                        <td><StatusBadge status={o.status} /></td>
                        <td>
                          {o.progress ? (
                            <span style={{fontSize:14,fontWeight:700,color:'#374151'}}>{o.progress}</span>
                          ) : '—'}
                        </td>
                        <td className="text-xs text-gray-500">{o.updated_at ? new Date(o.updated_at).toLocaleDateString('en-AU',{day:'numeric',month:'short',year:'numeric'}) : '—'}</td>
                        <td>{o.item_count}</td>
                        <td>{o.total_qty}</td>
                        <td>{o.eta_date||'—'}</td>
                        <td className="text-xs text-gray-500">{o.created_at?.split('T')[0]}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                {historyFiltered.length === 0 && <Empty />}
              </div>
            </div>
          )}
        </>
      )}

      {/* Client Card Modal */}
      {selectedClient && (
        <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.5)',zIndex:1000,display:'flex',alignItems:'center',justifyContent:'center',padding:20}} onClick={()=>setSelectedClient(null)}>
          <div style={{background:'white',borderRadius:16,width:'100%',maxWidth:720,maxHeight:'90vh',overflow:'auto',boxShadow:'0 20px 60px rgba(0,0,0,0.3)'}} onClick={e=>e.stopPropagation()}>
            <div style={{background:'#07324C',color:'white',padding:'16px 24px',borderRadius:'16px 16px 0 0',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
              <div>
                <h2 style={{fontWeight:900,fontSize:20,margin:0}}>{selectedClient.company_name}</h2>
                <div style={{fontSize:15,opacity:0.7}}>Client ID: {selectedClient.id} · Since {selectedClient.created_at?.split('T')[0]}</div>
              </div>
              <button onClick={()=>setSelectedClient(null)} style={{background:'none',border:'none',color:'white',fontSize:24,cursor:'pointer'}}>×</button>
            </div>
            <div style={{padding:24}}>
              {/* Editable Company Details */}
              <h3 style={{fontWeight:800,color:'#07324C',fontSize:15,marginBottom:12,textTransform:'uppercase',letterSpacing:1}}>Company Details</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                <div>
                  <label className="block text-xs font-bold text-gray-500 mb-1">Company Name</label>
                  <input className="hp-input" value={editingClient?.company_name||''} onChange={e=>setEditingClient(p=>({...p,company_name:e.target.value}))} />
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-500 mb-1">Primary Contact</label>
                  <input className="hp-input" value={editingClient?.contact_name||''} onChange={e=>setEditingClient(p=>({...p,contact_name:e.target.value}))} />
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-500 mb-1">Primary Email</label>
                  <input type="email" className="hp-input" value={editingClient?.email||''} onChange={e=>setEditingClient(p=>({...p,email:e.target.value}))} />
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-500 mb-1">Phone</label>
                  <input className="hp-input" value={editingClient?.phone||''} onChange={e=>setEditingClient(p=>({...p,phone:e.target.value}))} />
                </div>
                <div className="md:col-span-2">
                  <label className="block text-xs font-bold text-gray-500 mb-1">Address</label>
                  <input className="hp-input" value={editingClient?.address||''} onChange={e=>setEditingClient(p=>({...p,address:e.target.value}))} />
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-500 mb-1">Payment Terms</label>
                  <select className="hp-input" value={editingClient?.payment_terms||''} onChange={e=>setEditingClient(p=>({...p,payment_terms:e.target.value}))}>
                    <option value="7 days">7 Days</option>
                    <option value="14 days">14 Days</option>
                    <option value="30 days">30 Days</option>
                    <option value="60 days">60 Days</option>
                    <option value="COD">COD</option>
                    <option value="Prepaid">Prepaid</option>
                  </select>
                </div>
                <div className="flex items-end">
                  <button className="btn btn-primary btn-sm" onClick={updateClient}>Save Company Details</button>
                </div>
              </div>

              {/* Contacts */}
              <h3 style={{fontWeight:800,color:'#07324C',fontSize:15,marginBottom:12,textTransform:'uppercase',letterSpacing:1,borderTop:'2px solid #e2e8f0',paddingTop:16}}>
                Contacts ({clientContacts.length}/3)
              </h3>
              <p className="text-xs text-gray-400 mb-3">Add up to 3 contacts with specific roles and email routing purposes. Mark contacts who should receive sensitive business communications.</p>

              {clientContacts.map((ct, idx) => (
                <div key={ct.id} style={{background:'#f8fafc',border:'1px solid #e2e8f0',borderRadius:10,padding:'12px 16px',marginBottom:10}}>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-2 mb-2">
                    <div>
                      <label className="block text-xs text-gray-400 mb-0.5">Name</label>
                      <input className="hp-input" style={{fontSize:14}} value={ct.contact_name||''} onChange={e=>{const v=e.target.value; setClientContacts(p=>p.map((x,i)=>i===idx?{...x,contact_name:v}:x));}} />
                    </div>
                    <div>
                      <label className="block text-xs text-gray-400 mb-0.5">Email</label>
                      <input type="email" className="hp-input" style={{fontSize:14}} value={ct.email||''} onChange={e=>{const v=e.target.value; setClientContacts(p=>p.map((x,i)=>i===idx?{...x,email:v}:x));}} />
                    </div>
                    <div>
                      <label className="block text-xs text-gray-400 mb-0.5">Phone</label>
                      <input className="hp-input" style={{fontSize:14}} value={ct.phone||''} onChange={e=>{const v=e.target.value; setClientContacts(p=>p.map((x,i)=>i===idx?{...x,phone:v}:x));}} />
                    </div>
                    <div>
                      <label className="block text-xs text-gray-400 mb-0.5">Role / Title</label>
                      <input className="hp-input" style={{fontSize:14}} value={ct.role_title||''} onChange={e=>{const v=e.target.value; setClientContacts(p=>p.map((x,i)=>i===idx?{...x,role_title:v}:x));}} placeholder="e.g. Purchasing Manager" />
                    </div>
                    <div>
                      <label className="block text-xs text-gray-400 mb-0.5">Email Purpose</label>
                      <select className="hp-input" style={{fontSize:14}} value={ct.email_purpose||'general'} onChange={e=>{const v=e.target.value; setClientContacts(p=>p.map((x,i)=>i===idx?{...x,email_purpose:v}:x));}}>
                        <option value="general">General</option>
                        <option value="order_confirmation">Order Confirmation</option>
                        <option value="delivery_confirmation">Delivery Confirmation</option>
                        <option value="invoicing">Invoicing</option>
                        <option value="all">All Communications</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-xs text-gray-400 mb-0.5">Sensitive Info</label>
                      <label className="flex items-center gap-2 mt-1 cursor-pointer">
                        <input type="checkbox" checked={!!ct.receives_sensitive} onChange={e=>{const v=e.target.checked?1:0; setClientContacts(p=>p.map((x,i)=>i===idx?{...x,receives_sensitive:v}:x));}} />
                        <span className="text-xs text-gray-600">Pricing / Business comms</span>
                      </label>
                    </div>
                  </div>
                  <div className="flex gap-2 mt-2">
                    <button className="btn btn-primary btn-sm" style={{fontSize:14}} onClick={()=>updateContact(ct.id, ct)}>Save Contact</button>
                    <button className="text-xs text-red-500 hover:underline" onClick={()=>deleteContact(ct.id)}>Remove</button>
                  </div>
                </div>
              ))}

              {clientContacts.length < 3 && (
                <div style={{background:'#eff6ff',border:'1px dashed #93c5fd',borderRadius:10,padding:'12px 16px',marginTop:8}}>
                  <div className="text-xs font-bold text-blue-700 mb-2">Add New Contact</div>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-2 mb-2">
                    <input className="hp-input" style={{fontSize:14}} placeholder="Contact name *" value={contactForm.contact_name} onChange={e=>setContactForm(p=>({...p,contact_name:e.target.value}))} />
                    <input type="email" className="hp-input" style={{fontSize:14}} placeholder="Email" value={contactForm.email} onChange={e=>setContactForm(p=>({...p,email:e.target.value}))} />
                    <input className="hp-input" style={{fontSize:14}} placeholder="Phone" value={contactForm.phone} onChange={e=>setContactForm(p=>({...p,phone:e.target.value}))} />
                    <input className="hp-input" style={{fontSize:14}} placeholder="Role / Title" value={contactForm.role_title} onChange={e=>setContactForm(p=>({...p,role_title:e.target.value}))} />
                    <select className="hp-input" style={{fontSize:14}} value={contactForm.email_purpose} onChange={e=>setContactForm(p=>({...p,email_purpose:e.target.value}))}>
                      <option value="general">General</option>
                      <option value="order_confirmation">Order Confirmation</option>
                      <option value="delivery_confirmation">Delivery Confirmation</option>
                      <option value="invoicing">Invoicing</option>
                      <option value="all">All Communications</option>
                    </select>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" checked={!!contactForm.receives_sensitive} onChange={e=>setContactForm(p=>({...p,receives_sensitive:e.target.checked?1:0}))} />
                      <span className="text-xs text-gray-600">Receives sensitive info</span>
                    </label>
                  </div>
                  <button className="btn btn-primary btn-sm" onClick={addContact}>+ Add Contact</button>
                </div>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Order verify panel (inline expansion)
const OrderVerifyPanel = ({ order, token, onVerify }) => {
  const [items, setItems] = useState([]);
  const [checked1, setChecked1] = useState(false);
  const [checked2, setChecked2] = useState(false);

  useEffect(() => {
    api(`/orders/${order.id}/items`, {}, token).then(setItems).catch(()=>{});
  }, [order.id]);

  return (
    <div className="p-6 bg-blue-50 border-t border-blue-100">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 className="font-bold text-[#07324C] mb-3">Order Details — {order.order_number}</h3>
          <div className="space-y-2 text-sm">
            <div><span className="text-gray-500">Client:</span> <span className="font-medium">{order.client_name}</span></div>
            <div><span className="text-gray-500">Delivery Type:</span> <span className="font-medium capitalize">{order.delivery_type||'—'}</span></div>
            {order.special_instructions && (
              <div className="p-3 bg-amber-50 border border-amber-200 rounded-lg">
                <span className="font-bold text-amber-800">Special Instructions:</span>
                <p className="text-amber-700 mt-1">{order.special_instructions}</p>
              </div>
            )}
          </div>
          <div className="mt-4">
            <h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Line Items</h4>
            <table className="hp-table text-xs">
              <thead><tr><th>SKU</th><th>Product</th><th>Qty</th><th>Zone</th></tr></thead>
              <tbody>
                {items.map(i => (
                  <tr key={i.id}>
                    <td className="font-mono font-bold" style={{color:'#07324C'}}>{i.sku_code||'—'}</td>
                    <td>{i.product_name||'—'}</td>
                    <td>{i.quantity}</td>
                    <td>{i.zone_name||'—'}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 className="font-bold text-[#07324C] mb-3">Verification Checklist</h3>
          <div className="space-y-3 mb-6">
            <label className="flex items-start gap-3 cursor-pointer">
              <input type="checkbox" className="mt-0.5 w-4 h-4" checked={checked1} onChange={e=>setChecked1(e.target.checked)} />
              <span className="text-sm">All order fields verified — quantities, SKUs, client details match the original order</span>
            </label>
            <label className="flex items-start gap-3 cursor-pointer">
              <input type="checkbox" className="mt-0.5 w-4 h-4" checked={checked2} onChange={e=>setChecked2(e.target.checked)} />
              <span className="text-sm">Special instructions reviewed and captured in the system</span>
            </label>
          </div>
          <button className="btn btn-success btn-lg w-full justify-center" disabled={!checked1||!checked2} onClick={onVerify}>
            <Icon name="CheckCircle" size={18} /> Confirm & Send Acknowledgement
          </button>
        </div>
      </div>
    </div>
  );
};


// ═══════════════════════════════════════════════════════════════
// PLANNING BOARD — Viking & Handmade weekly grid
// ═══════════════════════════════════════════════════════════════

// ---- Stock Run Modal ----
const StockRunModal = ({ token, zones, onClose, onCreated }) => {
  const [sku, setSku] = useState('');
  const [skuList, setSkuList] = useState([]);
  const [skuSearch, setSkuSearch] = useState('');
  const [selectedSku, setSelectedSku] = useState(null);
  const [quantity, setQuantity] = useState('');
  const [zoneId, setZoneId] = useState('');
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    api('/skus', {}, token).then(setSkuList).catch(()=>{});
  }, []);

  const submit = async () => {
    if (!sku || !quantity) { toast('Select SKU and quantity','warning'); return; }
    setLoading(true);
    try {
      const orderNum = 'STOCK-' + Date.now().toString().slice(-6);
      const skuObj = skuList.find(s => s.id === parseInt(sku));
      const order = await api('/orders', {
        method: 'POST',
        body: JSON.stringify({
          order_number: orderNum,
          client_id: null,
          is_stock_run: 1,
          status: 'C',
          is_verified: 1,
          notes: `Stock run: ${skuObj?.name || sku}`
        })
      }, token);
      // Add order item
      await api(`/orders/${order.id}/items`, {
        method: 'POST',
        body: JSON.stringify({
          sku_id: parseInt(sku),
          quantity: parseInt(quantity),
          zone_id: parseInt(zoneId) || skuObj?.zone_id
        })
      }, token);
      toast('Stock run created', 'success');
      onCreated();
      onClose();
    } catch(e) { toast(e.message, 'error'); }
    setLoading(false);
  };

  // Search filter — all zones, match on code or name
  const filteredSkus = skuSearch.length > 0
    ? skuList.filter(s => {
        const q = skuSearch.toLowerCase();
        return s.code.toLowerCase().includes(q) || s.name.toLowerCase().includes(q);
      })
    : skuList;

  return (
    <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.5)',zIndex:1000,display:'flex',alignItems:'center',justifyContent:'center'}}>
      <div style={{background:'white',borderRadius:12,padding:24,width:420,boxShadow:'0 20px 60px rgba(0,0,0,0.3)'}}>
        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:16}}>
          <h2 style={{fontWeight:900,color:'#07324C',fontSize:20,margin:0}}>Create Stock Run</h2>
          <button onClick={onClose} style={{background:'none',border:'none',cursor:'pointer',fontSize:20,color:'#9ca3af'}}>&times;</button>
        </div>
        <div style={{marginBottom:12,position:'relative'}}>
          <label style={{fontSize:14,fontWeight:700,color:'#6b7280',display:'block',marginBottom:4}}>SKU</label>
          <input
            type="text"
            value={skuSearch}
            onChange={e => { setSkuSearch(e.target.value); setSelectedSku(null); setSku(''); }}
            className="hp-input"
            placeholder="Search SKU code or name..."
            autoComplete="off"
          />
          {skuSearch && !selectedSku && filteredSkus.length > 0 && (
            <div style={{position:'absolute',top:'100%',left:0,right:0,background:'white',border:'1px solid #e5e7eb',borderRadius:8,maxHeight:220,overflowY:'auto',zIndex:10,boxShadow:'0 4px 12px rgba(0,0,0,0.1)',marginTop:2}}>
              {filteredSkus.slice(0,30).map(s => {
                const zoneName = zones.find(z=>z.id===s.zone_id)?.name || '';
                return (
                  <div key={s.id} onClick={() => {
                    setSelectedSku(s);
                    setSku(String(s.id));
                    setSkuSearch(`${s.code} — ${s.name}`);
                    setZoneId(String(s.zone_id));
                  }}
                  onMouseEnter={e => e.currentTarget.style.background='#f0f4ff'}
                  onMouseLeave={e => e.currentTarget.style.background='white'}
                  style={{padding:'8px 12px',cursor:'pointer',fontSize:14,borderBottom:'1px solid #f3f4f6',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <span><strong>{s.code}</strong> — {s.name}</span>
                    <span style={{fontSize:14,color:'#9ca3af',marginLeft:8,whiteSpace:'nowrap'}}>{zoneName}</span>
                  </div>
                );
              })}
              {filteredSkus.length > 30 && <div style={{padding:'6px 12px',fontSize:15,color:'#9ca3af',textAlign:'center'}}>{filteredSkus.length - 30} more results...</div>}
            </div>
          )}
          {skuSearch && !selectedSku && filteredSkus.length === 0 && (
            <div style={{position:'absolute',top:'100%',left:0,right:0,background:'white',border:'1px solid #e5e7eb',borderRadius:8,padding:'12px',textAlign:'center',fontSize:14,color:'#9ca3af',boxShadow:'0 4px 12px rgba(0,0,0,0.1)',marginTop:2}}>No matching SKUs</div>
          )}
          {selectedSku && <div style={{fontSize:15,color:'#6b7280',marginTop:4}}>Zone: {zones.find(z=>z.id===selectedSku.zone_id)?.name || 'Unknown'} &middot; Labour: ${selectedSku.labour_cost?.toFixed(2) || '0.00'} &middot; Sell: ${selectedSku.sell_price?.toFixed(2) || '0.00'}</div>}
        </div>
        <div style={{marginBottom:12}}>
          <label style={{fontSize:14,fontWeight:700,color:'#6b7280',display:'block',marginBottom:4}}>Quantity</label>
          <input type="number" min="1" value={quantity} onChange={e=>setQuantity(e.target.value)} className="hp-input" placeholder="e.g. 500" />
        </div>
        <div style={{display:'flex',gap:8,marginTop:20}}>
          <button className="btn btn-primary flex-1 justify-center" onClick={submit} disabled={loading}>
            {loading ? <Spinner /> : 'Create Stock Run'}
          </button>
          <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
        </div>
      </div>
    </div>
  );
};

// ---- Split Modal ----
const SplitModal = ({ entry, token, onClose, onSplit }) => {
  const [splitQty, setSplitQty] = useState('');
  const [loading, setLoading] = useState(false);
  const maxQty = (entry.planned_quantity || entry.item_quantity || 0) - 1;

  const submit = async () => {
    const qty = parseInt(splitQty);
    if (!qty || qty <= 0 || qty >= (entry.planned_quantity || entry.item_quantity)) {
      toast('Enter a valid split quantity (less than total)', 'warning'); return;
    }
    setLoading(true);
    try {
      if (entry.order_item_id) {
        await api(`/order-items/${entry.order_item_id}/split`, {
          method: 'POST',
          body: JSON.stringify({ new_quantity: qty })
        }, token);
        toast('Work order split', 'success');
        onSplit();
        onClose();
      }
    } catch(e) { toast(e.message, 'error'); }
    setLoading(false);
  };

  return (
    <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.5)',zIndex:1000,display:'flex',alignItems:'center',justifyContent:'center'}}>
      <div style={{background:'white',borderRadius:12,padding:24,width:360,boxShadow:'0 20px 60px rgba(0,0,0,0.3)'}}>
        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:16}}>
          <h2 style={{fontWeight:900,color:'#07324C',fontSize:18,margin:0}}>Split Work Order</h2>
          <button onClick={onClose} style={{background:'none',border:'none',cursor:'pointer',fontSize:20,color:'#9ca3af'}}>×</button>
        </div>
        <p style={{fontSize:14,color:'#6b7280',marginBottom:12}}>
          Split <strong>{entry.order_number}</strong> ({entry.planned_quantity || entry.item_quantity} units)<br/>
          Enter the quantity for the NEW split item. Original will be reduced.
        </p>
        <input type="number" min="1" max={maxQty} value={splitQty} onChange={e=>setSplitQty(e.target.value)} className="hp-input" placeholder={`1 – ${maxQty}`} />
        <div style={{display:'flex',gap:8,marginTop:16}}>
          <button className="btn btn-primary flex-1 justify-center" onClick={submit} disabled={loading}>
            {loading ? <Spinner /> : 'Split'}
          </button>
          <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
        </div>
      </div>
    </div>
  );
};

// ---- Over-Capacity Modal (triggered on drop exceeding station capacity) ----
const OverCapacityModal = ({ modal, token, onClose, onComplete }) => {
  const [loading, setLoading] = useState(false);
  if (!modal) return null;
  const { dragData, dateStr, stationId, zoneId, capacityInfo } = modal;
  const qty = dragData.quantity || 0;
  const remaining = capacityInfo.remaining_capacity;
  const maxCap = capacityInfo.max_capacity;
  const currentTotal = capacityInfo.current_total;
  const fitsQty = Math.min(remaining, qty);
  const overflowQty = qty - fitsQty;

  const doForce = async () => {
    setLoading(true);
    try {
      await api('/schedule', {
        method: 'POST',
        body: JSON.stringify({
          order_id: dragData.orderId,
          order_item_id: dragData.orderItemId,
          zone_id: zoneId,
          station_id: stationId,
          scheduled_date: dateStr,
          planned_quantity: qty
        })
      }, token);
      toast('Scheduled (over capacity)', 'warning');
      onComplete();
      onClose();
    } catch(e) { toast(e.message, 'error'); }
    setLoading(false);
  };

  const doSplit = async () => {
    if (fitsQty <= 0) {
      toast('No remaining capacity — use Force or Cancel', 'warning');
      return;
    }
    setLoading(true);
    try {
      // Step 1: Split the order item — overflow qty becomes new linked item
      const splitRes = await api(`/order-items/${dragData.orderItemId}/split`, {
        method: 'POST',
        body: JSON.stringify({ new_quantity: overflowQty })
      }, token);
      // Step 2: Schedule the original (now reduced to fitsQty) on this station/date
      await api('/schedule', {
        method: 'POST',
        body: JSON.stringify({
          order_id: dragData.orderId,
          order_item_id: dragData.orderItemId,
          zone_id: zoneId,
          station_id: stationId,
          scheduled_date: dateStr,
          planned_quantity: fitsQty
        })
      }, token);
      toast(`Split: ${fitsQty} scheduled, ${overflowQty} back in queue`, 'success');
      onComplete();
      onClose();
    } catch(e) { toast(e.message, 'error'); }
    setLoading(false);
  };

  return (
    <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.5)',zIndex:1000,display:'flex',alignItems:'center',justifyContent:'center'}}>
      <div style={{background:'white',borderRadius:12,padding:28,width:440,boxShadow:'0 20px 60px rgba(0,0,0,0.3)'}}>
        <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:16}}>
          <div style={{width:40,height:40,borderRadius:10,background:'#FEE2E2',display:'flex',alignItems:'center',justifyContent:'center'}}>
            <span style={{fontSize:22}}>&#9888;</span>
          </div>
          <div>
            <h2 style={{fontWeight:900,color:'#ED1C24',fontSize:18,margin:0}}>Over Capacity</h2>
            <p style={{fontSize:15,color:'#6b7280',margin:0}}>This drop exceeds the station limit</p>
          </div>
          <button onClick={onClose} style={{marginLeft:'auto',background:'none',border:'none',cursor:'pointer',fontSize:22,color:'#9ca3af'}}>&#215;</button>
        </div>

        <div style={{background:'#FEF2F2',borderRadius:8,padding:14,marginBottom:16,border:'1px solid #FECACA'}}>
          <div style={{display:'flex',justifyContent:'space-between',marginBottom:6}}>
            <span style={{fontSize:14,fontWeight:700,color:'#07324C'}}>WO: {dragData.orderNumber || '—'}</span>
            <span style={{fontSize:14,fontWeight:700,fontFamily:'monospace',color:'#07324C'}}>{dragData.skuCode || ''}</span>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6,fontSize:15,color:'#4b5563'}}>
            <div>Drop Quantity: <strong>{qty}</strong></div>
            <div>Station Max: <strong>{maxCap.toLocaleString()}</strong></div>
            <div>Already Scheduled: <strong>{currentTotal.toLocaleString()}</strong></div>
            <div>Remaining Capacity: <strong style={{color: remaining > 0 ? '#059669' : '#DC2626'}}>{remaining.toLocaleString()}</strong></div>
          </div>
          <div style={{marginTop:8,padding:'6px 10px',background:'#DC2626',borderRadius:6,color:'white',fontSize:15,fontWeight:700,textAlign:'center'}}>
            Exceeds by {(qty - remaining).toLocaleString()} units
          </div>
        </div>

        <div style={{display:'flex',flexDirection:'column',gap:10}}>
          {fitsQty > 0 && (
            <button className="btn btn-primary" onClick={doSplit} disabled={loading} style={{padding:'12px 16px',fontSize:15,fontWeight:800,display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
              {loading ? <Spinner /> : <><span>&#9986;</span> Split &amp; Schedule</>}
              <span style={{fontSize:14,fontWeight:500,opacity:0.9,marginLeft:4}}>({fitsQty} now, {overflowQty} to queue)</span>
            </button>
          )}
          <button className="btn" onClick={doForce} disabled={loading} style={{padding:'12px 16px',fontSize:15,fontWeight:700,background:'#FEF3C7',color:'#92400E',border:'1px solid #F59E0B',borderRadius:8,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
            {loading ? <Spinner /> : <><span>&#9889;</span> Force Schedule Anyway</>}
            <span style={{fontSize:14,fontWeight:500,opacity:0.8}}>({qty} units, over limit)</span>
          </button>
          <button className="btn btn-secondary" onClick={onClose} style={{padding:'10px 16px',fontSize:14}}>Cancel</button>
        </div>
      </div>
    </div>
  );
};

// ---- Work Order Card (in grid) ----
const WOCard = ({ entry, onRemove, onSplit, onEditQty, onDockingComplete, onReschedule }) => {
  const [showMenu, setShowMenu] = useState(false);
  const [editingQty, setEditingQty] = useState(false);
  const [qtyVal, setQtyVal] = useState(entry.planned_quantity || 0);

  const isStock = entry.is_stock_run;
  const hasPriority = !!entry.requested_delivery_date;
  const qty = entry.planned_quantity || entry.item_quantity || 0;
  const isDocking = entry.item_status === 'C';

  return (
    <div
      draggable
      onDragStart={e => {
        e.dataTransfer.setData('text/plain', JSON.stringify({
          type: 'reschedule',
          entryId: entry.id,
          orderId: entry.order_id,
          orderNumber: entry.order_number,
          currentDate: entry.scheduled_date,
          currentStation: entry.station_id,
          isStockRun: !!entry.is_stock_run
        }));
      }}
      style={{
        background: isDocking ? '#eff6ff' : '#dcfce7',
        border: isDocking ? '1.5px solid #2563eb' : '1.5px solid #16a34a',
        borderRadius: 5,
        padding: '4px 6px',
        marginBottom: 3,
        fontSize: 12,
        position: 'relative',
        cursor: 'grab'
      }}
      onContextMenu={e => { e.preventDefault(); setShowMenu(true); }}
    >
      {/* Context menu */}
      {showMenu && (
        <div style={{
          position: 'absolute', top: 0, right: 0, background: 'white',
          border: '1px solid #e2e8f0', borderRadius: 6, boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
          zIndex: 50, minWidth: 130, padding: '4px 0', fontSize: 13
        }} onMouseLeave={() => setShowMenu(false)}>
          <button style={{display:'block',width:'100%',padding:'5px 12px',textAlign:'left',background:'none',border:'none',cursor:'pointer',color:'#374151'}} onClick={() => { setEditingQty(true); setShowMenu(false); }}>Edit Quantity</button>
          <button style={{display:'block',width:'100%',padding:'5px 12px',textAlign:'left',background:'none',border:'none',cursor:'pointer',color:'#374151'}} onClick={() => { onSplit(entry); setShowMenu(false); }}>Split Work Order</button>
          {isDocking && onDockingComplete && (
            <>
              <div style={{borderTop:'1px solid #dbeafe',margin:'4px 0'}}></div>
              <button style={{display:'block',width:'100%',padding:'5px 12px',textAlign:'left',background:'none',border:'none',cursor:'pointer',color:'#2563eb',fontWeight:600}} onClick={() => { onDockingComplete(entry); setShowMenu(false); }}>✓ Docking Complete</button>
            </>
          )}
          <div style={{borderTop:'1px solid #f3f4f6',margin:'4px 0'}}></div>
          <button style={{display:'block',width:'100%',padding:'5px 12px',textAlign:'left',background:'none',border:'none',cursor:'pointer',color:'#ef4444'}} onClick={() => { onRemove(entry.id); setShowMenu(false); }}>Remove</button>
        </div>
      )}

      <div style={{display:'flex',alignItems:'flex-start',justifyContent:'space-between',gap:2}}>
        <div style={{flex:1,minWidth:0}}>
          <div style={{display:'flex',alignItems:'center',gap:3,flexWrap:'wrap'}}>
            {isDocking && <span style={{background:'#2563eb',color:'white',fontSize:10,fontWeight:700,padding:'0 4px',borderRadius:3}}>🔶 DOCKING</span>}
            {isStock && <span style={{background:'#f59e0b',color:'white',fontSize:10,fontWeight:700,padding:'0 4px',borderRadius:3}}>STOCK</span>}
            {hasPriority && <span style={{background:'#ef4444',color:'white',fontSize:10,fontWeight:700,padding:'0 4px',borderRadius:3}}>⚡</span>}
            <span style={{fontWeight:700,color: isDocking ? '#1e3a8a' : '#166534',fontSize:14,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{entry.order_number || '—'}</span>
          </div>
          {/* SKU — bold and prominent per Tim's directive */}
          <div style={{fontFamily:'monospace',fontWeight:900,color:'#07324C',fontSize:14,lineHeight:1.2,marginTop:2}}>
            {entry.sku_code || entry.product_name || '—'}
          </div>
          {entry.sku_code && entry.product_name && <div style={{color:'#6b7280',fontSize:15,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{entry.product_name}</div>}
          {entry.requested_delivery_date && (
            <div style={{color:'#ef4444',fontSize:15,fontWeight:600}}>Due: {entry.requested_delivery_date}</div>
          )}
        </div>
        <div style={{display:'flex',flexDirection:'column',alignItems:'flex-end',gap:2}}>
          {editingQty ? (
            <form onSubmit={e => { e.preventDefault(); onEditQty(entry.id, parseInt(qtyVal)); setEditingQty(false); }} style={{display:'flex',gap:2}}>
              <input type="number" min="1" value={qtyVal} onChange={e=>setQtyVal(e.target.value)}
                style={{width:50,fontSize:15,border:'1px solid #d1d5db',borderRadius:3,padding:'1px 3px'}} autoFocus />
              <button type="submit" style={{background:'#16a34a',color:'white',border:'none',borderRadius:3,fontSize:15,padding:'1px 4px',cursor:'pointer'}}>✓</button>
            </form>
          ) : (
            <span style={{background:'#16a34a',color:'white',fontSize:15,fontWeight:700,padding:'2px 5px',borderRadius:3,cursor:'pointer',whiteSpace:'nowrap'}} onClick={() => setEditingQty(true)}>
              {qty.toLocaleString()}
            </span>
          )}
          {entry.priority > 0 && (
            <span style={{background:'#6b7280',color:'white',fontSize:10,padding:'0 3px',borderRadius:2}}>P{entry.priority}</span>
          )}
        </div>
      </div>
    </div>
  );
};

// ---- Intake Queue Card ----
const IntakeCard = ({ item, dragging, onDragStart, onDragEnd, onIssueCutList }) => {
  const isStock = item.is_stock_run;
  const hasPriority = !!item.requested_delivery_date;
  const invOnHand = item.inventory_on_hand || 0;
  const qty = item.quantity || 0;

  return (
    <div
      draggable
      onDragStart={onDragStart}
      onDragEnd={onDragEnd}
      style={{
        background: hasPriority ? '#fff7ed' : 'white',
        border: hasPriority ? '2px solid #f97316' : '1.5px solid #e2e8f0',
        borderRadius: 6,
        padding: '7px 8px',
        cursor: 'grab',
        opacity: dragging ? 0.5 : 1,
        userSelect: 'none',
        marginBottom: 6,
        transition: 'box-shadow 0.1s'
      }}
    >
      <div style={{display:'flex',alignItems:'flex-start',justifyContent:'space-between',gap:4}}>
        <div style={{flex:1,minWidth:0}}>
          <div style={{display:'flex',alignItems:'center',gap:3,flexWrap:'wrap',marginBottom:2}}>
            {isStock && <span style={{background:'#f59e0b',color:'white',fontSize:10,fontWeight:700,padding:'0 3px',borderRadius:2}}>STOCK</span>}
            {hasPriority && <span style={{background:'#ef4444',color:'white',fontSize:10,fontWeight:700,padding:'0 3px',borderRadius:2}}>⚡PRIORITY</span>}
          </div>
          <div style={{fontWeight:700,color:'#07324C',fontSize:15,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{item.order_number}</div>
          {/* SKU — bold and prominent */}
          <div style={{fontFamily:'monospace',fontWeight:900,color:'#07324C',fontSize:15,lineHeight:1.2,marginTop:1}}>
            {item.sku_code || item.product_name || '—'}
          </div>
          {item.sku_code && item.product_name && <div style={{color:'#6b7280',fontSize:14,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{item.product_name}</div>}
          {item.client_name && <div style={{color:'#9ca3af',fontSize:15,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{item.client_name}</div>}
          {item.requested_delivery_date && (
            <div style={{color:'#ef4444',fontSize:15,fontWeight:600,marginTop:1}}>Due: {item.requested_delivery_date}</div>
          )}
          {item.split_from_item_id && (
            <div style={{color:'#7c3aed',fontSize:15,fontWeight:700,marginTop:1,display:'flex',alignItems:'center',gap:3}}>
              <span style={{background:'#ede9fe',color:'#7c3aed',fontSize:10,fontWeight:700,padding:'1px 4px',borderRadius:3}}>SPLIT</span>
              Overflow from #{item.split_from_item_id}
            </div>
          )}
          {item.eta_date && (
            <div style={{color:'#d97706',fontSize:15,fontWeight:600,marginTop:1}}>
              ETA: {new Date(item.eta_date+'T00:00:00').toLocaleDateString('en-AU',{day:'numeric',month:'short'})}
            </div>
          )}
          <div style={{display:'flex',alignItems:'center',gap:4,marginTop:3}}>
            <span style={{
              background: invOnHand > 0 ? '#dbeafe' : '#f3f4f6',
              color: invOnHand > 0 ? '#1d4ed8' : '#9ca3af',
              fontSize:15, fontWeight:700, padding:'2px 6px', borderRadius:4,
              display:'inline-flex', alignItems:'center', gap:3
            }}>
              📦 {invOnHand.toLocaleString()} units on hand
            </span>
          </div>
        </div>
        <div>
          <span style={{background:'#16a34a',color:'white',fontSize:14,fontWeight:700,padding:'3px 6px',borderRadius:4,whiteSpace:'nowrap'}}>
            {qty.toLocaleString()}
          </span>
        </div>
      </div>
      {item.item_status === 'T' && onIssueCutList && (
        <div style={{marginTop:5,paddingTop:5,borderTop:'1px solid #e2e8f0'}}>
          <button
            onClick={e => { e.stopPropagation(); e.preventDefault(); onIssueCutList(item); }}
            onDragStart={e => e.stopPropagation()}
            draggable={false}
            style={{
              width:'100%',background:'#f59e0b',color:'white',border:'none',
              borderRadius:4,padding:'3px 6px',fontSize:15,fontWeight:700,
              cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:3
            }}
          >
            ✂ Issue Cut List
          </button>
        </div>
      )}
    </div>
  );
};

// ---- Drop Zone (machine/day cell) ----
const DropZone = ({ children, onDrop, isClosed, machineId, dateStr }) => {
  const [dragOver, setDragOver] = useState(false);

  if (isClosed) {
    return (
      <td style={{background:'#f3f4f6',borderRight:'1px solid #e2e8f0',borderBottom:'1px solid #e2e8f0',minWidth:110,verticalAlign:'top',padding:'4px'}}>
        <div style={{color:'#9ca3af',fontSize:15,textAlign:'center',marginTop:8}}>CLOSED</div>
      </td>
    );
  }

  return (
    <td
      style={{
        background: dragOver ? '#eff6ff' : 'white',
        border: dragOver ? '2px solid #3b82f6' : '1px solid transparent',
        borderRight: '1px solid #e2e8f0',
        borderBottom: '1px solid #e2e8f0',
        minWidth: 110,
        verticalAlign: 'top',
        padding: '4px',
        transition: 'background 0.1s'
      }}
      onDragOver={e => { e.preventDefault(); setDragOver(true); }}
      onDragLeave={() => setDragOver(false)}
      onDrop={e => {
        e.preventDefault();
        setDragOver(false);
        try {
          const data = JSON.parse(e.dataTransfer.getData('text/plain'));
          onDrop(dateStr, machineId, data);
        } catch {}
      }}
    >
      {children}
    </td>
  );
};

// ---- Reschedule Confirmation Modal ----
const RescheduleModal = ({ modal, onConfirm, onCancel, stations }) => {
  const [etaMode, setEtaMode] = useState('reset');
  if (!modal) return null;
  const { entry, newDate, newStation } = modal;
  const isStockRun = !!entry.is_stock_run;
  const stationName = stations?.find(s => s.id === newStation)?.name || '';
  const currentStationName = stations?.find(s => s.id === entry.station_id)?.name || '';
  const stationChanged = newStation && newStation !== entry.station_id;

  // Calculate days diff for silent option visibility
  const currentDate = new Date(entry.currentDate + 'T00:00:00');
  const targetDate = new Date(newDate + 'T00:00:00');
  const daysDiff = Math.round((targetDate - currentDate) / (1000*60*60*24));
  const movedEarlier = daysDiff < 0;
  const smallFutureShift = daysDiff > 0 && daysDiff <= 3;
  const showSilentOption = movedEarlier || smallFutureShift;

  return (
    <div style={{
      position:'fixed',top:0,left:0,right:0,bottom:0,
      background:'rgba(0,0,0,0.55)',zIndex:1000,
      display:'flex',alignItems:'center',justifyContent:'center'
    }}>
      <div style={{
        background:'white',borderRadius:10,padding:'24px 28px',
        maxWidth:440,width:'90%',boxShadow:'0 20px 60px rgba(0,0,0,0.3)'
      }}>
        <div style={{fontSize:20,fontWeight:800,marginBottom:12,color:'#07324C'}}>📅 Reschedule Work Order</div>
        <div style={{fontSize:15,marginBottom:6}}>
          <span style={{fontWeight:700,color:'#07324C'}}>{entry.order_number}</span>
        </div>
        <div style={{fontSize:14,color:'#6b7280',marginBottom:4}}>
          From: <span style={{fontWeight:600,color:'#374151'}}>{entry.currentDate}</span>
          {' → '}
          <span style={{fontWeight:600,color:'#1d4ed8'}}>{newDate}</span>
        </div>
        {stationChanged && (
          <div style={{fontSize:14,color:'#6b7280',marginBottom:4}}>
            Machine: <span style={{fontWeight:600,color:'#374151'}}>{currentStationName}</span>
            {' → '}
            <span style={{fontWeight:600,color:'#1d4ed8'}}>{stationName}</span>
          </div>
        )}
        {!isStockRun && (
          <div style={{marginTop:14,marginBottom:14,padding:'12px 14px',background:'#fffbeb',border:'1px solid #fcd34d',borderRadius:8}}>
            <div style={{fontSize:15,fontWeight:700,color:'#92400e',marginBottom:10}}>ETA Handling:</div>
            <label style={{display:'flex',alignItems:'flex-start',gap:8,cursor:'pointer',marginBottom:10}}>
              <input type="radio" name="eta_mode" checked={etaMode==='reset'} onChange={()=>setEtaMode('reset')} style={{marginTop:3}} />
              <span style={{fontSize:14,color:'#374151'}}><strong>Reset ETA</strong> — office will be prompted to set new ETA (previous ETA shown for reference)</span>
            </label>
            {showSilentOption && (
              <label style={{display:'flex',alignItems:'flex-start',gap:8,cursor:'pointer',marginBottom:10}}>
                <input type="radio" name="eta_mode" checked={etaMode==='silent'} onChange={()=>setEtaMode('silent')} style={{marginTop:3}} />
                <span style={{fontSize:14,color:'#374151'}}><strong>Reset ETA silently</strong> — date updated internally, office not notified {movedEarlier ? '(moved earlier)' : `(${daysDiff} day${daysDiff>1?'s':''} shift)`}</span>
              </label>
            )}
            <label style={{display:'flex',alignItems:'flex-start',gap:8,cursor:'pointer'}}>
              <input type="radio" name="eta_mode" checked={etaMode==='keep'} onChange={()=>setEtaMode('keep')} style={{marginTop:3}} />
              <span style={{fontSize:14,color:'#374151'}}><strong>Keep current ETA</strong> — no changes, no notification</span>
            </label>
          </div>
        )}
        <div style={{display:'flex',gap:10,marginTop:16}}>
          <button
            style={{flex:1,padding:'8px 16px',background:'#16a34a',color:'white',border:'none',borderRadius:6,fontWeight:700,fontSize:15,cursor:'pointer'}}
            onClick={() => onConfirm(etaMode)}
          >Confirm Reschedule</button>
          <button
            style={{padding:'8px 16px',background:'#e5e7eb',color:'#374151',border:'none',borderRadius:6,fontWeight:700,fontSize:15,cursor:'pointer'}}
            onClick={onCancel}
          >Cancel</button>
        </div>
      </div>
    </div>
  );
};

// ---- Machine Column Header ----
const MachineColHeader = ({ machine, slot }) => {
  const max = machine.max_units_per_day || 0;
  const total = slot?.total || 0;
  const over = slot?.over_capacity;

  return (
    <div style={{textAlign:'center',padding:'2px 0'}}>
      <div style={{fontWeight:700,fontSize:14,color: over ? '#ef4444' : '#07324C',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>
        {machine.name}
      </div>
      {max > 0 && (
        <div style={{fontSize:10,color:'#9ca3af'}}>Max: {max.toLocaleString()}</div>
      )}
      <div style={{
        fontSize: 11, fontWeight: 700,
        color: over ? '#ef4444' : '#16a34a',
        background: over ? '#fef2f2' : '#f0fdf4',
        borderRadius: 3, padding: '1px 4px', marginTop: 2
      }}>
        {total.toLocaleString()} {over ? '⚠ OVER' : ''}
      </div>
    </div>
  );
};

const PlanningBoard = ({ token }) => {
  // Default: start on today (offset from Monday of current week)
  const [dayOffset, setDayOffset] = useState(() => {
    const now = new Date(); const d = now.getDay();
    return d === 0 ? 6 : d - 1; // Mon=0, Tue=1 ... Sun=6
  });
  const [numDays, setNumDays] = useState(5); // default Mon-Fri
  const [activeTab, setActiveTab] = useState('viking'); // 'viking' | 'handmade' | 'dtl' | 'crates'
  const [planData, setPlanData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [draggingItem, setDraggingItem] = useState(null);
  const [showStockModal, setShowStockModal] = useState(false);
  const [splitEntry, setSplitEntry] = useState(null);
  const [zones, setZones] = useState([]);
  const [rescheduleModal, setRescheduleModal] = useState(null);
  const [overCapacityModal, setOverCapacityModal] = useState(null);

  const fmtDate = d => {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  };

  // Calculate start date: Monday of current week + dayOffset
  const getStartDate = () => {
    const now = new Date();
    const day = now.getDay();
    const mon = new Date(now);
    mon.setDate(now.getDate() - (day === 0 ? 6 : day - 1) + dayOffset);
    mon.setHours(0,0,0,0);
    return mon;
  };

  const snapToToday = () => {
    const now = new Date();
    const day = now.getDay();
    const mondayOfThisWeek = new Date(now);
    mondayOfThisWeek.setDate(now.getDate() - (day === 0 ? 6 : day - 1));
    mondayOfThisWeek.setHours(0,0,0,0);
    const diffDays = Math.floor((now.setHours(0,0,0,0) - mondayOfThisWeek.getTime()) / 86400000);
    setDayOffset(diffDays);
  };

  const weekStart = getStartDate();
  const endDate = new Date(weekStart.getTime() + (numDays-1)*86400000);
  const weekLabel = weekStart.toLocaleDateString('en-AU', {day:'numeric', month:'short'}) +
    ' — ' +
    endDate.toLocaleDateString('en-AU', {day:'numeric', month:'short', year:'numeric'});

  const loadRef = useRef(null);
  loadRef.current = async () => {
    setLoading(true);
    try {
      const ws = fmtDate(weekStart);
      const endpoint = `/planning/${activeTab}?week_start=${ws}&num_days=${numDays}`;
      const [data, zs] = await Promise.all([
        api(endpoint, {}, token),
        api('/zones', {}, token)
      ]);
      setPlanData(data);
      setZones(zs);
    } catch(e) { toast(e.message, 'error'); }
    setLoading(false);
  };

  useEffect(() => { loadRef.current(); }, [dayOffset, activeTab, token, numDays]);
  const reload = () => loadRef.current();

  // Drop from intake queue → machine/day, or reschedule existing WO
  const handleDrop = async (dateStr, stationId, dragData) => {
    if (!dragData) return;
    // Reschedule drop: WOCard dragged to new cell
    if (dragData.type === 'reschedule') {
      // If same date & station, ignore
      if (dragData.currentDate === dateStr && dragData.currentStation === stationId) return;
      // Find the full entry from planData
      let foundEntry = null;
      const days = planData?.days || [];
      const machines = planData?.machines || [];
      for (const day of days) {
        for (const machine of machines) {
          const slot = day.machine_slots?.[machine.id] || {};
          const entries = slot.entries || [];
          const e = entries.find(en => en.id === dragData.entryId);
          if (e) { foundEntry = e; break; }
        }
        if (foundEntry) break;
      }
      setRescheduleModal({
        entry: foundEntry ? { ...foundEntry, currentDate: dragData.currentDate, is_stock_run: dragData.isStockRun, order_number: dragData.orderNumber } : { id: dragData.entryId, order_number: dragData.orderNumber, currentDate: dragData.currentDate, station_id: dragData.currentStation, is_stock_run: dragData.isStockRun },
        newDate: dateStr,
        newStation: stationId
      });
      return;
    }
    // New schedule drop from intake queue — check capacity first
    if (!dragData.orderItemId) return;
    try {
      const zoneId = planData?.zone?.id;
      const qty = dragData.quantity || 0;
      // Check capacity before scheduling
      const capCheck = await api(`/capacity-check?station_id=${stationId}&scheduled_date=${dateStr}&additional_quantity=${qty}&zone_id=${zoneId}`, {}, token);
      if (capCheck.would_exceed) {
        // Show over-capacity modal instead of scheduling directly
        setOverCapacityModal({
          dragData,
          dateStr,
          stationId,
          zoneId,
          capacityInfo: capCheck
        });
        return;
      }
      // Within capacity — schedule normally
      await api('/schedule', {
        method: 'POST',
        body: JSON.stringify({
          order_id: dragData.orderId,
          order_item_id: dragData.orderItemId,
          zone_id: zoneId,
          station_id: stationId,
          scheduled_date: dateStr,
          planned_quantity: qty
        })
      }, token);
      toast('Scheduled — in docking', 'success');
      reload();
    } catch(e) { toast(e.message, 'error'); }
  };

  const removeEntry = async (entryId) => {
    try {
      await api(`/schedule/${entryId}`, {method:'DELETE'}, token);
      toast('Removed', 'info');
      reload();
    } catch(e) { toast(e.message, 'error'); }
  };

  const editQty = async (entryId, qty) => {
    try {
      await api(`/schedule/${entryId}`, {
        method: 'PUT',
        body: JSON.stringify({ planned_quantity: qty })
      }, token);
      reload();
    } catch(e) { toast(e.message, 'error'); }
  };

  const toggleCloseDay = async (dateStr, isClosed) => {
    const zoneId = planData?.zone?.id;
    const method = isClosed ? 'DELETE' : 'POST';
    try {
      await api('/planning/close-day', {
        method,
        body: JSON.stringify({ zone_id: zoneId, closed_date: dateStr })
      }, token);
      reload();
    } catch(e) { toast(e.message, 'error'); }
  };

  const machines = planData?.machines || [];
  const days = planData?.days || [];
  const intakeQueue = planData?.intake_queue || [];
  const dockingQueue = planData?.docking_queue || [];
  const [dockingCollapsed, setDockingCollapsed] = useState(false);

  const isViking = activeTab === 'viking';
  const zoneLabel = {viking:'Viking', handmade:'Handmade', dtl:'DTL', crates:'Crates'}[activeTab] || activeTab;
  const colLabel = {viking:'Machine', handmade:'Table', dtl:'Centre', crates:'Station'}[activeTab] || 'Station';

  // Determine max rows needed across all machines/days
  const maxRows = Math.max(1, ...days.flatMap(d =>
    machines.map(m => (d.machine_slots?.[m.id]?.entries?.length || 0))
  ));

  const confirmReschedule = async (etaMode) => {
    if (!rescheduleModal) return;
    const { entry, newDate, newStation } = rescheduleModal;
    try {
      await api(`/schedule/${entry.id}/reschedule`, {
        method: 'PUT',
        body: JSON.stringify({
          scheduled_date: newDate,
          station_id: newStation,
          reset_eta: etaMode === 'reset' || etaMode === 'silent',
          silent: etaMode === 'silent'
        })
      }, token);
      toast('Work order rescheduled', 'success');
      setRescheduleModal(null);
      reload();
    } catch(e) { toast(e.message, 'error'); }
  };

  return (
    <div style={{height:'calc(100vh - 0px)',display:'flex',flexDirection:'column',overflow:'hidden'}}>
      {/* Toolbar */}
      <div style={{background:'#07324C',padding:'10px 16px',display:'flex',alignItems:'center',gap:10,flexShrink:0,flexWrap:'wrap'}}>
        <div style={{color:'white',fontWeight:900,fontSize:18,marginRight:4}}>{zoneLabel} Planning Board</div>

        {/* Zone tabs */}
        <div style={{display:'flex',gap:2,background:'rgba(255,255,255,0.1)',borderRadius:6,padding:2}}>
          {['viking','handmade','dtl','crates'].map(t => (
            <button key={t} onClick={() => setActiveTab(t)} style={{
              padding:'4px 12px', borderRadius:5, border:'none', cursor:'pointer', fontSize:15, fontWeight:700,
              background: activeTab===t ? 'white' : 'transparent',
              color: activeTab===t ? '#07324C' : 'rgba(255,255,255,0.8)'
            }}>{{viking:'Viking',handmade:'Handmade',dtl:'DTL',crates:'Crates'}[t]}</button>
          ))}
        </div>

        <div style={{borderLeft:'1px solid rgba(255,255,255,0.2)',height:20,margin:'0 4px'}}></div>

        {/* Day nav */}
        <button onClick={() => setDayOffset(d=>d-numDays)} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 10px',cursor:'pointer',fontSize:14,fontWeight:700}}>‹ Prev</button>
        <span style={{color:'white',fontSize:15,fontWeight:600,minWidth:180,textAlign:'center'}}>{weekLabel}</span>
        <button onClick={() => setDayOffset(d=>d+numDays)} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 10px',cursor:'pointer',fontSize:14,fontWeight:700}}>Next ›</button>
        <button onClick={snapToToday} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 10px',cursor:'pointer',fontSize:15}}>Today</button>
        <select
          value={numDays}
          onChange={e => setNumDays(parseInt(e.target.value))}
          style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 8px',cursor:'pointer',fontSize:15}}
        >
          <option value="1" style={{color:'#07324C'}}>1 Day</option>
          <option value="2" style={{color:'#07324C'}}>2 Days</option>
          <option value="3" style={{color:'#07324C'}}>3 Days</option>
          <option value="4" style={{color:'#07324C'}}>4 Days</option>
          <option value="5" style={{color:'#07324C'}}>5 Days (Mon-Fri)</option>
          <option value="6" style={{color:'#07324C'}}>6 Days (Mon-Sat)</option>
          <option value="7" style={{color:'#07324C'}}>7 Days</option>
        </select>

        <div style={{borderLeft:'1px solid rgba(255,255,255,0.2)',height:20,margin:'0 4px'}}></div>

        {/* Actions */}
        <button onClick={() => setShowStockModal(true)} style={{background:'#f59e0b',border:'none',color:'white',borderRadius:5,padding:'4px 12px',cursor:'pointer',fontSize:15,fontWeight:700}}>
          + Stock Run
        </button>
        <button onClick={reload} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 10px',cursor:'pointer',fontSize:15}}>
          ↺ Refresh
        </button>
      </div>

      {loading ? (
        <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center'}}>
          <Spinner />
        </div>
      ) : (
        <div style={{flex:1,display:'flex',overflow:'hidden'}}>

          {/* LEFT: Intake Queue */}
          <div style={{
            width: 210,
            flexShrink: 0,
            background: '#f8fafc',
            borderRight: '2px solid #e2e8f0',
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden'
          }}>
            <div style={{background:'#07324C',color:'white',padding:'8px 10px',fontSize:15,fontWeight:700,flexShrink:0}}>
              Intake Queue
            </div>
            <div style={{padding:'6px 8px',background:'#f1f5f9',borderBottom:'1px solid #e2e8f0',flexShrink:0}}>
              <div style={{fontSize:14,color:'#6b7280',lineHeight:1.4}}>
                Work orders ready to be dropped into a scheduled day slot
              </div>
              <div style={{fontSize:14,color:'#374151',fontWeight:600,marginTop:3}}>
                {intakeQueue.length} item{intakeQueue.length!==1?'s':''} in queue
              </div>
            </div>
            <div style={{flex:1,overflowY:'auto',padding:'6px 8px'}}>
              {intakeQueue.length === 0 ? (
                <div style={{textAlign:'center',color:'#9ca3af',fontSize:15,padding:'24px 8px'}}>
                  <div style={{fontSize:24,marginBottom:8}}>✓</div>
                  All work orders scheduled
                </div>
              ) : intakeQueue.map(item => (
                <IntakeCard
                  key={item.id}
                  item={item}
                  dragging={draggingItem === item.id}
                  onDragStart={e => {
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                      orderItemId: item.id,
                      orderId: item.order_id,
                      quantity: item.quantity,
                      label: item.order_number,
                      orderNumber: item.order_number,
                      skuCode: item.sku_code
                    }));
                    setDraggingItem(item.id);
                  }}
                  onDragEnd={() => setDraggingItem(null)}
                  onIssueCutList={async (item) => {
                    try {
                      await api(`/orders/${item.order_id}/verify`, { method: 'PUT' }, token);
                      toast('Cut list issued — order moved to docking', 'success');
                      loadRef.current();
                    } catch(e) { toast(e.message, 'error'); }
                  }}
                />
              ))}
            </div>

            {/* Docking Queue */}
            <div style={{borderTop:'2px solid #bfdbfe',flexShrink:0}}>
              <div
                onClick={() => setDockingCollapsed(c => !c)}
                style={{
                  background:'#1e40af',color:'white',padding:'7px 10px',fontSize:15,
                  fontWeight:700,cursor:'pointer',display:'flex',alignItems:'center',
                  justifyContent:'space-between',userSelect:'none'
                }}
              >
                <span>🚢 Jobs in Docking ({dockingQueue.length})</span>
                <span style={{fontSize:14}}>{dockingCollapsed ? '▼' : '▲'}</span>
              </div>
              {!dockingCollapsed && (
                <div style={{maxHeight:260,overflowY:'auto',padding:'6px 8px',background:'#eff6ff'}}>
                  {dockingQueue.length === 0 ? (
                    <div style={{textAlign:'center',color:'#93c5fd',fontSize:14,padding:'16px 8px'}}>
                      No jobs currently in docking
                    </div>
                  ) : dockingQueue.map(item => (
                    <div key={item.id} style={{
                      background:'white',border:'1px solid #bfdbfe',borderLeft:'3px solid #2563eb',
                      borderRadius:5,padding:'6px 8px',marginBottom:5
                    }}>
                      <div style={{fontWeight:700,color:'#1e3a8a',fontSize:15,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
                        {item.order_number}
                      </div>
                      <div style={{fontFamily:'monospace',fontWeight:900,color:'#07324C',fontSize:15,lineHeight:1.2,marginTop:1}}>
                        {item.sku_code || item.product_name || '—'}
                      </div>
                      {item.sku_code && item.product_name && <div style={{color:'#6b7280',fontSize:15,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{item.product_name}</div>}
                      {item.client_name && (
                        <div style={{color:'#9ca3af',fontSize:15,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{item.client_name}</div>
                      )}
                      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginTop:4}}>
                        <span style={{background:'#2563eb',color:'white',fontSize:15,fontWeight:700,padding:'1px 5px',borderRadius:3}}>
                          {(item.quantity||0).toLocaleString()}
                        </span>
                        <button
                          onClick={async () => {
                            try {
                              // Prefer item-level endpoint; fall back to order-level
                              try {
                                await api(`/order-items/${item.id}/docking-complete`, { method: 'PUT' }, token);
                              } catch {
                                await api(`/orders/${item.order_id}/docking-complete`, { method: 'PUT' }, token);
                              }
                              toast('Docking complete — ready for production scheduling', 'success');
                              loadRef.current();
                            } catch(e) { toast(e.message, 'error'); }
                          }}
                          style={{
                            background:'#16a34a',color:'white',border:'none',borderRadius:3,
                            padding:'2px 6px',fontSize:15,fontWeight:700,cursor:'pointer'
                          }}
                        >
                          ✓ Docking Complete
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
          <div style={{flex:1,overflow:'auto',background:'white'}}>
            {machines.length === 0 ? (
              <div style={{padding:24,color:'#9ca3af',textAlign:'center'}}>No machines/stations configured for this zone</div>
            ) : (
              <table style={{borderCollapse:'collapse',width:'max-content',minWidth:'100%'}}>
                <thead>
                  {/* Row 1: Day headers */}
                  <tr>
                    <th style={{
                      background:'#07324C',color:'white',padding:'6px 8px',
                      fontSize:14,fontWeight:700,whiteSpace:'nowrap',
                      position:'sticky',top:0,left:0,zIndex:30,
                      borderRight:'2px solid rgba(255,255,255,0.3)',
                      minWidth:60
                    }}>
                      {colLabel}
                    </th>
                    {days.map(day => (
                      <th key={day.date} colSpan={machines.length} style={{
                        background: day.is_closed ? '#6b7280' : '#07324C',
                        color: 'white',
                        padding: '4px 8px',
                        fontSize: 13,
                        fontWeight: 700,
                        borderLeft: '2px solid rgba(255,255,255,0.2)',
                        position: 'sticky',
                        top: 0,
                        zIndex: 20,
                        textAlign: 'center',
                        minWidth: machines.length * 110
                      }}>
                        <div style={{display:'flex',alignItems:'center',justifyContent:'center',gap:8,flexWrap:'wrap'}}>
                          <span>{day.day_name} {day.date.slice(5)}</span>
                          {day.is_closed && <span style={{background:'rgba(255,255,255,0.2)',fontSize:15,padding:'1px 5px',borderRadius:3}}>CLOSED</span>}
                          {!day.is_closed && day.total_planned > 0 && (
                            <span style={{background:'rgba(22,163,74,0.4)',fontSize:15,padding:'1px 5px',borderRadius:3,whiteSpace:'nowrap'}}>
                              {day.total_planned.toLocaleString()} planned
                            </span>
                          )}
                          <label style={{display:'flex',alignItems:'center',gap:3,cursor:'pointer',fontSize:15,color:'rgba(255,255,255,0.8)'}}>
                            <input type="checkbox" checked={day.is_closed} onChange={() => toggleCloseDay(day.date, day.is_closed)} style={{cursor:'pointer',width:11,height:11}} />
                            Close
                          </label>
                        </div>
                      </th>
                    ))}
                  </tr>

                  {/* Row 2: Machine sub-headers */}
                  <tr>
                    <th style={{
                      background:'#f1f5f9',padding:'4px 6px',fontSize:15,color:'#6b7280',
                      position:'sticky',top:32,left:0,zIndex:30,
                      borderRight:'2px solid #cbd5e1',borderBottom:'2px solid #cbd5e1'
                    }}>
                      Priority
                    </th>
                    {days.map(day =>
                      machines.map(machine => {
                        const slot = day.machine_slots?.[machine.id] || {};
                        const over = slot.over_capacity;
                        return (
                          <th key={`${day.date}-${machine.id}`} style={{
                            background: over ? '#fef2f2' : '#f8fafc',
                            padding: '3px 4px',
                            borderLeft: '1px solid #e2e8f0',
                            borderBottom: '2px solid #cbd5e1',
                            position: 'sticky',
                            top: 32,
                            zIndex: 10,
                            minWidth: 110,
                            maxWidth: 140
                          }}>
                            <MachineColHeader machine={machine} slot={slot} />
                          </th>
                        );
                      })
                    )}
                  </tr>
                </thead>

                <tbody>
                  {/* Dynamic rows — one row per work order slot */}
                  {Array.from({length: maxRows + 1}, (_, rowIdx) => (
                    <tr key={rowIdx} style={{minHeight: 36}}>
                      {/* Row label */}
                      <td style={{
                        background:'#f8fafc',padding:'4px 6px',fontSize:15,color:'#9ca3af',
                        fontWeight:700,textAlign:'center',
                        position:'sticky',left:0,zIndex:5,
                        borderRight:'2px solid #cbd5e1',borderBottom:'1px solid #f1f5f9',
                        minWidth:60
                      }}>
                        {rowIdx === 0 ? '—' : rowIdx}
                      </td>
                      {days.map(day => {
                      // --- CLOSED DAY: condensed single cell per machine ---
                      if (day.is_closed) {
                        return machines.map(machine => {
                          const slot = day.machine_slots?.[machine.id] || {};
                          const total = slot.total || 0;
                          const count = (slot.entries || []).length;
                          return (
                            <td key={`${day.date}-${machine.id}-${rowIdx}-closed`} style={{
                              padding: '3px',
                              borderLeft: '1px solid #e2e8f0',
                              borderBottom: '1px solid #f1f5f9',
                              minWidth: 110,
                              background: '#f1f5f9'
                            }}>
                              {rowIdx === 0 && total > 0 ? (
                                <div style={{padding:'4px 6px',textAlign:'center',color:'#64748b',fontSize:14,fontStyle:'italic'}}>
                                  <span style={{fontWeight:700}}>{total.toLocaleString()}</span> units
                                  <div style={{fontSize:15,color:'#94a3b8',marginTop:1}}>{count} job{count !== 1 ? 's' : ''}</div>
                                </div>
                              ) : rowIdx === 0 ? (
                                <div style={{padding:'4px 6px',textAlign:'center',color:'#cbd5e1',fontSize:14,fontStyle:'italic'}}>Closed</div>
                              ) : null}
                            </td>
                          );
                        });
                      }
                      // --- OPEN DAY: normal rendering ---
                      return machines.map(machine => {
                          const slot = day.machine_slots?.[machine.id] || {};
                          const entries = slot.entries || [];
                          const entry = entries[rowIdx];

                          // Only last row + 1 is a true drop zone
                          const isDropRow = rowIdx === entries.length;

                          if (entry) {
                            return (
                              <td key={`${day.date}-${machine.id}-${rowIdx}`} style={{
                                padding: '3px 3px',
                                borderLeft: '1px solid #e2e8f0',
                                borderBottom: '1px solid #f1f5f9',
                                verticalAlign: 'top',
                                minWidth: 110
                              }}>
                                <WOCard
                                  entry={entry}
                                  onRemove={removeEntry}
                                  onSplit={setSplitEntry}
                                  onEditQty={editQty}
                                  onDockingComplete={async (e) => {
                                    try {
                                      // Prefer item-level endpoint; fall back to order-level
                                      try {
                                        await api(`/order-items/${e.order_item_id}/docking-complete`, { method: 'PUT' }, token);
                                      } catch {
                                        await api(`/orders/${e.order_id}/docking-complete`, { method: 'PUT' }, token);
                                      }
                                      toast('Docking complete — released for production', 'success');
                                      loadRef.current();
                                    } catch(err) { toast(err.message, 'error'); }
                                  }}
                                />
                              </td>
                            );
                          }

                          if (isDropRow) {
                            return (
                              <DropZone
                                key={`${day.date}-${machine.id}-drop`}
                                machineId={machine.id}
                                dateStr={day.date}
                                isClosed={day.is_closed}
                                onDrop={handleDrop}
                              >
                                <div style={{height:36,display:'flex',alignItems:'center',justifyContent:'center',color:'#d1d5db',fontSize:15}}>
                                  drop here
                                </div>
                              </DropZone>
                            );
                          }

                          return (
                            <td key={`${day.date}-${machine.id}-${rowIdx}-empty`} style={{
                              padding: '3px',
                              borderLeft: '1px solid #e2e8f0',
                              borderBottom: '1px solid #f1f5f9',
                              minWidth: 110,
                              background: day.is_closed ? '#f9fafb' : 'white'
                            }} />
                          );
                        })
                      })}
                    </tr>
                  ))}

                  {/* Extra drop row at bottom */}
                  <tr>
                    <td style={{
                      background:'#f8fafc',padding:'4px 6px',fontSize:15,color:'#9ca3af',
                      position:'sticky',left:0,zIndex:5,
                      borderRight:'2px solid #cbd5e1',borderBottom:'1px solid #f1f5f9',textAlign:'center'
                    }}>+</td>
                    {days.map(day =>
                      machines.map(machine => (
                        day.is_closed ? (
                          <td key={`${day.date}-${machine.id}-extra-closed`} style={{padding:3,borderLeft:'1px solid #e2e8f0',borderBottom:'1px solid #f1f5f9',minWidth:110,background:'#f1f5f9'}} />
                        ) : (
                        <DropZone
                          key={`${day.date}-${machine.id}-extra`}
                          machineId={machine.id}
                          dateStr={day.date}
                          isClosed={day.is_closed}
                          onDrop={handleDrop}
                        >
                          <div style={{height:28,display:'flex',alignItems:'center',justifyContent:'center',color:'#d1d5db',fontSize:15}}>
                            +
                          </div>
                        </DropZone>
                        )
                      ))
                    )}
                  </tr>
                </tbody>
              </table>
            )}
          </div>
        </div>
      )}

      {/* Modals */}
      {showStockModal && (
        <StockRunModal token={token} zones={zones} onClose={() => setShowStockModal(false)} onCreated={reload} />
      )}
      {splitEntry && (
        <SplitModal entry={splitEntry} token={token} onClose={() => setSplitEntry(null)} onSplit={reload} />
      )}
      <RescheduleModal
        modal={rescheduleModal}
        stations={planData?.machines || []}
        onConfirm={confirmReschedule}
        onCancel={() => setRescheduleModal(null)}
      />
      <OverCapacityModal
        modal={overCapacityModal}
        token={token}
        onClose={() => setOverCapacityModal(null)}
        onComplete={reload}
      />
    </div>
  );
};


// ═══════════════════════════════════════════════════════════════
// PRODUCTION MANAGER — Station Allocation (primarily Handmade)
// Prod Manager assigns scheduled work orders to specific tables/stations
// ═══════════════════════════════════════════════════════════════
const ProductionManager = ({ token }) => {
  const [zones, setZones] = useState([]);
  const [activeZone, setActiveZone] = useState(null);
  const [stations, setStations] = useState([]);
  const [schedule, setSchedule] = useState([]);
  const [loading, setLoading] = useState(true);
  const [dateFilter, setDateFilter] = useState(localDateStr());
  const [numDays, setNumDays] = useState(1);
  const [dockingOrders, setDockingOrders] = useState([]);
  const [recentlyDocked, setRecentlyDocked] = useState([]);

  const activeZoneObj = zones.find(z => z.id === activeZone);
  const zoneStations = stations.filter(s => s.zone_id === activeZone);

  // Stable data loader using ref to avoid dep loops
  const loadRef = useRef(null);
  loadRef.current = async () => {
    setLoading(true);
    setRecentlyDocked([]);
    try {
      // For multi-day: fetch schedule for each day in range
      const dates = [];
      for (let i = 0; i < numDays; i++) {
        const d = new Date(dateFilter + 'T00:00:00');
        d.setDate(d.getDate() + i);
        dates.push(localDateStr(d));
      }
      const [zs, allOrds, ...schedResults] = await Promise.all([
        api('/zones', {}, token),
        api('/orders', {}, token),
        ...dates.map(d => api(`/schedule?date=${d}`, {}, token))
      ]);
      setZones(zs);
      // Default to Handmade zone
      setActiveZone(prev => {
        if (prev) return prev;
        const hmp = zs.find(z => z.code === 'HMP');
        return hmp ? hmp.id : (zs.length ? zs[0].id : null);
      });
      // Merge all schedule results (tag each entry with its date)
      const merged = schedResults.flat();
      setSchedule(merged);
      // Docking: store ALL orders with C items, filter by zone at render time
      const docking = allOrds.filter(o => {
        const breakdown = o.item_status_breakdown || {};
        return (breakdown['C'] || 0) > 0;
      });
      const enriched = await Promise.all(docking.map(async o => {
        try {
          const items = await api(`/orders/${o.id}/items`, {}, token);
          o._items = items || [];
        } catch { o._items = []; }
        return o;
      }));
      setDockingOrders(enriched);
      const allSt = [];
      for (const z of zs) { if (z.stations) allSt.push(...z.stations); }
      setStations(allSt);
    } catch (e) { toast(e.message, 'error'); }
    setLoading(false);
  };

  useEffect(() => { loadRef.current(); }, [dateFilter, numDays, token]);

  const reload = () => loadRef.current();

  const assignStation = async (entryId, stationId) => {
    try {
      await api(`/schedule/${entryId}`, {
        method: 'PUT',
        body: JSON.stringify({ station_id: stationId || null })
      }, token);
      toast(stationId ? 'Station assigned' : 'Station removed', 'success');
      reload();
    } catch (e) { toast(e.message, 'error'); }
  };

  const moveStatus = async (entryId, status) => {
    try {
      // Find the schedule entry to get order_item_id, station_id, zone_id
      const entry = schedule.find(s => s.id === entryId);

      if (status === 'in_progress' && entry && entry.order_item_id && entry.station_id) {
        // Create a production session — this promotes the order_item R→P on the backend
        await api('/production/sessions', {
          method: 'POST',
          body: JSON.stringify({
            order_item_id: entry.order_item_id,
            station_id: entry.station_id,
            zone_id: entry.zone_id,
            target_quantity: entry.planned_quantity || entry.item_quantity || 0
          })
        }, token);
      }

      if (status === 'completed' && entry && entry.order_item_id) {
        // Find active production session for this order_item and complete it
        try {
          const sessions = await api('/production/sessions?status=active', {}, token);
          const activeSession = (sessions || []).find(s => s.order_item_id === entry.order_item_id);
          if (activeSession) {
            await api(`/production/sessions/${activeSession.id}/complete`, {
              method: 'PUT',
              body: JSON.stringify({ produced_quantity: activeSession.produced_quantity || entry.planned_quantity || entry.item_quantity || 0 })
            }, token);
          }
        } catch (compErr) { console.warn('Could not complete production session:', compErr); }
      }

      // Update the schedule entry status
      await api(`/schedule/${entryId}`, {
        method: 'PUT',
        body: JSON.stringify({ status })
      }, token);
      toast(`Status → ${status}`, 'success');
      reload();
    } catch (e) { toast(e.message, 'error'); }
  };

  const zoneEntries = schedule.filter(s => s.zone_id === activeZone);
  const unassigned = zoneEntries.filter(s => !s.station_id);
  const stationLabel = activeZoneObj?.code === 'HMP' ? 'Table' : activeZoneObj?.code === 'VIK' ? 'Machine' : 'Station';

  // Navigate dates
  const shiftDate = (days) => {
    const d = new Date(dateFilter + 'T00:00:00');
    d.setDate(d.getDate() + days);
    setDateFilter(localDateStr(d));
  };
  const isToday = dateFilter === localDateStr();
  const dateLabelStr = numDays === 1
    ? new Date(dateFilter + 'T00:00:00').toLocaleDateString('en-AU',{weekday:'long',day:'numeric',month:'long',year:'numeric'})
    : (() => {
        const endD = new Date(dateFilter + 'T00:00:00');
        endD.setDate(endD.getDate() + numDays - 1);
        return new Date(dateFilter + 'T00:00:00').toLocaleDateString('en-AU',{day:'numeric',month:'short'}) +
          ' — ' + endD.toLocaleDateString('en-AU',{day:'numeric',month:'short',year:'numeric'});
      })();

  return (
    <div className="p-6 space-y-4">
      {/* Header */}
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h1 className="text-2xl font-black text-[#07324C]">Station Allocation</h1>
          <p className="text-xs text-gray-500 mt-0.5">Production Manager — assign work orders to stations/tables</p>
        </div>
        <div className="flex items-center gap-2">
          <button className="btn btn-secondary btn-sm" onClick={()=>shiftDate(-numDays)}>‹ Prev</button>
          <span className={`text-sm font-semibold px-2 ${isToday?'text-[#07324C]':'text-gray-600'}`}>{dateLabelStr}</span>
          <button className="btn btn-secondary btn-sm" onClick={()=>shiftDate(numDays)}>Next ›</button>
          <button className="btn btn-outline btn-sm" onClick={()=>setDateFilter(localDateStr())}>Today</button>
          <select
            value={numDays}
            onChange={e => setNumDays(parseInt(e.target.value))}
            className="text-sm border border-gray-300 rounded-md px-2 py-1"
          >
            {[1,2,3,4,5,6,7].map(n => (
              <option key={n} value={n}>{n} Day{n>1?'s':''}</option>
            ))}
          </select>
          <button className="btn btn-outline btn-sm" onClick={reload}>Refresh</button>
        </div>
      </div>

      {/* Zone tabs */}
      <div className="tab-bar">
        {zones.map(z => (
          <div key={z.id} className={`tab-item ${activeZone===z.id?'active':''}`} onClick={()=>setActiveZone(z.id)}>{z.name}</div>
        ))}
      </div>

      {loading ? <div className="flex justify-center py-12"><Spinner /></div> : (
        <>
          {/* Docking Queue Panel — filtered by active zone */}
          {(() => {
            const zoneDocking = dockingOrders.filter(o => {
              const items = o._items || [];
              return items.some(i => i.status === 'C' && i.zone_id === activeZone);
            });
            return zoneDocking.length > 0 && (
            <div className="hp-card" style={{borderTop:'3px solid #1d4ed8'}}>
              <h3 className="text-xs font-bold text-blue-700 uppercase tracking-wider mb-2">
                🚢 Docking Queue — {zoneDocking.length} order{zoneDocking.length!==1?'s':''} awaiting docking completion ({activeZoneObj?.name || ''})
              </h3>
              <p className="text-xs text-gray-400 mb-3">These orders have cut lists issued for this zone and are currently being docked/prepared. Mark complete when ready for production.</p>
              <div className="flex gap-3 overflow-x-auto pb-1" style={{scrollSnapType:'x mandatory'}}>
                {zoneDocking.map(order => (
                  <div key={order.id} style={{
                    minWidth:200,maxWidth:220,background:'#eff6ff',border:'1px solid #bfdbfe',
                    borderLeft:'4px solid #2563eb',borderRadius:8,padding:'10px 12px',flexShrink:0,
                    scrollSnapAlign:'start'
                  }}>
                    <div style={{fontWeight:800,color:'#1e3a8a',fontSize:14,marginBottom:2}}>{order.order_number}</div>
                    <div style={{fontSize:15,color:'#6b7280',marginBottom:1}}>{order.client_name||'—'}</div>
                    <div style={{fontSize:14,color:'#9ca3af',marginBottom:4}}>{order.item_count||0} item{order.item_count!==1?'s':''} · {(order.total_qty||0).toLocaleString()} units</div>
                    <button
                      onClick={async () => {
                        try {
                          await api(`/orders/${order.id}/docking-complete`, { method: 'PUT' }, token);
                          toast('✅ Docking complete — WO released for production', 'success');
                          // Move from docking to recently-docked (keeps visible with READY status)
                          setDockingOrders(prev => prev.filter(o => o.id !== order.id));
                          setRecentlyDocked(prev => [...prev, {...order, status: 'R'}]);
                          // Reload schedule entries to pick up the updated order_status
                          const sched = await api(`/schedule?date=${dateFilter}`, {}, token);
                          setSchedule(sched);
                        } catch(e) { toast(e.message, 'error'); }
                      }}
                      style={{
                        width:'100%',background:'#16a34a',color:'white',border:'none',
                        borderRadius:5,padding:'5px 8px',fontSize:14,fontWeight:700,cursor:'pointer'
                      }}
                    >
                      ✓ Complete Docking
                    </button>
                  </div>
                ))}
              </div>
            </div>
          ); })()}
          {recentlyDocked.length > 0 && (
            <div style={{background:'#f0fdf4',border:'1px solid #86efac',borderRadius:8,padding:'10px 14px',marginBottom:12}}>
              <div style={{fontWeight:700,fontSize:14,color:'#166534',marginBottom:6}}>✅ Recently Released ({recentlyDocked.length})</div>
              <div style={{display:'flex',gap:8,overflowX:'auto',paddingBottom:4}}>
                {recentlyDocked.map(order => (
                  <div key={order.id} style={{
                    minWidth:200,maxWidth:220,background:'white',border:'1px solid #86efac',
                    borderLeft:'4px solid #16a34a',borderRadius:8,padding:'10px 12px',flexShrink:0
                  }}>
                    <div style={{fontWeight:800,color:'#166534',fontSize:14,marginBottom:2}}>{order.order_number}</div>
                    <div style={{fontSize:15,color:'#6b7280'}}>{order.client_name||'—'}</div>
                    <div style={{display:'inline-block',background:'#dcfce7',color:'#166534',fontSize:14,fontWeight:700,padding:'2px 8px',borderRadius:4,marginTop:4}}>✅ READY FOR PRODUCTION</div>
                  </div>
                ))}
              </div>
            </div>
          )}
          <div className="grid gap-4" style={{gridTemplateColumns: 'minmax(240px,1fr) 3fr'}}>
          {/* Unassigned queue */}
          <div className="hp-card">
            <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Unassigned Work</h3>
            <div className="text-xs text-gray-400 mb-3">{unassigned.length} order{unassigned.length!==1?'s':''} need {stationLabel.toLowerCase()} assignment</div>
            {unassigned.length === 0 ? <Empty msg="All work assigned — or no work scheduled for this date/zone" /> : (
              <div className="space-y-2" style={{maxHeight:'calc(100vh - 320px)',overflowY:'auto'}}>
                {unassigned.map(entry => (
                  <div key={entry.id} style={{background:'#fffbeb',border:'1px solid #fbbf24',borderRadius:8,padding:'8px 10px'}}>
                    <div className="font-bold text-[#07324C]" style={{fontSize:14}}>{entry.order_number||'—'}</div>
                    <div className="text-gray-500" style={{fontSize:15}}>{entry.client_name||''}</div>
                    <div className="text-gray-500" style={{fontSize:15}}>
                      <span style={{fontFamily:'monospace',fontWeight:900,color:'#07324C',fontSize:14}}>{entry.sku_code || '—'}</span>
                      {entry.sku_code && entry.product_name && <span style={{color:'#9ca3af',fontWeight:400}}> — {entry.product_name}</span>}
                    </div>
                    <div className="text-gray-400" style={{fontSize:15}}>{entry.item_quantity||entry.planned_quantity||0} units</div>
                    <div style={{marginTop:6}}>
                      <select
                        style={{fontSize:15,padding:'4px 6px',borderRadius:6,border:'1px solid #d1d5db',width:'100%'}}
                        value=""
                        onChange={e => e.target.value && assignStation(entry.id, parseInt(e.target.value))}
                      >
                        <option value="">Assign {stationLabel}...</option>
                        {zoneStations.map(st => (
                          <option key={st.id} value={st.id}>{st.name}</option>
                        ))}
                      </select>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Station cards grid */}
          <div>
            <div className="grid gap-3" style={{gridTemplateColumns: `repeat(auto-fill, minmax(200px, 1fr))`}}>
              {zoneStations.map(station => {
                const stEntries = zoneEntries.filter(s => s.station_id === station.id);
                const hasWork = stEntries.length > 0;
                return (
                  <div key={station.id} className="hp-card" style={{borderTop: hasWork ? '3px solid #07324C' : '3px solid #e2e8f0', padding:'12px'}}>
                    <div className="flex items-center justify-between mb-2">
                      <div>
                        <div style={{fontWeight:800,fontSize:15,color:'#07324C'}}>{station.name}</div>
                        <div style={{fontSize:14,color:'#9ca3af'}}>{station.code}</div>
                      </div>
                      <div style={{
                        background: hasWork ? '#dcfce7' : '#f3f4f6',
                        color: hasWork ? '#166534' : '#9ca3af',
                        fontSize:14, fontWeight:700, padding:'2px 8px', borderRadius:10
                      }}>
                        {stEntries.length} job{stEntries.length!==1?'s':''}
                      </div>
                    </div>
                    {stEntries.length === 0 ? (
                      <div style={{fontSize:15,color:'#9ca3af',fontStyle:'italic',padding:'8px 0'}}>No work allocated</div>
                    ) : (
                      <div className="space-y-2">
                        {stEntries.map(entry => {
                          const itemStatus = entry.item_status || entry.order_status;
                          const isDockingOrder = itemStatus === 'C';
                          const isReadyOrder = itemStatus === 'R';
                          const isInProd = itemStatus === 'P';
                          const borderColor = isDockingOrder ? '#2563eb' : isReadyOrder ? '#16a34a' : isInProd ? '#7c3aed' : '#e2e8f0';
                          return (
                          <div key={entry.id} style={{background:'#f8fafc',border:'1px solid #e2e8f0',borderLeft:`3px solid ${borderColor}`,borderRadius:6,padding:'6px 8px'}}>
                            <div className="flex items-start justify-between">
                              <div>
                                <div className="font-bold text-[#07324C]" style={{fontSize:15}}>{entry.order_number||'—'}</div>
                                <div className="text-gray-500" style={{fontSize:14}}>{entry.client_name||''}</div>
                                <div style={{fontFamily:'monospace',fontWeight:900,color:'#07324C',fontSize:14,lineHeight:1.2,marginTop:1}}>
                                  {entry.sku_code || entry.product_name || '—'}
                                </div>
                                {entry.sku_code && entry.product_name && <div style={{color:'#6b7280',fontSize:15}}>{entry.product_name}</div>}
                                <div className="text-gray-400" style={{fontSize:14}}>{entry.item_quantity||entry.planned_quantity||0} units</div>
                              </div>
                              <div style={{display:'flex',flexDirection:'column',alignItems:'flex-end',gap:3}}>
                                <span style={{
                                  fontSize:15,fontWeight:700,padding:'2px 6px',borderRadius:8,
                                  background: entry.status==='in_progress' ? '#dbeafe' : entry.status==='completed' ? '#dcfce7' : '#f3f4f6',
                                  color: entry.status==='in_progress' ? '#1d4ed8' : entry.status==='completed' ? '#166534' : '#6b7280'
                                }}>{entry.status||'planned'}</span>
                                {isDockingOrder && <span style={{fontSize:15,fontWeight:700,padding:'2px 6px',borderRadius:8,background:'#dbeafe',color:'#1d4ed8'}}>🔶 DOCKING</span>}
                                {isReadyOrder && <span style={{fontSize:15,fontWeight:700,padding:'2px 6px',borderRadius:8,background:'#dcfce7',color:'#166534'}}>✅ READY</span>}
                                {isInProd && <span style={{fontSize:15,fontWeight:700,padding:'2px 6px',borderRadius:8,background:'#ede9fe',color:'#6d28d9'}}>🔧 IN PROD</span>}
                              </div>
                            </div>
                            <div className="flex gap-1 mt-2">
                              <button style={{fontSize:15,padding:'2px 6px',background:'#fee2e2',color:'#991b1b',borderRadius:4,cursor:'pointer',border:'none'}}
                                onClick={()=>assignStation(entry.id, null)}>Unassign</button>
                              {entry.status === 'planned' && (
                                <button style={{fontSize:15,padding:'2px 6px',background:'#dbeafe',color:'#1d4ed8',borderRadius:4,cursor:'pointer',border:'none'}}
                                  onClick={()=>moveStatus(entry.id,'in_progress')}>Start</button>
                              )}
                              {entry.status === 'in_progress' && (
                                <button style={{fontSize:15,padding:'2px 6px',background:'#dcfce7',color:'#166534',borderRadius:4,cursor:'pointer',border:'none'}}
                                  onClick={()=>moveStatus(entry.id,'completed')}>Complete</button>
                              )}
                            </div>
                          </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        </div>
        </>
      )}
    </div>
  );
};

// ═══════════════════════════════════════════════════════════════
// PRODUCTION FLOOR OVERVIEW — Zone-by-zone real-time view
// ═══════════════════════════════════════════════════════════════
const ZONE_COLORS = {
  VIK: { bg: '#07324C', accent: '#1d4ed8', light: '#dbeafe', border: '#1d4ed8' },
  HMP: { bg: '#92400e', accent: '#d97706', light: '#fef3c7', border: '#d97706' },
  DTL: { bg: '#166534', accent: '#16a34a', light: '#dcfce7', border: '#16a34a' },
  CRT: { bg: '#7c2d12', accent: '#ea580c', light: '#ffedd5', border: '#ea580c' },
};
const ZONE_ORDER = ['VIK', 'HMP', 'DTL', 'CRT'];

const FloorOverviewStationCard = ({ station, activeSessions, queuedWork }) => {
  const hasActive = activeSessions.length > 0;
  const session = hasActive ? activeSessions[0] : null;
  const pct = session && session.order_qty > 0 ? Math.min(100, Math.round((session.produced_quantity || 0) / session.order_qty * 100)) : 0;

  return (
    <div style={{
      border: hasActive ? '2px solid #16a34a' : '1px solid #e2e8f0',
      borderRadius: 10, background: 'white', overflow: 'hidden',
      boxShadow: hasActive ? '0 0 0 2px rgba(22,163,74,0.15)' : 'none',
    }}>
      {/* Station header */}
      <div style={{
        padding: '8px 12px', fontSize: 14, fontWeight: 800, color: 'white',
        background: hasActive ? '#16a34a' : '#94a3b8',
        display: 'flex', justifyContent: 'space-between', alignItems: 'center',
      }}>
        <span>{station.name}</span>
        {hasActive && session?.status === 'paused' && (
          <span style={{fontSize:15,background:'#fbbf24',color:'#78350f',padding:'1px 6px',borderRadius:4,fontWeight:700}}>PAUSED</span>
        )}
        {hasActive && session?.status === 'active' && (
          <span style={{fontSize:15,background:'rgba(255,255,255,0.25)',padding:'1px 6px',borderRadius:4}}>ACTIVE</span>
        )}
        {!hasActive && <span style={{fontSize:15,opacity:0.7}}>IDLE</span>}
      </div>

      <div style={{padding: '10px 12px'}}>
        {hasActive ? (
          <>
            {/* SKU — bold and prominent */}
            <div style={{fontSize:20,fontWeight:900,color:'#07324C',lineHeight:1.2,marginBottom:4,fontFamily:'monospace'}}>
              {session.sku_code || 'NO SKU'}
            </div>
            <div style={{fontSize:15,color:'#6b7280',marginBottom:2}}>{session.product_name || ''}</div>
            <div style={{fontSize:15,fontWeight:700,color:'#07324C'}}>{session.order_number}</div>
            <div style={{fontSize:14,color:'#9ca3af'}}>{session.client_name}</div>

            {/* Progress bar */}
            <div style={{marginTop:8,display:'flex',alignItems:'center',gap:8}}>
              <div style={{flex:1,height:8,background:'#f1f5f9',borderRadius:4,overflow:'hidden'}}>
                <div style={{width:`${pct}%`,height:'100%',borderRadius:4,background:pct>=100?'#22c55e':pct>=60?'#f59e0b':'#07324C',transition:'width 0.3s'}}></div>
              </div>
              <span style={{fontSize:15,fontWeight:800,color:pct>=100?'#16a34a':'#07324C',minWidth:40,textAlign:'right'}}>{pct}%</span>
            </div>
            <div style={{fontSize:14,color:'#6b7280',marginTop:3}}>
              {(session.produced_quantity||0).toLocaleString()} / {(session.order_qty||0).toLocaleString()} units
            </div>

            {/* Workers */}
            {session.workers && session.workers.length > 0 && (
              <div style={{marginTop:6,display:'flex',flexWrap:'wrap',gap:4}}>
                {session.workers.map((w,i) => (
                  <span key={i} style={{fontSize:15,background:'#f1f5f9',padding:'2px 6px',borderRadius:4,color:'#374151',fontWeight:600}}>
                    {w.full_name}
                  </span>
                ))}
              </div>
            )}

            {/* Drawing number */}
            {session.drawing_number && (
              <div style={{fontSize:15,color:'#9ca3af',marginTop:4}}>Dwg: {session.drawing_number}</div>
            )}
          </>
        ) : (
          <>
            {queuedWork.length > 0 ? (
              <div>
                <div style={{fontSize:15,fontWeight:700,color:'#d97706',textTransform:'uppercase',marginBottom:4}}>Queued ({queuedWork.length})</div>
                {queuedWork.slice(0,3).map((q,i) => (
                  <div key={i} style={{fontSize:15,marginBottom:3,padding:'3px 6px',background:'#fffbeb',borderRadius:4,border:'1px solid #fde68a'}}>
                    <span style={{fontWeight:800,color:'#07324C',fontFamily:'monospace'}}>{q.sku_code||'—'}</span>
                    <span style={{color:'#6b7280',marginLeft:4}}>{q.order_number}</span>
                    <span style={{color:'#9ca3af',marginLeft:4,fontSize:15}}>{q.quantity} units</span>
                  </div>
                ))}
                {queuedWork.length > 3 && <div style={{fontSize:15,color:'#9ca3af'}}>+{queuedWork.length-3} more</div>}
              </div>
            ) : (
              <div style={{textAlign:'center',color:'#cbd5e1',fontSize:15,padding:'12px 0'}}>
                No work assigned
              </div>
            )}
          </>
        )}
      </div>
    </div>
  );
};

const ProductionFloorOverview = ({ token }) => {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);
  const intervalRef = useRef(null);

  const load = useCallback(async () => {
    try {
      const d = await api('/production/floor-overview', {}, token);
      setData(d);
    } catch (e) { toast(e.message, 'error'); }
    setLoading(false);
  }, [token]);

  useEffect(() => {
    load();
    // Auto-refresh every 15 seconds for real-time visibility
    intervalRef.current = setInterval(load, 15000);
    return () => clearInterval(intervalRef.current);
  }, [load]);

  // Sort zones in the specified order: Viking, Handmade, DTL, Crates
  const sortedZones = [...data].sort((a, b) => {
    const ai = ZONE_ORDER.indexOf(a.zone.code);
    const bi = ZONE_ORDER.indexOf(b.zone.code);
    return (ai === -1 ? 99 : ai) - (bi === -1 ? 99 : bi);
  });

  // Summary stats
  const totalActive = data.reduce((sum, z) => sum + z.stations.reduce((s2, st) => s2 + st.active_sessions.length, 0), 0);
  const totalQueued = data.reduce((sum, z) => sum + z.stations.reduce((s2, st) => s2 + st.queued_work.length, 0), 0);
  const totalStations = data.reduce((sum, z) => sum + z.stations.length, 0);
  const activeStations = data.reduce((sum, z) => sum + z.stations.filter(st => st.active_sessions.length > 0).length, 0);

  return (
    <div style={{padding:16,maxWidth:1600,margin:'0 auto'}}>
      {/* Header */}
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:16}}>
        <div>
          <h1 style={{fontSize:26,fontWeight:900,color:'#07324C',margin:0}}>Production Floor</h1>
          <p style={{fontSize:14,color:'#6b7280',margin:'4px 0 0'}}>Real-time view across all manufacturing zones</p>
        </div>
        <div style={{display:'flex',gap:16,alignItems:'center'}}>
          <div style={{textAlign:'center'}}>
            <div style={{fontSize:28,fontWeight:900,color:'#16a34a'}}>{activeStations}</div>
            <div style={{fontSize:14,color:'#6b7280',fontWeight:600}}>Active</div>
          </div>
          <div style={{textAlign:'center'}}>
            <div style={{fontSize:28,fontWeight:900,color:'#d97706'}}>{totalQueued}</div>
            <div style={{fontSize:14,color:'#6b7280',fontWeight:600}}>Queued</div>
          </div>
          <div style={{textAlign:'center'}}>
            <div style={{fontSize:28,fontWeight:900,color:'#94a3b8'}}>{totalStations - activeStations}</div>
            <div style={{fontSize:14,color:'#6b7280',fontWeight:600}}>Idle</div>
          </div>
          <button onClick={load} style={{background:'#07324C',color:'white',border:'none',borderRadius:6,padding:'8px 14px',cursor:'pointer',fontWeight:700,fontSize:14}}>
            ↺ Refresh
          </button>
        </div>
      </div>

      {loading ? <div style={{display:'flex',justifyContent:'center',padding:48}}><Spinner /></div> : (
        <div style={{display:'flex',flexDirection:'column',gap:20}}>
          {sortedZones.map(zoneData => {
            const zone = zoneData.zone;
            const colors = ZONE_COLORS[zone.code] || ZONE_COLORS.VIK;
            const zoneActive = zoneData.stations.filter(st => st.active_sessions.length > 0).length;
            const zoneTotal = zoneData.stations.length;

            return (
              <div key={zone.id} style={{border:`2px solid ${colors.border}`,borderRadius:12,overflow:'hidden'}}>
                {/* Zone header */}
                <div style={{
                  background: colors.bg, padding:'12px 16px',
                  display:'flex', justifyContent:'space-between', alignItems:'center'
                }}>
                  <div style={{display:'flex',alignItems:'center',gap:10}}>
                    <span style={{fontSize:20,fontWeight:900,color:'white'}}>{zone.name}</span>
                    <span style={{fontSize:15,color:'rgba(255,255,255,0.6)',fontWeight:600}}>{zone.code}</span>
                  </div>
                  <div style={{display:'flex',gap:12,alignItems:'center'}}>
                    <span style={{fontSize:15,color:'rgba(255,255,255,0.8)',fontWeight:600}}>
                      {zoneActive}/{zoneTotal} stations active
                    </span>
                    <div style={{width:80,height:6,background:'rgba(255,255,255,0.2)',borderRadius:3,overflow:'hidden'}}>
                      <div style={{width:`${zoneTotal>0?(zoneActive/zoneTotal*100):0}%`,height:'100%',background:'#22c55e',borderRadius:3}}></div>
                    </div>
                  </div>
                </div>

                {/* Station grid */}
                <div style={{
                  padding:12, background:colors.light,
                  display:'grid',
                  gridTemplateColumns: `repeat(auto-fill, minmax(240px, 1fr))`,
                  gap:10
                }}>
                  {zoneData.stations.map(st => (
                    <FloorOverviewStationCard
                      key={st.station.id}
                      station={st.station}
                      activeSessions={st.active_sessions}
                      queuedWork={st.queued_work}
                    />
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* Auto-refresh indicator */}
      <div style={{textAlign:'center',marginTop:12,fontSize:14,color:'#9ca3af'}}>Auto-refreshing every 15 seconds</div>
    </div>
  );
};

// ═══════════════════════════════════════════════════════════════
// FLOOR TABLET
// ═══════════════════════════════════════════════════════════════
const FloorTablet = ({ token, user }) => {
  const [view, setView] = useState('select'); // select | setup | production
  const [orders, setOrders] = useState([]);
  const [session, setSession] = useState(null);
  const [loading, setLoading] = useState(true);
  const [qty, setQty] = useState(0);
  const [target, setTarget] = useState(0);
  const [paused, setPaused] = useState(false);
  const [pauseReason, setPauseReason] = useState(null);
  const intervalRef = useRef(null);

  const loadOrders = useCallback(async () => {
    try {
      // Fetch all active orders and filter those with R or P items
      const allOrds = await api('/orders', {}, token);
      const active = allOrds.filter(o => {
        const breakdown = o.item_status_breakdown || {};
        return (breakdown['R'] || 0) > 0 || (breakdown['P'] || 0) > 0;
      });
      setOrders(active);
    } catch (e) { toast(e.message,'error'); }
    setLoading(false);
  }, [token]);

  useEffect(() => { loadOrders(); }, [loadOrders]);

  // Auto-refresh production session
  useEffect(() => {
    if (view === 'production' && session) {
      intervalRef.current = setInterval(async () => {
        try {
          const sessions = await api(`/production/sessions?status=active`, {}, token);
          const curr = sessions.find(s=>s.id===session.id);
          if (curr) { setQty(curr.produced_quantity||0); setPaused(false); }
          else {
            const paused = await api(`/production/sessions?status=paused`, {}, token);
            const p = paused.find(s=>s.id===session.id);
            if (p) { setQty(p.produced_quantity||0); setPaused(true); }
          }
        } catch {}
      }, 30000);
    }
    return () => clearInterval(intervalRef.current);
  }, [view, session, token]);

  const startSession = async (order) => {
    try {
      // Get first R item for this order (preferring one that is R status)
      const items = await api(`/orders/${order.id}/items`, {}, token);
      if (!items.length) { toast('No items found for this order','warning'); return; }
      // Prefer items in R status, then any non-terminal status
      const rItem = items.find(i => i.status === 'R') || items.find(i => !['F','dispatched'].includes(i.status)) || items[0];
      const zones = await api('/zones', {}, token);
      const zone = zones.find(z=>z.id===rItem.zone_id) || zones[0];
      if (!zone?.stations?.length) { toast('No stations available','warning'); return; }
      const station = zone.stations[0];

      const s = await api('/production/sessions', {
        method: 'POST',
        body: JSON.stringify({
          order_item_id: rItem.id,
          station_id: station.id,
          zone_id: zone.id,
          target_quantity: rItem.quantity
        })
      }, token);
      // POST /production/sessions now promotes item R→P and syncs order status
      setSession({ ...s, order, item: rItem, zone, station });
      setQty(s.produced_quantity || 0);
      setTarget(rItem.quantity);
      setView('production');
      toast('Production session started','success');
    } catch (e) { toast(e.message,'error'); }
  };

  const logQty = async (change) => {
    if (!session || paused) return;
    try {
      const res = await api(`/production/sessions/${session.id}/log`, {method:'PUT',body:JSON.stringify({quantity_change:change})}, token);
      setQty(res.running_total);
    } catch (e) { toast(e.message,'error'); }
  };

  const pauseSession = async (reason) => {
    try {
      await api(`/production/sessions/${session.id}/pause`, {method:'PUT',body:JSON.stringify({reason})}, token);
      setPaused(true); setPauseReason(reason);
      toast(`Paused: ${reason}`,'warning');
    } catch (e) { toast(e.message,'error'); }
  };

  const resumeSession = async () => {
    try {
      await api(`/production/sessions/${session.id}/resume`, {method:'PUT'}, token);
      setPaused(false); setPauseReason(null);
      toast('Production resumed','success');
    } catch (e) { toast(e.message,'error'); }
  };

  const completeSession = async (forceComplete = false) => {
    try {
      await api(`/production/sessions/${session.id}/complete`, {method:'PUT',body:JSON.stringify({produced_quantity:qty, force_complete:forceComplete})}, token);
      toast('Production complete! Sent to QA for inspection.','success');
      setView('select');
      setSession(null);
      setQty(0);
      loadOrders();
    } catch (e) { toast(e.message,'error'); }
  };

  const pct = target > 0 ? Math.min(100, Math.round(qty/target*100)) : 0;
  const PAUSE_REASONS = ['material','cleaning','break','breakdown','forklift','urgent_changeover'];

  if (view === 'select') {
    return (
      <div className="p-6 space-y-4">
        <h1 className="text-2xl font-black text-[#07324C]">Production Floor</h1>
        <p className="text-gray-500 text-sm">Welcome, {user?.full_name}. Select a work order to begin.</p>

        {loading ? <div className="flex justify-center py-12"><Spinner /></div> : (
          orders.length === 0 ? <Empty msg="No orders assigned. Contact your supervisor." /> : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {orders.map(o => {
                const pctProd = o.total_qty > 0 ? Math.min(100,Math.round((o.total_produced||0)/o.total_qty*100)) : 0;
                return (
                  <div key={o.id} className="hp-card cursor-pointer hover:shadow-lg transition-shadow" onClick={()=>startSession(o)}>
                    <div className="flex items-start justify-between mb-3">
                      <div>
                        <div className="text-lg font-black text-[#07324C]">{o.order_number}</div>
                        {/* SKU — bold and prominent per directive */}
                        {o.primary_sku && (
                          <div style={{fontFamily:'monospace',fontWeight:900,color:'#07324C',fontSize:20,lineHeight:1.2,marginTop:2}}>
                            {o.primary_sku}
                          </div>
                        )}
                        {o.sku_codes && o.sku_codes.length > 1 && (
                          <div style={{fontSize:14,color:'#6b7280',marginTop:1}}>
                            +{o.sku_codes.length - 1} more SKU{o.sku_codes.length - 1 > 1 ? 's' : ''}
                          </div>
                        )}
                        <div className="text-sm text-gray-500">{o.client_name}</div>
                      </div>
                      <StatusBadge status={o.status} />
                    </div>
                    <div className="text-xs text-gray-500 mb-3">{o.item_count} item{o.item_count!==1?'s':''} · {o.total_qty} units total</div>
                    <div className="progress-bar-bg h-2 mb-2">
                      <div className="progress-bar-fill" style={{width:`${pctProd}%`}}></div>
                    </div>
                    <div className="flex items-center justify-between text-xs">
                      <span className="text-gray-500">{o.total_produced||0} / {o.total_qty} produced</span>
                      <span className="font-bold text-[#07324C]">{pctProd}%</span>
                    </div>
                    <button className={`btn w-full justify-center mt-4 btn-lg ${o.status==='P'?'btn-warning':'btn-success'}`}>
                      {o.status==='P'?'Resume Production':'Start Production'}
                    </button>
                  </div>
                );
              })}
            </div>
          )
        )}
      </div>
    );
  }

  // Production screen
  return (
    <div className="p-4 space-y-4 max-w-2xl mx-auto">
      {/* Order banner */}
      <div style={{background:'#07324C',borderRadius:12,padding:'16px 20px',color:'white'}}>
        <div className="flex items-start justify-between">
          <div>
            <div style={{fontSize:24,fontWeight:900}}>{session?.order?.order_number}</div>
            <div style={{marginTop:4}}>
              <span style={{fontFamily:'monospace',fontWeight:900,fontSize:22,color:'white'}}>{session?.item?.sku_code || '—'}</span>
            </div>
            {session?.item?.product_name && <div style={{fontSize:15,color:'#ABBFC8',marginTop:2}}>{session.item.product_name}</div>}
            <div style={{fontSize:14,color:'#ABBFC8'}}>{session?.order?.client_name}</div>
          </div>
          <div style={{textAlign:'right'}}>
            <div style={{fontSize:15,color:'#ABBFC8'}}>Drawing</div>
            <div style={{fontWeight:700}}>{session?.item?.drawing_number||'N/A'}</div>
          </div>
        </div>
        {session?.order?.special_instructions && (
          <div style={{marginTop:10,padding:'8px 12px',background:'rgba(237,28,36,0.15)',borderRadius:6,borderLeft:'3px solid #ED1C24',fontSize:14}}>
            <strong>Note:</strong> {session.order.special_instructions}
          </div>
        )}
      </div>

      {/* Progress */}
      <div className="hp-card text-center">
        <div style={{fontSize:56,fontWeight:900,color:'#07324C',lineHeight:1}}>{qty.toLocaleString()}</div>
        <div style={{fontSize:18,color:'#5F545C',margin:'4px 0'}}>/ {target.toLocaleString()} units</div>
        <div className="progress-bar-bg h-4 my-4">
          <div className="progress-bar-fill" style={{width:`${pct}%`,height:'100%',background: pct>=100?'#22C55E':pct>=80?'#F59E0B':'#07324C'}}></div>
        </div>
        <div style={{fontSize:32,fontWeight:900,color: pct>=100?'#22C55E':pct>=80?'#F59E0B':'#07324C'}}>{pct}%</div>
      </div>

      {/* Pause banner */}
      {paused && (
        <div className="flex items-center justify-between p-4 bg-amber-50 border-2 border-amber-400 rounded-xl">
          <div>
            <div className="font-black text-amber-800 text-lg">PAUSED</div>
            <div className="text-amber-600 text-sm capitalize">{pauseReason}</div>
          </div>
          <button className="btn btn-success btn-xl" onClick={resumeSession}>▶ Resume</button>
        </div>
      )}

      {/* Count buttons */}
      {!paused && (
        <div className="flex gap-3">
          <button className="floor-btn floor-btn-add" onClick={()=>logQty(1)}>+1</button>
          <button className="floor-btn floor-btn-add10" onClick={()=>logQty(10)}>+10</button>
          <button className="floor-btn floor-btn-sub" onClick={()=>logQty(-1)}>−1</button>
        </div>
      )}

      {/* Pause reasons */}
      {!paused && (
        <div>
          <div className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Pause Reason</div>
          <div className="flex flex-wrap gap-2">
            {PAUSE_REASONS.map(r => (
              <button key={r} className="pause-btn capitalize" onClick={()=>pauseSession(r)}>
                {r.replace('_',' ')}
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Complete + switch */}
      <div className="flex gap-3">
        {pct >= 100 && (
          <button className="btn btn-success btn-xl flex-1 justify-center" onClick={()=>completeSession(false)}>
            ✓ Complete Order
          </button>
        )}
        {pct < 100 && ['team_leader','production_manager','planner','executive'].includes(user?.role) && (
          <button className="btn btn-warning btn-lg flex-1 justify-center" onClick={()=>{
            if(confirm(`Complete this order at ${pct}% (${qty}/${target} units)? This will send to QA.`)) completeSession(true);
          }}>
            ✓ Force Complete ({pct}%)
          </button>
        )}
        <button className="btn btn-secondary btn-lg flex-1 justify-center" onClick={()=>{ setView('select'); }}>
          Switch Order
        </button>
        <button className="btn btn-outline btn-lg" onClick={()=>{ setView('select'); setSession(null); }}>
          Log Out
        </button>
      </div>
    </div>
  );
};

// ═══════════════════════════════════════════════════════════════
// PRODUCTION FLOOR WITH WORKER TAB — for team leaders, managers, planners, execs
// ═══════════════════════════════════════════════════════════════
const ProductionFloorWithWorkerTab = ({ token, user }) => {
  const [activeTab, setActiveTab] = useState('overview');
  const tabs = [
    { id: 'overview', label: 'Zone Overview' },
    { id: 'worker', label: 'Worker Console' },
  ];
  return (
    <div>
      {/* Tab bar */}
      <div style={{display:'flex',gap:0,borderBottom:'2px solid #e2e8f0',marginBottom:0,paddingLeft:24,paddingTop:12,background:'white'}}>
        {tabs.map(t => (
          <button key={t.id}
            onClick={() => setActiveTab(t.id)}
            style={{
              padding:'10px 24px',fontWeight:700,fontSize:16,
              borderBottom: activeTab===t.id ? '3px solid #07324C' : '3px solid transparent',
              color: activeTab===t.id ? '#07324C' : '#9ca3af',
              background:'transparent',border:'none',cursor:'pointer',
              marginBottom:-2
            }}>{t.label}</button>
        ))}
      </div>
      {/* Tab content */}
      {activeTab === 'overview' && <ProductionFloorOverview token={token} />}
      {activeTab === 'worker' && <FloorTablet token={token} user={user} />}
    </div>
  );
};

// ═══════════════════════════════════════════════════════════════
// QA DASHBOARD
// ═══════════════════════════════════════════════════════════════
const QADashboard = ({ token }) => {
  const [tab, setTab] = useState('pending');
  const [allInspections, setAllInspections] = useState([]);
  const [pendingInspections, setPendingInspections] = useState([]);
  const [loading, setLoading] = useState(true);
  const [inspecting, setInspecting] = useState(null);
  const [defectForm, setDefectForm] = useState({type:'rework',qty:1,desc:''});
  const [defects, setDefects] = useState([]);
  const [notes, setNotes] = useState('');

  const load = useCallback(async () => {
    setLoading(true);
    try {
      const [pending, all] = await Promise.all([
        api('/qa/inspections?passed=0', {}, token),
        api('/qa/inspections', {}, token),
      ]);
      setPendingInspections(pending);
      setAllInspections(all);
    } catch (e) { toast(e.message,'error'); }
    setLoading(false);
  }, [token]);

  useEffect(() => { load(); }, [load]);

  const addDefect = async () => {
    if (!inspecting) return;
    try {
      const d = await api(`/qa/inspections/${inspecting.id}/defects`, {
        method:'POST',
        body:JSON.stringify({defect_type:defectForm.type,quantity:defectForm.qty,description:defectForm.desc})
      }, token);
      setDefects(prev=>[...prev,d]);
      setDefectForm({type:'rework',qty:1,desc:''});
      toast('Defect logged','info');
    } catch (e) { toast(e.message,'error'); }
  };

  const approveAndRelease = async () => {
    try {
      await api(`/qa/inspections/${inspecting.id}/approve`, {method:'PUT'}, token);
      toast('QA Approved \u2014 item released to Finished','success');
      setInspecting(null);
      load();
    } catch (e) { toast(e.message,'error'); }
  };

  return (
    <div className="p-6 space-y-4">
      <h1 className="text-2xl font-black text-[#07324C]">QA Dashboard</h1>

      <div className="tab-bar">
        <div className={`tab-item ${tab==='pending'?'active':''}`} onClick={()=>setTab('pending')}>
          Pending Inspections {pendingInspections.length>0&&<span className="ml-1.5 bg-red-500 text-white text-xs rounded-full px-2">{pendingInspections.length}</span>}
        </div>
        <div className={`tab-item ${tab==='audit'?'active':''}`} onClick={()=>setTab('audit')}>Audit Log</div>
      </div>

      {loading ? <div className="flex justify-center py-12"><Spinner /></div> : (
        <>
          {tab === 'pending' && !inspecting && (
            <div className="hp-card">
              <h2 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4">Items Awaiting QA ({pendingInspections.length})</h2>
              {pendingInspections.length === 0 ? <Empty msg="No items awaiting QA inspection" /> : (
                <div className="table-scroll">
                  <table className="hp-table">
                    <thead><tr><th>Order #</th><th>SKU</th><th>Product</th><th>Client</th><th>Batch</th><th>Produced</th><th>Action</th></tr></thead>
                    <tbody>
                      {pendingInspections.map(insp => (
                        <tr key={insp.id}>
                          <td className="font-bold text-[#07324C]">{insp.order_number || '\u2014'}</td>
                          <td style={{fontFamily:'monospace',fontWeight:900,color:'#07324C',fontSize:15}}>{insp.sku_code || '\u2014'}</td>
                          <td>{insp.product_name || '\u2014'}</td>
                          <td>{insp.client_name || '\u2014'}</td>
                          <td>{insp.batch_size || '\u2014'}</td>
                          <td>{insp.produced_quantity || 0} / {insp.item_quantity || 0}</td>
                          <td><button className="btn btn-primary btn-sm" onClick={()=>{setInspecting(insp);setDefects([]);setNotes('');}}>Inspect</button></td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {tab === 'pending' && inspecting && (
            <div className="hp-card">
              <div className="flex items-center justify-between mb-4">
                <h2 className="font-bold text-[#07324C] text-lg">Inspecting: {inspecting.order_number}</h2>
                <button className="btn btn-secondary btn-sm" onClick={()=>setInspecting(null)}>\u2190 Back</button>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Batch Details</h3>
                  <div className="space-y-2 text-sm">
                    <div><span className="text-gray-400">Client:</span> <span className="font-medium">{inspecting.client_name}</span></div>
                    <div><span className="text-gray-400">Product:</span> <span className="font-medium">
                      <span style={{fontFamily:'monospace',fontWeight:900,color:'#07324C',fontSize:16}}>{inspecting.sku_code || '\u2014'}</span>
                      {inspecting.product_name && <span style={{color:'#6b7280',fontWeight:400}}> \u2014 {inspecting.product_name}</span>}
                    </span></div>
                    <div><span className="text-gray-400">Batch Size:</span> <span className="font-medium">{inspecting.batch_size || inspecting.item_quantity} units</span></div>
                    <div><span className="text-gray-400">Produced:</span> <span className="font-medium">{inspecting.produced_quantity || 0} units</span></div>
                    <div><span className="text-gray-400">Drawing:</span> <span className="font-medium">{inspecting.drawing_number||'N/A'}</span></div>
                  </div>

                  <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mt-4 mb-3">Log Defect</h3>
                  <div className="space-y-2">
                    <select className="hp-input" value={defectForm.type} onChange={e=>setDefectForm(p=>({...p,type:e.target.value}))}>
                      <option value="rework">Rework</option>
                      <option value="2nds">2nds</option>
                      <option value="destroy">Destroy</option>
                    </select>
                    <input type="number" className="hp-input" min="1" value={defectForm.qty} onChange={e=>setDefectForm(p=>({...p,qty:parseInt(e.target.value)||1}))} placeholder="Quantity" />
                    <input className="hp-input" value={defectForm.desc} onChange={e=>setDefectForm(p=>({...p,desc:e.target.value}))} placeholder="Description\u2026" />
                    <button className="btn btn-warning btn-sm" onClick={addDefect}>+ Log Defect</button>
                  </div>
                </div>

                <div>
                  <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Defects Logged ({defects.length})</h3>
                  {defects.length === 0 ? <p className="text-sm text-gray-400 mb-4">No defects logged.</p> : (
                    <div className="space-y-2 mb-4">
                      {defects.map((d,i) => (
                        <div key={i} className="flex items-center gap-3 p-2 bg-red-50 border border-red-100 rounded text-sm">
                          <span className="font-bold text-red-700 capitalize">{d.defect_type}</span>
                          <span className="text-red-600">\u00d7{d.quantity}</span>
                          <span className="text-gray-500 text-xs">{d.description}</span>
                        </div>
                      ))}
                    </div>
                  )}

                  <textarea className="hp-input mb-4" rows={3} value={notes} onChange={e=>setNotes(e.target.value)} placeholder="QA notes\u2026" />

                  <button className="btn btn-success btn-lg w-full justify-center" onClick={approveAndRelease}>
                    <Icon name="CheckCircle" size={18}/> Approve \u0026 Release to Finished
                  </button>
                </div>
              </div>
            </div>
          )}

          {tab === 'audit' && (
            <div className="hp-card">
              <h2 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4">QA Audit Log</h2>
              {allInspections.length === 0 ? <Empty msg="No inspections recorded yet" /> : (
                <div className="table-scroll">
                  <table className="hp-table">
                    <thead><tr><th>Order #</th><th>SKU</th><th>Inspector</th><th>Type</th><th>Batch</th><th>Result</th><th>Date</th></tr></thead>
                    <tbody>
                      {allInspections.map(i => (
                        <tr key={i.id}>
                          <td className="font-bold text-[#07324C]">{i.order_number||'\u2014'}</td>
                          <td className="font-mono font-bold" style={{color:'#07324C'}}>{i.sku_code||'\u2014'}</td>
                          <td>{i.inspector_name||'\u2014'}</td>
                          <td className="capitalize">{i.inspection_type}</td>
                          <td>{i.batch_size||'\u2014'}</td>
                          <td>{i.passed ? <span className="text-green-600 font-bold">Pass</span> : <span className="text-red-600 font-bold">Pending</span>}</td>
                          <td className="text-xs text-gray-500">{i.inspected_at?.split('T')[0] || '\u2014'}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}
        </>
      )}
    </div>
  );
};

// ═══════════════════════════════════════════════════════════════
// DISPATCH DASHBOARD — Planning Board Style with Truck Tabs
// ═══════════════════════════════════════════════════════════════

// Format minutes as human-readable string
const fmtMinutes = (mins) => {
  if (!mins || mins <= 0) return null;
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  if (h === 0) return `~${m}min`;
  if (m === 0) return `~${h}h`;
  return `~${h}h${m}m`;
};

// Dispatch delivery card for the board
const DispatchCard = ({ entry, trucks, onAssign, onAction, onDragStart, token }) => {
  const isOverdue = entry.expected_date && entry.expected_date < localDateStr();
  const allDone = entry.all_finished;
  const [editingMins, setEditingMins] = useState(false);
  const [minsVal, setMinsVal] = useState(entry.estimated_minutes || '');

  const saveMins = async () => {
    setEditingMins(false);
    const parsed = parseInt(minsVal);
    if (isNaN(parsed) || parsed === entry.estimated_minutes) return;
    try {
      await api(`/delivery-log/${entry.id}`, {method:'PUT', body:JSON.stringify({estimated_minutes: parsed})}, token);
      toast('Estimated time updated','success');
    } catch(e) { toast(e.message,'error'); }
  };

  return (
    <div
      draggable
      onDragStart={e => { e.dataTransfer.setData('text/plain', JSON.stringify({ dl_id: entry.id, order_number: entry.order_number, estimated_minutes: entry.estimated_minutes || 30 })); if(onDragStart) onDragStart(entry); }}
      style={{
        padding:'8px 10px', marginBottom:6, borderRadius:8,
        border: allDone ? '2px solid #16a34a' : isOverdue ? '2px solid #dc2626' : '1px solid #e2e8f0',
        background: allDone ? '#f0fdf4' : isOverdue ? '#fef2f2' : 'white',
        cursor:'grab', fontSize:14
      }}
    >
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:4}}>
        <div>
          <div style={{fontWeight:800,color:'#07324C',fontSize:15}}>{entry.order_number}</div>
          <div style={{fontSize:15,color:'#6b7280'}}>{entry.client_name || '—'}</div>
          {entry.client_address && <div style={{fontSize:14,color:'#9ca3af',marginTop:1}}>{entry.client_address}</div>}
        </div>
        <div style={{display:'flex',flexDirection:'column',alignItems:'flex-end',gap:2}}>
          <StatusBadge status={entry.status || 'pending'} />
          {entry.progress && <span style={{fontSize:14,fontWeight:700,color:allDone?'#16a34a':'#d97706'}}>{entry.progress}</span>}
        </div>
      </div>
      {/* SKU codes — bold and prominent */}
      {entry.items && entry.items.length > 0 && (
        <div style={{marginTop:4}}>
          {entry.items.slice(0,4).map((it,i) => (
            <div key={i} style={{fontSize:14,fontFamily:'monospace',fontWeight:800,color:'#07324C',lineHeight:1.3}}>
              {it.sku_code || it.product_name} <span style={{fontWeight:400,color:'#6b7280',fontFamily:'inherit',fontSize:14}}>×{it.quantity}</span>
            </div>
          ))}
          {entry.items.length > 4 && <span style={{fontSize:14,color:'#9ca3af'}}>+{entry.items.length-4} more</span>}
        </div>
      )}
      {entry.load_sequence && <div style={{fontSize:15,color:'#9ca3af',marginTop:3}}>Load #{entry.load_sequence}</div>}
      {/* Estimated time — inline editable */}
      <div style={{marginTop:4,display:'flex',alignItems:'center',gap:4}}>
        {editingMins ? (
          <>
            <input type="number" min="5" step="5"
              style={{width:60,fontSize:14,padding:'2px 4px',borderRadius:4,border:'1px solid #d1d5db'}}
              value={minsVal}
              onChange={e => setMinsVal(e.target.value)}
              onBlur={saveMins}
              onKeyDown={e => e.key === 'Enter' && saveMins()}
              autoFocus />
            <span style={{fontSize:15,color:'#6b7280'}}>min</span>
          </>
        ) : (
          <span
            title="Click to edit estimated time"
            onClick={() => { setEditingMins(true); setMinsVal(entry.estimated_minutes || ''); }}
            style={{fontSize:14,color:'#6366f1',cursor:'pointer',fontWeight:600,userSelect:'none',padding:'1px 4px',borderRadius:3,background:'#eef2ff'}}
          >
            {fmtMinutes(entry.estimated_minutes) || '~?min'}
          </span>
        )}
      </div>
      <div style={{display:'flex',gap:4,marginTop:6}}>
        {!entry.truck_id && (
          <select style={{flex:1,fontSize:14,padding:'3px 6px',borderRadius:4,border:'1px solid #d1d5db'}}
            value={entry.truck_id || ''}
            onChange={e => onAssign(entry.id, parseInt(e.target.value) || null)}>
            <option value="">Assign truck…</option>
            {trucks.map(t => <option key={t.id} value={t.id}>{t.name} — {t.driver_name}</option>)}
          </select>
        )}
        {allDone && (
          <button style={{fontSize:14,padding:'3px 8px',borderRadius:4,background:'#16a34a',color:'white',border:'none',cursor:'pointer',fontWeight:700}}
            onClick={() => onAction(entry.order_id, 'delivered')}>✓ Delivered</button>
        )}
      </div>
    </div>
  );
};

// Collection card
const CollectionCard = ({ order, onAction, onAssignContractor }) => (
  <div style={{
    padding:'8px 10px', marginBottom:6, borderRadius:8,
    border: order.all_finished ? '2px solid #16a34a' : '1px solid #e2e8f0',
    background: order.all_finished ? '#f0fdf4' : '#fffbeb', fontSize:14
  }}>
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
      <div>
        <div style={{fontWeight:800,color:'#07324C',fontSize:15}}>{order.order_number}</div>
        <div style={{fontSize:15,color:'#6b7280'}}>{order.client_name}</div>
      </div>
      <span style={{fontSize:14,fontWeight:700,color:order.all_finished?'#16a34a':'#d97706'}}>{order.progress}</span>
    </div>
    {/* SKU codes */}
    {order.items && order.items.length > 0 && (
      <div style={{marginTop:4}}>
        {order.items.slice(0,3).map((it,i) => (
          <div key={i} style={{fontSize:15,fontFamily:'monospace',fontWeight:800,color:'#07324C',lineHeight:1.3}}>
            {it.sku_code || it.product_name} <span style={{fontWeight:400,color:'#6b7280',fontSize:15}}>&#215;{it.quantity}</span>
          </div>
        ))}
        {order.items.length > 3 && <span style={{fontSize:14,color:'#9ca3af'}}>+{order.items.length-3} more</span>}
      </div>
    )}
    {/* Contractor assignment info */}
    {order.contractor_assignment && (
      <div style={{marginTop:5,padding:'4px 6px',background:'#f0f9ff',border:'1px solid #bae6fd',borderRadius:4}}>
        <div style={{fontSize:15,fontWeight:700,color:'#0369a1',marginBottom:1}}>CONTRACTOR ASSIGNED</div>
        <div style={{fontSize:14,color:'#0c4a6e',fontWeight:600}}>{order.contractor_assignment.contractor_name}</div>
        {order.contractor_assignment.company && <div style={{fontSize:15,color:'#0369a1'}}>{order.contractor_assignment.company}</div>}
        {order.contractor_assignment.phone && <div style={{fontSize:15,color:'#6b7280'}}>{order.contractor_assignment.phone}</div>}
        <div style={{fontSize:15,color:'#6b7280',fontStyle:'italic',marginTop:1}}>
          On behalf of: {order.contractor_assignment.on_behalf_of === 'customer' ? 'Customer' : 'Hyne Pallets'}
        </div>
      </div>
    )}
    <div style={{display:'flex',gap:4,marginTop:6,flexWrap:'wrap'}}>
      {!order.contractor_assignment && onAssignContractor && (
        <button style={{fontSize:15,padding:'3px 7px',borderRadius:4,background:'#7c3aed',color:'white',border:'none',cursor:'pointer',fontWeight:600}}
          onClick={() => onAssignContractor(order)}>+ Contractor</button>
      )}
      {order.all_finished && (
        <>
          <button style={{fontSize:14,padding:'3px 8px',borderRadius:4,background:'#1d4ed8',color:'white',border:'none',cursor:'pointer',fontWeight:600,flex:1}}
            onClick={() => {}}>Notify Customer</button>
          <button style={{fontSize:14,padding:'3px 8px',borderRadius:4,background:'#16a34a',color:'white',border:'none',cursor:'pointer',fontWeight:700,flex:1}}
            onClick={() => onAction(order.id, 'collected')}>&#10003; Collected</button>
        </>
      )}
    </div>
  </div>
);

// ─── CONTRACTOR ASSIGNMENT MODAL ───────────────────────────────
const ContractorAssignmentModal = ({ order, onClose, onSave, token }) => {
  const [form, setForm] = useState({
    contractor_name: '', phone: '', company: '',
    on_behalf_of: 'hyne_pallets', assignment_type: 'collection',
    pickup_address: '', delivery_address: '',
    estimated_minutes: '', cost_estimate: '', notes: ''
  });
  const [saving, setSaving] = useState(false);
  const set = (k,v) => setForm(p => ({...p, [k]:v}));

  const submit = async () => {
    if (!form.contractor_name.trim()) { toast('Contractor name required','error'); return; }
    setSaving(true);
    try {
      await api('/contractor-assignments', {
        method:'POST',
        body: JSON.stringify({ ...form, order_id: order.id })
      }, token);
      toast('Contractor assigned successfully','success');
      onSave();
    } catch(e) { toast(e.message,'error'); }
    setSaving(false);
  };

  return (
    <div className="overlay" onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div className="modal" style={{maxWidth:520}}>
        <h3 style={{fontWeight:900,color:'#07324C',fontSize:18,marginBottom:4}}>Assign Contractor</h3>
        <div style={{fontSize:15,color:'#6b7280',marginBottom:16}}>Order: <strong>{order.order_number}</strong> — {order.client_name}</div>

        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:10}}>
          <div>
            <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Contractor Name *</label>
            <input className="hp-input" value={form.contractor_name} onChange={e=>set('contractor_name',e.target.value)} placeholder="Full name" />
          </div>
          <div>
            <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Phone</label>
            <input className="hp-input" value={form.phone} onChange={e=>set('phone',e.target.value)} placeholder="0400 000 000" />
          </div>
        </div>

        <div style={{marginBottom:10}}>
          <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Company</label>
          <input className="hp-input" value={form.company} onChange={e=>set('company',e.target.value)} placeholder="Company name" />
        </div>

        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:10}}>
          <div>
            <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:5}}>On Behalf Of</label>
            {['hyne_pallets','customer'].map(opt => (
              <label key={opt} style={{display:'flex',alignItems:'center',gap:6,marginBottom:4,cursor:'pointer',fontSize:15}}>
                <input type="radio" name="on_behalf_of" checked={form.on_behalf_of===opt} onChange={()=>set('on_behalf_of',opt)} />
                {opt === 'hyne_pallets' ? 'Hyne Pallets' : 'Customer'}
              </label>
            ))}
          </div>
          <div>
            <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:5}}>Assignment Type</label>
            {['delivery','collection'].map(opt => (
              <label key={opt} style={{display:'flex',alignItems:'center',gap:6,marginBottom:4,cursor:'pointer',fontSize:15}}>
                <input type="radio" name="assignment_type" checked={form.assignment_type===opt} onChange={()=>set('assignment_type',opt)} />
                {opt.charAt(0).toUpperCase()+opt.slice(1)}
              </label>
            ))}
          </div>
        </div>

        <div style={{marginBottom:10}}>
          <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Pickup Address</label>
          <input className="hp-input" value={form.pickup_address} onChange={e=>set('pickup_address',e.target.value)} placeholder="Street address" />
        </div>
        <div style={{marginBottom:10}}>
          <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Delivery Address</label>
          <input className="hp-input" value={form.delivery_address} onChange={e=>set('delivery_address',e.target.value)} placeholder="Street address" />
        </div>

        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:10}}>
          <div>
            <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Est. Minutes</label>
            <input type="number" className="hp-input" value={form.estimated_minutes} onChange={e=>set('estimated_minutes',e.target.value)} placeholder="60" />
          </div>
          <div>
            <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Cost Estimate ($)</label>
            <input type="number" className="hp-input" value={form.cost_estimate} onChange={e=>set('cost_estimate',e.target.value)} placeholder="0.00" />
          </div>
        </div>

        <div style={{marginBottom:16}}>
          <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Notes</label>
          <textarea className="hp-input" rows={2} value={form.notes} onChange={e=>set('notes',e.target.value)} placeholder="Additional instructions..." />
        </div>

        <div style={{display:'flex',gap:10}}>
          <button className="btn btn-primary" style={{flex:1,justifyContent:'center'}} onClick={submit} disabled={saving}>
            {saving ? 'Saving...' : 'Assign Contractor'}
          </button>
          <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
        </div>
      </div>
    </div>
  );
};

// ─── OVER CAPACITY MODAL ──────────────────────────────────────
const DispatchOverCapacityModal = ({ info, onProceed, onCancel }) => {
  const { truckName, dateStr, scheduledMins, capacityMins, overtimeMins, isOverOvertime, addingMins } = info;
  const fmtH = m => { const h=Math.floor(m/60); const min=m%60; return h>0 ? (min>0?`${h}h${min}m`:`${h}h`) : `${min}m`; };
  const newTotal = scheduledMins + addingMins;
  const exceedBy = newTotal - (capacityMins + (overtimeMins||0));

  return (
    <div className="overlay">
      <div className="modal" style={{maxWidth:460}}>
        <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:12}}>
          <div style={{width:36,height:36,borderRadius:'50%',background:'#fef3c7',display:'flex',alignItems:'center',justifyContent:'center',fontSize:20,flexShrink:0}}>&#9888;</div>
          <h3 style={{fontWeight:900,color:'#92400e',fontSize:17,margin:0}}>Over Capacity Warning</h3>
        </div>

        <p style={{fontSize:14,color:'#374151',marginBottom:12,lineHeight:1.5}}>
          Adding this delivery to <strong>{truckName}</strong> on <strong>{dateStr}</strong> will exceed the <strong>{fmtH(capacityMins)}</strong> daily capacity limit.
        </p>

        <div style={{background:'#fef9c3',border:'1px solid #fde68a',borderRadius:8,padding:'10px 14px',marginBottom:14}}>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6,fontSize:15}}>
            <div style={{color:'#6b7280'}}>Current scheduled:</div>
            <div style={{fontWeight:700,color:'#07324C'}}>{fmtH(scheduledMins)}</div>
            <div style={{color:'#6b7280'}}>Adding:</div>
            <div style={{fontWeight:700,color:'#07324C'}}>+{fmtH(addingMins)}</div>
            <div style={{color:'#6b7280'}}>New total:</div>
            <div style={{fontWeight:700,color:'#d97706'}}>{fmtH(newTotal)}</div>
            <div style={{color:'#6b7280'}}>Daily capacity:</div>
            <div style={{fontWeight:700}}>{fmtH(capacityMins)}{overtimeMins?` (+${fmtH(overtimeMins)} OT)`:''}</div>
          </div>
        </div>

        {isOverOvertime ? (
          <p style={{fontSize:15,color:'#dc2626',fontWeight:600,marginBottom:14,background:'#fef2f2',padding:'8px 12px',borderRadius:6,border:'1px solid #fca5a5'}}>
            &#9888; This exceeds even the overtime allowance by <strong>{fmtH(exceedBy)}</strong>. Special approval required.
          </p>
        ) : (
          <p style={{fontSize:15,color:'#d97706',fontWeight:600,marginBottom:14,background:'#fffbeb',padding:'8px 12px',borderRadius:6,border:'1px solid #fde68a'}}>
            This falls within the overtime allowance. Proceeding will incur overtime.
          </p>
        )}

        <div style={{display:'flex',gap:10}}>
          <button className="btn btn-secondary" style={{flex:1,justifyContent:'center'}} onClick={onCancel}>Cancel</button>
          <button
            style={{flex:1,justifyContent:'center',padding:'8px 16px',borderRadius:6,border:'none',cursor:'pointer',fontWeight:700,fontSize:14,
              background: isOverOvertime ? '#dc2626' : '#d97706', color:'white'}}
            onClick={onProceed}
          >
            {isOverOvertime ? 'Proceed (Over Limit)' : 'Proceed with Overtime'}
          </button>
        </div>
      </div>
    </div>
  );
};

// ─── TRUCK WORK ORDER MODAL ──────────────────────────────────
const TruckWorkOrderModal = ({ trucks, onClose, onSave, token }) => {
  const [form, setForm] = useState({
    truck_id: trucks[0]?.id || '', wo_type: 'service', title: '',
    description: '', scheduled_date: localDateStr(),
    estimated_minutes: 60, priority: 'normal'
  });
  const [saving, setSaving] = useState(false);
  const set = (k,v) => setForm(p=>({...p,[k]:v}));

  const submit = async () => {
    if (!form.title.trim()) { toast('Title required','error'); return; }
    if (!form.truck_id) { toast('Select a truck','error'); return; }
    setSaving(true);
    try {
      await api('/truck-work-orders', {method:'POST', body:JSON.stringify(form)}, token);
      toast('Work order created','success');
      onSave();
    } catch(e) { toast(e.message,'error'); }
    setSaving(false);
  };

  return (
    <div className="overlay" onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div className="modal" style={{maxWidth:500}}>
        <h3 style={{fontWeight:900,color:'#07324C',fontSize:18,marginBottom:16}}>Add Asset Work Order</h3>

        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:10}}>
          <div>
            <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Truck *</label>
            <select className="hp-input" value={form.truck_id} onChange={e=>set('truck_id',e.target.value)}>
              <option value="">Select truck...</option>
              {trucks.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}
            </select>
          </div>
          <div>
            <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Type</label>
            <select className="hp-input" value={form.wo_type} onChange={e=>set('wo_type',e.target.value)}>
              {['service','rego','mill_run','alternate_collection','other'].map(t=>(
                <option key={t} value={t}>{t.replace('_',' ').replace(/\b\w/g,c=>c.toUpperCase())}</option>
              ))}
            </select>
          </div>
        </div>

        <div style={{marginBottom:10}}>
          <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Title *</label>
          <input className="hp-input" value={form.title} onChange={e=>set('title',e.target.value)} placeholder="Work order title" />
        </div>

        <div style={{marginBottom:10}}>
          <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Description</label>
          <textarea className="hp-input" rows={2} value={form.description} onChange={e=>set('description',e.target.value)} placeholder="Details..." />
        </div>

        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:10,marginBottom:16}}>
          <div>
            <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Scheduled Date</label>
            <input type="date" className="hp-input" value={form.scheduled_date} onChange={e=>set('scheduled_date',e.target.value)} />
          </div>
          <div>
            <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Est. Minutes</label>
            <input type="number" className="hp-input" value={form.estimated_minutes} onChange={e=>set('estimated_minutes',parseInt(e.target.value)||0)} />
          </div>
          <div>
            <label style={{fontSize:14,fontWeight:700,color:'#374151',display:'block',marginBottom:3}}>Priority</label>
            <select className="hp-input" value={form.priority} onChange={e=>set('priority',e.target.value)}>
              {['low','normal','high','urgent'].map(p=><option key={p} value={p}>{p.charAt(0).toUpperCase()+p.slice(1)}</option>)}
            </select>
          </div>
        </div>

        <div style={{display:'flex',gap:10}}>
          <button className="btn btn-primary" style={{flex:1,justifyContent:'center'}} onClick={submit} disabled={saving}>
            {saving ? 'Creating...' : 'Create Work Order'}
          </button>
          <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
        </div>
      </div>
    </div>
  );
};

const RescheduleWOModal = ({ wo, newDate, newTruckId, trucks, onConfirm, onCancel }) => (
  <div className="overlay" onClick={e=>e.target===e.currentTarget&&onCancel()}>
    <div className="modal" style={{maxWidth:400}}>
      <h3 style={{fontWeight:900,color:'#07324C',fontSize:18,marginBottom:12}}>Reschedule Work Order?</h3>
      <p style={{fontSize:14,color:'#374151',marginBottom:16}}>
        Move <strong>{wo.title}</strong> to <strong>{newDate}</strong>
        {newTruckId && newTruckId !== wo.truck_id ? ` on ${trucks.find(t=>t.id===newTruckId)?.name || ''}` : ''}?
      </p>
      <div style={{display:'flex',gap:10}}>
        <button className="btn btn-secondary" style={{flex:1}} onClick={onCancel}>Cancel</button>
        <button style={{flex:1,padding:'8px 16px',borderRadius:6,border:'none',cursor:'pointer',fontWeight:700,fontSize:14,background:'#1d4ed8',color:'white'}} onClick={onConfirm}>Confirm Reschedule</button>
      </div>
    </div>
  </div>
);

const DispatchDashboard = ({ token }) => {
  // Default: start on today (offset from Monday of current week)
  const [dayOffset, setDayOffset] = useState(() => {
    const now = new Date(); const d = now.getDay();
    return d === 0 ? 6 : d - 1;
  });
  const [numDays, setNumDays] = useState(5);
  const [activeTruck, setActiveTruck] = useState('all'); // 'all' or truck id
  const [subPage, setSubPage] = useState('planning'); // 'planning' | 'runsheet' | 'truckmanager'
  const [planData, setPlanData] = useState(null);
  const [trucks, setTrucks] = useState([]);
  const [loading, setLoading] = useState(true);
  const [runsheetData, setRunsheetData] = useState(null);
  // New state for Truck Manager
  const [truckWOs, setTruckWOs] = useState([]);
  const [capacityConfig, setCapacityConfig] = useState([]);
  const [woModal, setWoModal] = useState(false);
  const [woFilter, setWoFilter] = useState({ truck_id: '', status: '' });
  const [contractorModal, setContractorModal] = useState(null); // order to assign
  const [overCapacityModal, setOverCapacityModal] = useState(null); // {info, pendingDrop}
  const [rescheduleWOModal, setRescheduleWOModal] = useState(null); // {wo, newDate, newTruckId}

  // dayOffset pattern — Monday anchor + raw day offset
  const getStartDate = () => {
    const now = new Date();
    const day = now.getDay();
    const mon = new Date(now);
    mon.setDate(now.getDate() - (day === 0 ? 6 : day - 1) + dayOffset);
    mon.setHours(0,0,0,0);
    return mon;
  };
  const snapToToday = () => {
    const now = new Date();
    const day = now.getDay();
    const mondayOfThisWeek = new Date(now);
    mondayOfThisWeek.setDate(now.getDate() - (day === 0 ? 6 : day - 1));
    mondayOfThisWeek.setHours(0,0,0,0);
    const todayMidnight = new Date(now); todayMidnight.setHours(0,0,0,0);
    const diffDays = Math.floor((todayMidnight - mondayOfThisWeek) / 86400000);
    setDayOffset(diffDays);
  };
  const fmtDate = d => {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  };

  const weekStart = getStartDate();
  const endDate = new Date(weekStart.getTime() + (numDays-1)*86400000);
  const weekLabel = weekStart.toLocaleDateString('en-AU', {day:'numeric', month:'short'}) +
    ' — ' + endDate.toLocaleDateString('en-AU', {day:'numeric', month:'short', year:'numeric'});

  const loadRef = useRef(null);
  loadRef.current = async () => {
    setLoading(true);
    try {
      const ws = fmtDate(weekStart);
      const we = fmtDate(endDate);
      const truckParam = activeTruck !== 'all' ? `&truck_id=${activeTruck}` : '';
      const [plan, truckList, runsheet, wos, capConfig] = await Promise.all([
        api(`/dispatch-planning?date_from=${ws}&date_to=${we}${truckParam}`, {}, token),
        api('/trucks', {}, token),
        subPage === 'runsheet' ? api(`/dispatch-runsheet?date_from=${ws}&date_to=${we}`, {}, token) : Promise.resolve(null),
        subPage === 'truckmanager' ? api('/truck-work-orders', {}, token).catch(()=>[]) : Promise.resolve(null),
        subPage === 'truckmanager' ? api('/truck-capacity', {}, token).catch(()=>[]) : Promise.resolve(null),
      ]);
      setPlanData(plan);
      setTrucks(truckList);
      if (runsheet) setRunsheetData(runsheet);
      if (wos) setTruckWOs(wos);
      if (capConfig) setCapacityConfig(capConfig);
    } catch(e) { toast(e.message, 'error'); }
    setLoading(false);
  };

  useEffect(() => { loadRef.current(); }, [dayOffset, numDays, activeTruck, token, subPage]);
  const reload = () => loadRef.current();

  // Assign truck to a delivery_log entry
  const assignTruck = async (dlId, truckId) => {
    try {
      await api('/dispatch-assign', {
        method:'PUT',
        body: JSON.stringify({ delivery_log_id: dlId, truck_id: truckId })
      }, token);
      toast('Truck assigned','success');
      reload();
    } catch(e) { toast(e.message,'error'); }
  };

  // Move delivery date via drag (change expected_date)
  const moveDelivery = async (dlId, newDate) => {
    try {
      await api('/dispatch-assign', {
        method:'PUT',
        body: JSON.stringify({ delivery_log_id: dlId, expected_date: newDate })
      }, token);
      toast('Moved to ' + newDate,'success');
      reload();
    } catch(e) { toast(e.message,'error'); }
  };

  // Status action (delivered / collected)
  const statusAction = async (orderId, newStatus) => {
    try {
      await api(`/orders/${orderId}/status`, {method:'PUT',body:JSON.stringify({status:newStatus})}, token);
      toast(`Marked as ${newStatus}`,'success');
      reload();
    } catch(e) { toast(e.message,'error'); }
  };

  // Assign truck + date via drop from unassigned queue
  const doAssignDrop = async (dateStr, truckId, dragData) => {
    const body = { delivery_log_id: dragData.dl_id };
    if (truckId) body.truck_id = truckId;
    body.expected_date = dateStr;
    await api('/dispatch-assign', {method:'PUT', body: JSON.stringify(body)}, token);
    toast(`Assigned to ${dateStr}`, 'success');
    reload();
  };

  const handleDrop = async (dateStr, truckId, e) => {
    e.preventDefault();
    try {
      const raw = e.dataTransfer.getData('text/plain');
      if (!raw) return;
      const dragData = JSON.parse(raw);

      // Handle truck WO reschedule
      if (dragData.type === 'truck_wo') {
        setRescheduleWOModal({ wo: dragData.wo, newDate: dateStr, newTruckId: truckId });
        return;
      }

      if (!dragData.dl_id) return;

      // Check capacity
      const dayData = planData?.days?.find(d => d.date === dateStr);
      const slot = dayData?.truck_slots?.[truckId];
      const cap = slot?.capacity;
      if (cap && cap.capacity_minutes > 0) {
        const addMins = dragData.estimated_minutes || 30;
        const newTotal = (cap.scheduled_minutes || 0) + addMins;
        const totalAllowance = cap.capacity_minutes + (cap.overtime_minutes || 0);
        if (newTotal > cap.capacity_minutes) {
          const truck = allTrucks.find(t => t.id === truckId || String(t.id) === String(truckId));
          setOverCapacityModal({
            info: {
              truckName: truck?.name || 'Truck',
              dateStr,
              scheduledMins: cap.scheduled_minutes || 0,
              capacityMins: cap.capacity_minutes,
              overtimeMins: cap.overtime_minutes || 0,
              isOverOvertime: newTotal > totalAllowance,
              addingMins: addMins
            },
            pendingDrop: { dateStr, truckId, dragData }
          });
          return;
        }
      }

      await doAssignDrop(dateStr, truckId, dragData);
    } catch(err) { toast(err.message, 'error'); }
  };

  // ─── RUN SHEET SUB-PAGE ───
  if (subPage === 'runsheet') {
    return (
      <div style={{display:'flex',flexDirection:'column',height:'calc(100vh - 56px)',overflow:'hidden'}}>
        {/* Toolbar — Row 1: Sub-page tabs */}
        <div style={{background:'#07324C',padding:'10px 16px 0',display:'flex',alignItems:'center',gap:12,flexShrink:0}}>
          <div style={{color:'white',fontWeight:900,fontSize:18,marginRight:4}}>Dispatch</div>
          <div style={{display:'flex',gap:0,borderBottom:'none'}}>
            {[{id:'planning',label:'Planning'},{id:'runsheet',label:'Run Sheet'},{id:'truckmanager',label:'Truck Manager'}].map(tab => (
              <button key={tab.id} onClick={() => setSubPage(tab.id)} style={{
                padding:'8px 18px',border:'none',cursor:'pointer',fontSize:14,fontWeight:700,
                borderRadius:'6px 6px 0 0',
                background: subPage===tab.id ? 'white' : 'transparent',
                color: subPage===tab.id ? '#07324C' : 'rgba(255,255,255,0.8)',
                marginRight:2
              }}>{tab.label}</button>
            ))}
          </div>
        </div>
        {/* Toolbar — Row 2: Context controls */}
        <div style={{background:'#0a4163',padding:'8px 16px',display:'flex',alignItems:'center',gap:10,flexShrink:0,flexWrap:'wrap'}}>
          <button onClick={() => setDayOffset(d=>d-numDays)} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 10px',cursor:'pointer',fontSize:14,fontWeight:700}}>‹ Prev</button>
          <span style={{color:'white',fontSize:15,fontWeight:600,minWidth:180,textAlign:'center'}}>{weekLabel}</span>
          <button onClick={() => setDayOffset(d=>d+numDays)} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 10px',cursor:'pointer',fontSize:14,fontWeight:700}}>Next ›</button>
          <button onClick={snapToToday} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 10px',cursor:'pointer',fontSize:15}}>Today</button>
          <select value={numDays} onChange={e => setNumDays(parseInt(e.target.value))} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 8px',cursor:'pointer',fontSize:15}}>
            {[1,2,3,4,5,6,7].map(n=><option key={n} value={n} style={{color:'#07324C'}}>{n} Day{n>1?'s':''}</option>)}
          </select>
          <button onClick={reload} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 10px',cursor:'pointer',fontSize:15}}>↺ Refresh</button>
        </div>

        {loading ? <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center'}}><Spinner /></div> : (
          <div style={{flex:1,overflow:'auto',padding:16}}>
            {/* Run Sheet: days across top, each day shows trucks stacked */}
            {(runsheetData?.days || []).map(day => (
              <div key={day.date} style={{marginBottom:24}}>
                <div style={{background:'#07324C',color:'white',padding:'8px 14px',borderRadius:'8px 8px 0 0',fontSize:16,fontWeight:800}}>
                  {day.day_label}
                </div>
                {day.truck_runs.length === 0 ? (
                  <div style={{padding:16,background:'#f8fafc',border:'1px solid #e2e8f0',borderTop:'none',borderRadius:'0 0 8px 8px',color:'#9ca3af',fontSize:14,textAlign:'center'}}>
                    No deliveries scheduled
                  </div>
                ) : (
                  <div style={{display:'grid',gridTemplateColumns:`repeat(${Math.min(day.truck_runs.length, 4)}, 1fr)`,gap:0,border:'1px solid #e2e8f0',borderTop:'none',borderRadius:'0 0 8px 8px',overflow:'hidden'}}>
                    {day.truck_runs.map((tr,ti) => (
                      <div key={tr.truck.id} style={{borderRight: ti < day.truck_runs.length-1 ? '1px solid #e2e8f0' : 'none'}}>
                        <div style={{background:'#f1f5f9',padding:'6px 10px',borderBottom:'1px solid #e2e8f0',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                          <div>
                            <span style={{fontWeight:800,fontSize:14,color:'#07324C'}}>{tr.truck.name}</span>
                            <span style={{fontSize:14,color:'#6b7280',marginLeft:6}}>{tr.truck.driver_name} — {tr.truck.rego}</span>
                          </div>
                          <span style={{fontSize:14,fontWeight:700,color:'#1d4ed8'}}>{tr.deliveries.length} stop{tr.deliveries.length!==1?'s':''}</span>
                        </div>
                        <div style={{padding:8}}>
                          {tr.deliveries.map((del, di) => (
                            <div key={del.id} style={{padding:'6px 8px',marginBottom:4,borderRadius:6,border:'1px solid #e2e8f0',background:'white',fontSize:15}}>
                              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                <div>
                                  <span style={{fontWeight:700,color:'#07324C',marginRight:6}}>#{di+1}</span>
                                  <span style={{fontWeight:700}}>{del.order_number}</span>
                                </div>
                                <StatusBadge status={del.status || 'pending'} />
                              </div>
                              <div style={{fontSize:14,color:'#6b7280',marginTop:2}}>{del.client_name}</div>
                              {del.client_address && <div style={{fontSize:15,color:'#9ca3af'}}>{del.client_address}</div>}
                              {del.items && del.items.length > 0 && (
                                <div style={{marginTop:3}}>
                                  {del.items.map((it,ii)=>(
                                    <div key={ii} style={{fontSize:15,fontFamily:'monospace',fontWeight:800,color:'#07324C',lineHeight:1.3}}>{it.sku_code||it.product_name} <span style={{fontWeight:400,color:'#6b7280',fontSize:15}}>×{it.quantity}</span></div>
                                  ))}
                                </div>
                              )}
                              {del.special_instructions && <div style={{fontSize:15,color:'#d97706',marginTop:2,fontStyle:'italic'}}>{del.special_instructions}</div>}
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    );
  }

  // ─── TRUCK MANAGER SUB-PAGE ───
  if (subPage === 'truckmanager') {
    const DAYS_OF_WEEK = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const filteredWOs = truckWOs.filter(wo => {
      if (woFilter.truck_id && String(wo.truck_id) !== woFilter.truck_id) return false;
      if (woFilter.status && wo.status !== woFilter.status) return false;
      return true;
    });
    const tmTrucks = planData?.trucks || trucks;

    const markWOStatus = async (woId, status) => {
      try {
        await api(`/truck-work-orders/${woId}`, {method:'PUT', body:JSON.stringify({status})}, token);
        toast(`Work order ${status}`,'success');
        // reload truck WOs
        api('/truck-work-orders', {}, token).then(setTruckWOs).catch(()=>{});
      } catch(e) { toast(e.message,'error'); }
    };

    const saveCapacity = async (truckId, dayOfWeek, field, value) => {
      try {
        await api('/truck-capacity', {
          method:'PUT',
          body: JSON.stringify({ truck_id: truckId, day_of_week: dayOfWeek, [field]: parseInt(value)||0 })
        }, token);
        toast('Capacity saved','success');
        api('/truck-capacity', {}, token).then(setCapacityConfig).catch(()=>{});
      } catch(e) { toast(e.message,'error'); }
    };

    const getCapVal = (truckId, dayIdx, field) => {
      const entry = capacityConfig.find(c => c.truck_id === truckId && c.day_of_week === dayIdx);
      return entry?.[field] ?? (field === 'capacity_minutes' ? 480 : 0);
    };

    const priBadgeStyle = (p) => ({
      display:'inline-block',padding:'1px 5px',borderRadius:3,fontSize:10,fontWeight:700,
      background: p==='urgent'?'#fee2e2':p==='high'?'#fff3cd':p==='low'?'#f3f4f6':'#e0f2fe',
      color: p==='urgent'?'#dc2626':p==='high'?'#d97706':p==='low'?'#6b7280':'#0369a1'
    });

    return (
      <div style={{display:'flex',flexDirection:'column',height:'calc(100vh - 56px)',overflow:'hidden'}}>
        {/* Toolbar — Row 1: Sub-page tabs */}
        <div style={{background:'#07324C',padding:'10px 16px 0',display:'flex',alignItems:'center',gap:12,flexShrink:0}}>
          <div style={{color:'white',fontWeight:900,fontSize:18,marginRight:4}}>Dispatch</div>
          <div style={{display:'flex',gap:0,borderBottom:'none'}}>
            {[{id:'planning',label:'Planning'},{id:'runsheet',label:'Run Sheet'},{id:'truckmanager',label:'Truck Manager'}].map(tab => (
              <button key={tab.id} onClick={() => setSubPage(tab.id)} style={{
                padding:'8px 18px',border:'none',cursor:'pointer',fontSize:14,fontWeight:700,
                borderRadius:'6px 6px 0 0',
                background: subPage===tab.id ? 'white' : 'transparent',
                color: subPage===tab.id ? '#07324C' : 'rgba(255,255,255,0.8)',
                marginRight:2
              }}>{tab.label}</button>
            ))}
          </div>
          <div style={{flex:1}}></div>
          <button onClick={reload} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 10px',cursor:'pointer',fontSize:15,marginBottom:6}}>↺ Refresh</button>
        </div>

        {loading ? <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center'}}><Spinner /></div> : (
          <div style={{flex:1,overflow:'auto',padding:16,display:'flex',flexDirection:'column',gap:20}}>

            {/* ── TRUCK ASSET WORK ORDERS ── */}
            <div style={{background:'white',borderRadius:10,border:'1px solid #e2e8f0',overflow:'hidden'}}>
              <div style={{background:'#07324C',color:'white',padding:'10px 16px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <div style={{fontWeight:800,fontSize:15}}>&#128295; Truck Asset Work Orders</div>
                <button
                  style={{background:'#ED1C24',color:'white',border:'none',borderRadius:6,padding:'5px 12px',cursor:'pointer',fontWeight:700,fontSize:15}}
                  onClick={() => setWoModal(true)}>+ Add Work Order</button>
              </div>

              {/* Filters */}
              <div style={{padding:'8px 14px',background:'#f8fafc',borderBottom:'1px solid #e2e8f0',display:'flex',gap:10,flexWrap:'wrap'}}>
                <select style={{fontSize:15,padding:'4px 8px',borderRadius:5,border:'1px solid #d1d5db'}}
                  value={woFilter.truck_id} onChange={e=>setWoFilter(p=>({...p,truck_id:e.target.value}))}>
                  <option value="">All Trucks</option>
                  {tmTrucks.map(t=><option key={t.id} value={String(t.id)}>{t.name}</option>)}
                </select>
                <select style={{fontSize:15,padding:'4px 8px',borderRadius:5,border:'1px solid #d1d5db'}}
                  value={woFilter.status} onChange={e=>setWoFilter(p=>({...p,status:e.target.value}))}>
                  <option value="">All Status</option>
                  {['pending','in_progress','completed','cancelled'].map(s=><option key={s} value={s}>{s}</option>)}
                </select>
              </div>

              {filteredWOs.length === 0 ? (
                <div style={{padding:'32px 20px',textAlign:'center',color:'#9ca3af',fontSize:14}}>
                  No work orders found
                </div>
              ) : (
                <div style={{overflowX:'auto'}}>
                  <table style={{width:'100%',borderCollapse:'collapse',fontSize:15}}>
                    <thead>
                      <tr style={{background:'#f1f5f9',borderBottom:'2px solid #e2e8f0'}}>
                        {['Truck','Type','Title','Scheduled','Est. Time','Priority','Status','Actions'].map(h=>(
                          <th key={h} style={{padding:'8px 12px',fontWeight:700,color:'#374151',textAlign:'left',fontSize:14,textTransform:'uppercase',letterSpacing:'0.05em'}}>{h}</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {filteredWOs.map(wo => {
                        const woTruck = tmTrucks.find(t=>t.id===wo.truck_id);
                        const statusColor = wo.status==='completed'?'#16a34a':wo.status==='cancelled'?'#6b7280':wo.status==='in_progress'?'#1d4ed8':'#d97706';
                        return (
                          <tr key={wo.id} style={{borderBottom:'1px solid #f1f5f9',background:wo.status==='completed'?'#f0fdf4':wo.status==='cancelled'?'#f9fafb':'white'}}>
                            <td style={{padding:'8px 12px',fontWeight:700,color:'#07324C'}}>{woTruck?.name||'—'}</td>
                            <td style={{padding:'8px 12px'}}>
                              <span style={{fontSize:15,fontWeight:700,color:'#c2410c',background:'#fed7aa',padding:'2px 6px',borderRadius:3,textTransform:'capitalize'}}>{(wo.wo_type||'').replace('_',' ')}</span>
                            </td>
                            <td style={{padding:'8px 12px',fontWeight:600}}>{wo.title}</td>
                            <td style={{padding:'8px 12px',color:'#6b7280'}}>{wo.scheduled_date||'—'}</td>
                            <td style={{padding:'8px 12px',color:'#6b7280'}}>{wo.estimated_minutes>0 ? `${wo.estimated_minutes}min` : '—'}</td>
                            <td style={{padding:'8px 12px'}}><span style={priBadgeStyle(wo.priority)}>{wo.priority}</span></td>
                            <td style={{padding:'8px 12px'}}><span style={{fontSize:14,fontWeight:700,color:statusColor,textTransform:'capitalize'}}>{wo.status}</span></td>
                            <td style={{padding:'8px 12px'}}>
                              <div style={{display:'flex',gap:4}}>
                                {wo.status !== 'completed' && wo.status !== 'cancelled' && (
                                  <button style={{fontSize:15,padding:'2px 7px',borderRadius:4,background:'#16a34a',color:'white',border:'none',cursor:'pointer',fontWeight:600}}
                                    onClick={()=>markWOStatus(wo.id,'completed')}>&#10003; Done</button>
                                )}
                                {wo.status !== 'cancelled' && wo.status !== 'completed' && (
                                  <button style={{fontSize:15,padding:'2px 7px',borderRadius:4,background:'#6b7280',color:'white',border:'none',cursor:'pointer',fontWeight:600}}
                                    onClick={()=>markWOStatus(wo.id,'cancelled')}>Cancel</button>
                                )}
                              </div>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              )}
            </div>

            {/* ── TRUCK CAPACITY CONFIG ── */}
            <div style={{background:'white',borderRadius:10,border:'1px solid #e2e8f0',overflow:'hidden',marginBottom:20}}>
              <div style={{background:'#07324C',color:'white',padding:'10px 16px'}}>
                <div style={{fontWeight:800,fontSize:15}}>&#128336; Truck Capacity Config</div>
                <div style={{fontSize:14,opacity:0.8,marginTop:2}}>Capacity minutes per truck per day (default 480 = 8h). 0 = closed.</div>
              </div>
              <div style={{overflowX:'auto'}}>
                <table style={{width:'100%',borderCollapse:'collapse',fontSize:15}}>
                  <thead>
                    <tr style={{background:'#f1f5f9',borderBottom:'2px solid #e2e8f0'}}>
                      <th style={{padding:'8px 12px',fontWeight:700,color:'#374151',textAlign:'left',minWidth:100}}>Truck</th>
                      {DAYS_OF_WEEK.map(d=>(
                        <th key={d} style={{padding:'8px 10px',fontWeight:700,color:'#374151',textAlign:'center',minWidth:90,fontSize:14}}>{d}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {tmTrucks.map(truck => (
                      <tr key={truck.id} style={{borderBottom:'1px solid #f1f5f9'}}>
                        <td style={{padding:'8px 12px',fontWeight:700,color:'#07324C'}}>{truck.name}<br/><span style={{fontSize:15,color:'#6b7280',fontWeight:400}}>{truck.driver_name}</span></td>
                        {DAYS_OF_WEEK.map((d,di) => {
                          const capVal = getCapVal(truck.id, di, 'capacity_minutes');
                          const otVal = getCapVal(truck.id, di, 'overtime_minutes');
                          const isClosed = capVal === 0;
                          const isDefault = capVal === 480;
                          const bgColor = isClosed ? '#f3f4f6' : isDefault ? 'white' : '#eff6ff';
                          return (
                            <td key={d} style={{padding:'4px 6px',textAlign:'center',background:bgColor,verticalAlign:'middle'}}>
                              <input
                                type="number"
                                min="0"
                                step="30"
                                title="Capacity minutes (0=closed)"
                                style={{
                                  width:60, textAlign:'center', fontSize:14, padding:'2px 4px',
                                  borderRadius:4, border:'1px solid #d1d5db',
                                  background: isClosed ? '#e5e7eb' : 'white',
                                  color: isClosed ? '#9ca3af' : '#07324C', fontWeight:600
                                }}
                                defaultValue={capVal}
                                onBlur={e => saveCapacity(truck.id, di, 'capacity_minutes', e.target.value)}
                              />
                              <div style={{marginTop:2}}>
                                <input
                                  type="number"
                                  min="0"
                                  step="30"
                                  title="Overtime minutes"
                                  style={{width:48,textAlign:'center',fontSize:10,padding:'1px 3px',borderRadius:3,border:'1px solid #e9d5ff',color:'#7c3aed',background:'#faf5ff'}}
                                  defaultValue={otVal}
                                  onBlur={e => saveCapacity(truck.id, di, 'overtime_minutes', e.target.value)}
                                />
                                <div style={{fontSize:9,color:'#9ca3af'}}>OT</div>
                              </div>
                            </td>
                          );
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div style={{padding:'8px 14px',background:'#f8fafc',borderTop:'1px solid #e2e8f0',display:'flex',gap:16,fontSize:15,color:'#6b7280'}}>
                <span>&#9632; Grey = Closed (0 min)</span>
                <span>&#9632; White = Default (480 min / 8h)</span>
                <span style={{color:'#3b82f6'}}>&#9632; Blue = Custom value</span>
                <span style={{color:'#7c3aed'}}>Purple = Overtime allowance</span>
              </div>
            </div>
          </div>
        )}

        {/* Work Order Create Modal */}
        {woModal && (
          <TruckWorkOrderModal
            trucks={tmTrucks}
            token={token}
            onClose={() => setWoModal(false)}
            onSave={() => {
              setWoModal(false);
              api('/truck-work-orders', {}, token).then(setTruckWOs).catch(()=>{});
            }}
          />
        )}
      </div>
    );
  }

  // ─── MAIN PLANNING VIEW ───
  const days = planData?.days || [];
  const allTrucks = planData?.trucks || trucks;
  const unassigned = planData?.unassigned || [];
  const unschedCollections = planData?.collections_unscheduled || [];
  // Filter trucks if a tab is selected
  const displayTrucks = activeTruck === 'all' ? allTrucks : allTrucks.filter(t => t.id === parseInt(activeTruck));

  return (
    <div style={{display:'flex',flexDirection:'column',height:'calc(100vh - 56px)',overflow:'hidden'}}>
      {/* Toolbar — Row 1: Sub-page tabs */}
      <div style={{background:'#07324C',padding:'10px 16px 0',display:'flex',alignItems:'center',gap:12,flexShrink:0}}>
        <div style={{color:'white',fontWeight:900,fontSize:18,marginRight:4}}>Dispatch</div>
        <div style={{display:'flex',gap:0,borderBottom:'none'}}>
          {[{id:'planning',label:'Planning'},{id:'runsheet',label:'Run Sheet'},{id:'truckmanager',label:'Truck Manager'}].map(tab => (
            <button key={tab.id} onClick={() => setSubPage(tab.id)} style={{
              padding:'8px 18px',border:'none',cursor:'pointer',fontSize:14,fontWeight:700,
              borderRadius:'6px 6px 0 0',
              background: subPage===tab.id ? 'white' : 'transparent',
              color: subPage===tab.id ? '#07324C' : 'rgba(255,255,255,0.8)',
              marginRight:2
            }}>{tab.label}</button>
          ))}
        </div>
      </div>
      {/* Toolbar — Row 2: Context controls */}
      <div style={{background:'#0a4163',padding:'8px 16px',display:'flex',alignItems:'center',gap:10,flexShrink:0,flexWrap:'wrap'}}>
        {/* Truck filter tabs */}
        <div style={{display:'flex',gap:2,background:'rgba(255,255,255,0.1)',borderRadius:6,padding:2}}>
          <button onClick={() => setActiveTruck('all')} style={{
            padding:'4px 10px',borderRadius:5,border:'none',cursor:'pointer',fontSize:14,fontWeight:700,
            background: activeTruck==='all' ? '#ED1C24' : 'transparent',
            color: activeTruck==='all' ? 'white' : 'rgba(255,255,255,0.8)'
          }}>All Trucks</button>
          {allTrucks.map(t => (
            <button key={t.id} onClick={() => setActiveTruck(String(t.id))} style={{
              padding:'4px 10px',borderRadius:5,border:'none',cursor:'pointer',fontSize:14,fontWeight:700,
              background: activeTruck===String(t.id) ? '#ED1C24' : 'transparent',
              color: activeTruck===String(t.id) ? 'white' : 'rgba(255,255,255,0.8)'
            }}>{t.name}</button>
          ))}
        </div>

        <div style={{borderLeft:'1px solid rgba(255,255,255,0.2)',height:20,margin:'0 4px'}}></div>

        {/* Day nav */}
        <button onClick={() => setDayOffset(d=>d-numDays)} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 10px',cursor:'pointer',fontSize:14,fontWeight:700}}>‹ Prev</button>
        <span style={{color:'white',fontSize:15,fontWeight:600,minWidth:180,textAlign:'center'}}>{weekLabel}</span>
        <button onClick={() => setDayOffset(d=>d+numDays)} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 10px',cursor:'pointer',fontSize:14,fontWeight:700}}>Next ›</button>
        <button onClick={snapToToday} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 10px',cursor:'pointer',fontSize:15}}>Today</button>
        <select value={numDays} onChange={e => setNumDays(parseInt(e.target.value))} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 8px',cursor:'pointer',fontSize:15}}>
          {[1,2,3,4,5,6,7].map(n=><option key={n} value={n} style={{color:'#07324C'}}>{n} Day{n>1?'s':''}</option>)}
        </select>

        <button onClick={reload} style={{background:'rgba(255,255,255,0.15)',border:'none',color:'white',borderRadius:5,padding:'4px 10px',cursor:'pointer',fontSize:15}}>↺ Refresh</button>
      </div>

      {loading ? (
        <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center'}}><Spinner /></div>
      ) : (
        <div style={{flex:1,display:'flex',overflow:'hidden'}}>

          {/* LEFT: Deliveries Queue (unassigned) */}
          <div style={{width:220,flexShrink:0,background:'#f8fafc',borderRight:'2px solid #e2e8f0',display:'flex',flexDirection:'column',overflow:'hidden'}}>
            <div style={{background:'#07324C',color:'white',padding:'8px 10px',fontSize:15,fontWeight:700,flexShrink:0}}>
              Deliveries Queue
            </div>
            <div style={{padding:'6px 8px',background:'#f1f5f9',borderBottom:'1px solid #e2e8f0',flexShrink:0}}>
              <div style={{fontSize:14,color:'#6b7280',lineHeight:1.4}}>Unassigned delivery orders — drag to a truck/day slot</div>
              <div style={{fontSize:14,color:'#374151',fontWeight:600,marginTop:3}}>{unassigned.length} item{unassigned.length!==1?'s':''}</div>
            </div>
            <div style={{flex:1,overflowY:'auto',padding:'6px 8px'}}>
              {unassigned.length === 0 ? (
                <div style={{textAlign:'center',color:'#9ca3af',fontSize:15,padding:'24px 8px'}}>
                  <div style={{fontSize:24,marginBottom:8}}>✓</div>
                  All deliveries assigned
                </div>
              ) : unassigned.map(entry => (
                <DispatchCard key={entry.id} entry={entry} trucks={allTrucks} onAssign={assignTruck} onAction={statusAction} token={token} />
              ))}
            </div>
          </div>

          {/* MIDDLE: Day columns with truck rows */}
          <div style={{flex:1,overflowX:'auto',overflowY:'auto'}}>
            <div style={{display:'flex',minWidth: days.length * 260}}>
              {days.map(day => {
                const isToday = day.date === localDateStr();
                return (
                  <div key={day.date} style={{flex:'1 0 260px',borderRight:'1px solid #e2e8f0',display:'flex',flexDirection:'column'}}>
                    {/* Day header */}
                    <div style={{
                      background: isToday ? '#ED1C24' : '#f1f5f9',
                      color: isToday ? 'white' : '#07324C',
                      padding:'8px 10px', fontSize:14, fontWeight:800,
                      borderBottom:'2px solid #e2e8f0', flexShrink:0, textAlign:'center'
                    }}>
                      {day.day_label}
                    </div>

                    {/* Truck rows for this day */}
                    {displayTrucks.map(truck => {
                      const slot = day.truck_slots?.[truck.id];
                      const entries = slot?.entries || [];
                      const cap = slot?.capacity;
                      const woCards = slot?.truck_work_orders || [];
                      const scheduledMins = cap?.scheduled_minutes || 0;
                      const capacityMins = cap?.capacity_minutes || 0;
                      const overtimeMins = cap?.overtime_minutes || 0;
                      const capPct = capacityMins > 0 ? Math.min((scheduledMins / capacityMins) * 100, 100) : 0;
                      const isOverCap = scheduledMins > capacityMins;
                      const isInOT = scheduledMins > capacityMins && scheduledMins <= (capacityMins + overtimeMins);
                      const barColor = isOverCap ? (isInOT ? '#f59e0b' : '#dc2626') : '#22c55e';
                      const fmtCap = m => { if(!m) return '?'; const h=Math.floor(m/60); const min=m%60; return h>0?(min>0?`${h}h${min}m`:`${h}h`):`${min}m`; };
                      return (
                        <div key={truck.id}
                          onDragOver={e => e.preventDefault()}
                          onDrop={e => handleDrop(day.date, truck.id, e)}
                          style={{borderBottom:'1px solid #f1f5f9',minHeight:60}}
                        >
                          <div style={{background:'#f8fafc',padding:'4px 8px',fontSize:14,fontWeight:700,color:'#07324C',borderBottom:'1px solid #e2e8f0'}}>
                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom: capacityMins>0 ? 3 : 0}}>
                              <span>{truck.name} <span style={{fontWeight:400,color:'#6b7280'}}>— {truck.driver_name}</span></span>
                              <span style={{fontWeight:700,color:isOverCap?'#dc2626':'#1d4ed8',fontSize:15}}>
                                {(entries.length > 0 || woCards.length > 0) ? `${entries.length}+${woCards.length}` : ''}
                              </span>
                            </div>
                            {capacityMins > 0 && (
                              <div>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:2}}>
                                  <span style={{fontSize:10,color: isOverCap ? '#dc2626' : '#6b7280',fontWeight:isOverCap?700:400}}>
                                    {fmtCap(scheduledMins)} / {fmtCap(capacityMins)}{overtimeMins>0?` (+${fmtCap(overtimeMins)} OT)`:''}
                                  </span>
                                </div>
                                <div style={{height:4,background:'#e5e7eb',borderRadius:2,overflow:'hidden'}}>
                                  <div style={{height:'100%',width:`${capPct}%`,background:barColor,borderRadius:2,transition:'width 0.3s'}} />
                                </div>
                              </div>
                            )}
                          </div>
                          <div style={{padding:4,minHeight:40}}>
                            {/* Truck Work Order cards */}
                            {woCards.map(wo => {
                              const woPriColor = wo.priority==='urgent'?'#dc2626':wo.priority==='high'?'#d97706':wo.priority==='low'?'#6b7280':'#07324C';
                              const woStatusColor = wo.status==='completed'?'#16a34a':wo.status==='cancelled'?'#6b7280':'#d97706';
                              return (
                                <div key={wo.id}
                                  draggable
                                  onDragStart={e => e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'truck_wo', wo }))}
                                  style={{padding:'5px 8px',marginBottom:4,borderRadius:6,border:'2px dashed #f97316',background:'#fff7ed',fontSize:14,cursor:'grab'}}>
                                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',gap:4}}>
                                    <div>
                                      <span style={{fontSize:15,fontWeight:700,color:'#c2410c',textTransform:'uppercase',background:'#fed7aa',padding:'1px 4px',borderRadius:3,marginRight:4}}>{(wo.wo_type||'').replace('_',' ')}</span>
                                      <span style={{fontWeight:700,color:'#07324C'}}>{wo.title}</span>
                                    </div>
                                    <span style={{fontSize:10,fontWeight:700,color:woStatusColor,flexShrink:0}}>{wo.status}</span>
                                  </div>
                                  <div style={{display:'flex',gap:6,marginTop:2,alignItems:'center'}}>
                                    {wo.estimated_minutes > 0 && <span style={{fontSize:10,color:'#6b7280'}}>{fmtCap(wo.estimated_minutes)}</span>}
                                    <span style={{fontSize:10,fontWeight:700,color:woPriColor}}>{wo.priority}</span>
                                  </div>
                                </div>
                              );
                            })}
                            {entries.map(entry => (
                              <DispatchCard key={entry.id} entry={entry} trucks={allTrucks} onAssign={assignTruck} onAction={statusAction} token={token} />
                            ))}
                          </div>
                        </div>
                      );
                    })}

                    {/* Day incoming production */}
                    {day.incoming && day.incoming.length > 0 && (
                      <div style={{borderTop:'2px solid #f59e0b',padding:6}}>
                        <div style={{fontSize:15,fontWeight:700,color:'#d97706',marginBottom:4,textTransform:'uppercase'}}>Incoming ({day.incoming.length})</div>
                        {day.incoming.map(o => (
                          <div key={o.id} style={{fontSize:14,padding:'3px 6px',background:'#fffbeb',borderRadius:4,marginBottom:3,border:'1px solid #fde68a'}}>
                            <span style={{fontWeight:700,color:'#07324C'}}>{o.order_number}</span>
                            <span style={{color:'#6b7280',marginLeft:4}}>{o.client_name}</span>
                            <span style={{color:'#d97706',marginLeft:4,fontWeight:600}}>{o.progress}</span>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>

          {/* RIGHT: Collections Queue */}
          <div style={{width:220,flexShrink:0,background:'#fffbeb',borderLeft:'2px solid #e2e8f0',display:'flex',flexDirection:'column',overflow:'hidden'}}>
            <div style={{background:'#92400e',color:'white',padding:'8px 10px',fontSize:15,fontWeight:700,flexShrink:0}}>
              Collections
            </div>
            <div style={{padding:'6px 8px',background:'#fef3c7',borderBottom:'1px solid #fde68a',flexShrink:0}}>
              <div style={{fontSize:14,color:'#92400e',lineHeight:1.4}}>Awaiting customer pickup</div>
              <div style={{fontSize:14,color:'#78350f',fontWeight:600,marginTop:3}}>
                {(unschedCollections.length + (days.reduce((sum,d) => sum + (d.collections?.length||0), 0)))} total
              </div>
            </div>
            <div style={{flex:1,overflowY:'auto',padding:'6px 8px'}}>
              {/* Collections with expected dates grouped by day */}
              {days.map(day => (
                day.collections && day.collections.length > 0 ? (
                  <div key={day.date}>
                    <div style={{fontSize:15,fontWeight:700,color:'#92400e',padding:'4px 0',borderBottom:'1px solid #fde68a',marginBottom:4,textTransform:'uppercase'}}>{day.day_label}</div>
                    {day.collections.map(o => <CollectionCard key={o.id} order={o} onAction={statusAction} onAssignContractor={setContractorModal} />)}
                  </div>
                ) : null
              ))}
              {/* Unscheduled collections */}
              {unschedCollections.length > 0 && (
                <div>
                  <div style={{fontSize:15,fontWeight:700,color:'#92400e',padding:'4px 0',borderBottom:'1px solid #fde68a',marginBottom:4,textTransform:'uppercase'}}>Ready — No Date Set</div>
                  {unschedCollections.map(o => <CollectionCard key={o.id} order={o} onAction={statusAction} onAssignContractor={setContractorModal} />)}
                </div>
              )}
              {unschedCollections.length === 0 && days.every(d => !d.collections?.length) && (
                <div style={{textAlign:'center',color:'#92400e',fontSize:15,padding:'24px 8px',opacity:0.6}}>
                  No collections pending
                </div>
              )}
            </div>
          </div>

        </div>
      )}

      {/* Contractor Assignment Modal */}
      {contractorModal && (
        <ContractorAssignmentModal
          order={contractorModal}
          token={token}
          onClose={() => setContractorModal(null)}
          onSave={() => { setContractorModal(null); reload(); }}
        />
      )}

      {/* Over Capacity Modal */}
      {overCapacityModal && (
        <DispatchOverCapacityModal
          info={overCapacityModal.info}
          onCancel={() => setOverCapacityModal(null)}
          onProceed={async () => {
            const { dateStr, truckId, dragData } = overCapacityModal.pendingDrop;
            setOverCapacityModal(null);
            try {
              await doAssignDrop(dateStr, truckId, dragData);
            } catch(err) { toast(err.message, 'error'); }
          }}
        />
      )}

      {/* Reschedule Work Order Modal */}
      {rescheduleWOModal && (
        <RescheduleWOModal
          wo={rescheduleWOModal.wo}
          newDate={rescheduleWOModal.newDate}
          newTruckId={rescheduleWOModal.newTruckId}
          trucks={allTrucks}
          onCancel={() => setRescheduleWOModal(null)}
          onConfirm={async () => {
            const { wo, newDate, newTruckId } = rescheduleWOModal;
            setRescheduleWOModal(null);
            try {
              const body = { scheduled_date: newDate };
              if (newTruckId && newTruckId !== wo.truck_id) body.truck_id = newTruckId;
              await api(`/truck-work-orders/${wo.id}`, { method: 'PUT', body: JSON.stringify(body) }, token);
              toast('Work order rescheduled', 'success');
              reload();
            } catch(err) { toast(err.message, 'error'); }
          }}
        />
      )}
    </div>
  );
};

// ═══════════════════════════════════════════════════════════════
// ADMIN PAGE
// ═══════════════════════════════════════════════════════════════
const AdminPage = ({ token }) => {
  const [tab, setTab] = useState('users');
  const [users, setUsers] = useState([]);
  const [zones, setZones] = useState([]);
  const [accConfig, setAccConfig] = useState(null);
  const [loading, setLoading] = useState(true);
  const [userModal, setUserModal] = useState(false);
  const [newUser, setNewUser] = useState({full_name:'',email:'',username:'',role:'floor_worker',pin:'',password:''});
  const [syncLog, setSyncLog] = useState([]);
  // Zone / station CRUD state
  const [zoneModal, setZoneModal] = useState(false);
  const [editingZone, setEditingZone] = useState(null); // null = new zone, object = editing
  const [zoneForm, setZoneForm] = useState({name:'',code:'',capacity_metric:'man_hours_per_station'});
  const [stationModal, setStationModal] = useState(null); // null | { zoneId, station: null|obj }
  const [stationForm, setStationForm] = useState({name:'',station_type:'station',code:''});
  const [deleteConfirm, setDeleteConfirm] = useState(null); // { type:'zone'|'station', id, name }
  const [capacityEdits, setCapacityEdits] = useState({}); // { [stationId]: value }
  // Costing / labour config
  const [labourConfig, setLabourConfig] = useState(null); // { default_rate, user_rates: [] }
  const [labourRateEdit, setLabourRateEdit] = useState(''); // string for the default rate field

  const load = useCallback(async () => {
    setLoading(true);
    try {
      const [u, z, acc, sl, lc] = await Promise.all([
        api('/users', {}, token),
        api('/zones', {}, token),
        api('/accounting/config', {}, token),
        api('/accounting/sync-log?limit=10', {}, token),
        api('/labour-config', {}, token).catch(() => ({ default_rate: 55, user_rates: [] })),
      ]);
      setUsers(u);
      setZones(z);
      setAccConfig(acc);
      setSyncLog(sl);
      setLabourConfig(lc);
      setLabourRateEdit(String(lc?.default_rate ?? 55));
    } catch (e) { toast(e.message,'error'); }
    setLoading(false);
  }, [token]);

  useEffect(() => { load(); }, [load]);

  const deactivateUser = async (id) => {
    try {
      await api(`/users/${id}`, {method:'DELETE'}, token);
      toast('User deactivated','info');
      load();
    } catch (e) { toast(e.message,'error'); }
  };

  const createUser = async () => {
    try {
      await api('/users', {method:'POST',body:JSON.stringify(newUser)}, token);
      toast('User created','success');
      setUserModal(false);
      setNewUser({full_name:'',email:'',username:'',role:'floor_worker',pin:'',password:''});
      load();
    } catch (e) { toast(e.message,'error'); }
  };

  const syncNow = async () => {
    try {
      const r = await api('/accounting/sync', {method:'POST'}, token);
      toast(r.message||'Sync triggered','success');
      load();
    } catch (e) { toast(e.message,'error'); }
  };

  // Zone CRUD
  const openNewZone = () => {
    setEditingZone(null);
    setZoneForm({name:'',code:'',capacity_metric:'man_hours_per_station'});
    setZoneModal(true);
  };
  const openEditZone = (z) => {
    setEditingZone(z);
    setZoneForm({name:z.name, code:z.code||'', capacity_metric:z.capacity_metric||'man_hours_per_station'});
    setZoneModal(true);
  };
  const saveZone = async () => {
    try {
      if (editingZone) {
        await api(`/zones/${editingZone.id}`, {method:'PUT',body:JSON.stringify(zoneForm)}, token);
        toast('Zone updated','success');
      } else {
        await api('/zones', {method:'POST',body:JSON.stringify(zoneForm)}, token);
        toast('Zone created','success');
      }
      setZoneModal(false);
      load();
    } catch(e) { toast(e.message,'error'); }
  };
  const deleteZone = async (id) => {
    try {
      await api(`/zones/${id}`, {method:'DELETE'}, token);
      toast('Zone deleted','info');
      setDeleteConfirm(null);
      load();
    } catch(e) { toast(e.message,'error'); }
  };

  // Station CRUD
  const openNewStation = (zoneId) => {
    setStationModal({ zoneId, station: null });
    setStationForm({name:'',station_type:'station',code:''});
  };
  const openEditStation = (zoneId, s) => {
    setStationModal({ zoneId, station: s });
    setStationForm({name:s.name, station_type:s.station_type||'station', code:s.code||''});
  };
  const saveStation = async () => {
    try {
      if (stationModal.station) {
        await api(`/stations/${stationModal.station.id}`, {method:'PUT',body:JSON.stringify(stationForm)}, token);
        toast('Station updated','success');
      } else {
        await api(`/zones/${stationModal.zoneId}/stations`, {method:'POST',body:JSON.stringify(stationForm)}, token);
        toast('Station added','success');
      }
      setStationModal(null);
      load();
    } catch(e) { toast(e.message,'error'); }
  };
  const deleteStation = async (id) => {
    try {
      await api(`/stations/${id}`, {method:'DELETE'}, token);
      toast('Station deleted','info');
      setDeleteConfirm(null);
      load();
    } catch(e) { toast(e.message,'error'); }
  };

  // Station capacity inline
  const saveStationCapacity = async (stationId, value) => {
    try {
      await api('/station-capacity', {method:'PUT',body:JSON.stringify({station_id:stationId, max_units_per_day:parseInt(value)||0})}, token);
      toast('Capacity saved','success');
    } catch(e) { toast(e.message,'error'); }
  };

  // Labour config
  const saveDefaultRate = async () => {
    try {
      const rate = parseFloat(labourRateEdit);
      if (isNaN(rate) || rate < 0) { toast('Invalid rate','error'); return; }
      await api('/labour-config', {method:'PUT',body:JSON.stringify({rate_per_hour:rate})}, token);
      toast('Default labour rate saved','success');
      setLabourConfig(c => ({...c, default_rate: rate}));
    } catch(e) { toast(e.message,'error'); }
  };
  const saveUserRate = async (userId, rate) => {
    try {
      await api('/labour-config', {method:'PUT',body:JSON.stringify({rate_per_hour:parseFloat(rate)||0, user_id:userId})}, token);
      toast('User rate saved','success');
      const lc = await api('/labour-config', {}, token).catch(()=>labourConfig);
      setLabourConfig(lc);
    } catch(e) { toast(e.message,'error'); }
  };

  const ROLES = ['executive','admin','office','planner','floor_worker','team_leader','qa','dispatch','ops_manager'];
  const STATION_TYPES = ['machine','table','centre','station'];
  const CAPACITY_METRICS = ['units_per_machine','man_hours_per_table','man_hours_per_centre','man_hours_per_station'];

  return (
    <div className="p-6 space-y-4">
      <h1 className="text-2xl font-black text-[#07324C]">Admin</h1>

      <div className="tab-bar">
        {['users','zones','costing','accounting'].map(t => (
          <div key={t} className={`tab-item ${tab===t?'active':''}`} onClick={()=>setTab(t)} style={{textTransform:'capitalize'}}>{t}</div>
        ))}
      </div>

      {loading ? <div className="flex justify-center py-12"><Spinner /></div> : (
        <>
          {/* USERS */}
          {tab === 'users' && (
            <div className="hp-card">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-sm font-bold text-gray-500 uppercase tracking-wider">Users ({users.length})</h2>
                <button className="btn btn-primary btn-sm" onClick={()=>setUserModal(true)}>+ Add User</button>
              </div>
              <div className="table-scroll">
                <table className="hp-table">
                  <thead><tr><th>Name</th><th>Email / Username</th><th>Role</th><th>Zone</th><th>Active</th><th></th></tr></thead>
                  <tbody>
                    {users.map(u => (
                      <tr key={u.id}>
                        <td className="font-semibold">{u.full_name}</td>
                        <td className="text-xs text-gray-500">{u.email||u.username||'—'}</td>
                        <td><span className="badge badge-C" style={{textTransform:'capitalize'}}>{u.role?.replace('_',' ')}</span></td>
                        <td>{u.default_zone_id||'—'}</td>
                        <td>{u.is_active ? <span className="text-green-600 font-bold text-xs">Active</span> : <span className="text-gray-400 text-xs">Inactive</span>}</td>
                        <td>
                          {u.is_active && (
                            <button className="btn btn-danger btn-sm" onClick={()=>deactivateUser(u.id)}>Deactivate</button>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {userModal && (
                <div className="overlay" onClick={e=>e.target===e.currentTarget&&setUserModal(false)}>
                  <div className="modal">
                    <h3 className="font-black text-[#07324C] text-lg mb-4">Add New User</h3>
                    <div className="space-y-3">
                      {[['full_name','Full Name','text'],['email','Email','email'],['username','Username (floor)','text'],['password','Password','password'],['pin','PIN (floor)','text']].map(([field,label,type]) => (
                        <div key={field}>
                          <label className="hp-label">{label}</label>
                          <input type={type} className="hp-input" value={newUser[field]} onChange={e=>setNewUser(p=>({...p,[field]:e.target.value}))} />
                        </div>
                      ))}
                      <div>
                        <label className="hp-label">Role</label>
                        <select className="hp-input" value={newUser.role} onChange={e=>setNewUser(p=>({...p,role:e.target.value}))}>
                          {ROLES.map(r=><option key={r} value={r}>{r.replace('_',' ')}</option>)}
                        </select>
                      </div>
                    </div>
                    <div className="flex gap-3 mt-6">
                      <button className="btn btn-primary flex-1 justify-center" onClick={createUser}>Create User</button>
                      <button className="btn btn-secondary" onClick={()=>setUserModal(false)}>Cancel</button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* ZONES */}
          {tab === 'zones' && (
            <div className="space-y-4">
              <div className="flex items-center justify-between">
                <h2 className="text-sm font-bold text-gray-500 uppercase tracking-wider">Zones &amp; Stations</h2>
                <button className="btn btn-primary btn-sm" onClick={openNewZone}>+ Add Zone</button>
              </div>

              {zones.length === 0 && <div className="hp-card"><Empty msg="No zones configured" /></div>}

              {zones.map(z => (
                <div key={z.id} className="hp-card">
                  {/* Zone header */}
                  <div className="flex items-start justify-between mb-3">
                    <div>
                      <h3 className="font-black text-[#07324C] text-lg">{z.name}</h3>
                      <div className="text-xs text-gray-400 uppercase tracking-wider mt-0.5">Code: {z.code||'—'} &middot; Metric: {z.capacity_metric}</div>
                    </div>
                    <div className="flex gap-2">
                      <button className="btn btn-secondary btn-sm" onClick={()=>openEditZone(z)}>Edit</button>
                      <button className="btn btn-danger btn-sm" onClick={()=>setDeleteConfirm({type:'zone',id:z.id,name:z.name})}>Delete</button>
                    </div>
                  </div>

                  {/* Stations table */}
                  <div className="mt-2">
                    <div className="flex items-center justify-between mb-2">
                      <div className="text-xs font-bold text-gray-400 uppercase tracking-wider">Stations ({z.stations?.length||0})</div>
                      <button className="btn btn-secondary btn-sm" style={{fontSize:15,padding:'2px 8px'}} onClick={()=>openNewStation(z.id)}>+ Add Station</button>
                    </div>
                    {(!z.stations || z.stations.length === 0) ? (
                      <div className="text-xs text-gray-400 italic py-1">No stations configured</div>
                    ) : (
                      <div className="table-scroll">
                        <table className="hp-table" style={{fontSize:15}}>
                          <thead>
                            <tr>
                              <th>Name</th>
                              <th>Type</th>
                              <th>Code</th>
                              <th>Capacity / Day</th>
                              <th></th>
                            </tr>
                          </thead>
                          <tbody>
                            {z.stations.map(s => (
                              <tr key={s.id}>
                                <td className="font-semibold">{s.name}</td>
                                <td><span className="badge badge-C" style={{textTransform:'capitalize'}}>{s.station_type}</span></td>
                                <td className="text-xs text-gray-500">{s.code||'—'}</td>
                                <td>
                                  <input
                                    type="number" min="0" step="1"
                                    className="hp-input"
                                    style={{width:80,padding:'2px 6px',fontSize:14}}
                                    defaultValue={s.max_units_per_day ?? ''}
                                    placeholder="—"
                                    onBlur={e => saveStationCapacity(s.id, e.target.value)}
                                  />
                                </td>
                                <td>
                                  <div className="flex gap-1">
                                    <button className="btn btn-secondary btn-sm" style={{fontSize:15,padding:'2px 7px'}} onClick={()=>openEditStation(z.id,s)}>Edit</button>
                                    <button className="btn btn-danger btn-sm" style={{fontSize:15,padding:'2px 7px'}} onClick={()=>setDeleteConfirm({type:'station',id:s.id,name:s.name})}>Del</button>
                                  </div>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                </div>
              ))}

              {/* Zone modal */}
              {zoneModal && (
                <div className="overlay" onClick={e=>e.target===e.currentTarget&&setZoneModal(false)}>
                  <div className="modal" style={{maxWidth:420}}>
                    <h3 className="font-black text-[#07324C] text-lg mb-4">{editingZone ? 'Edit Zone' : 'New Zone'}</h3>
                    <div className="space-y-3">
                      <div>
                        <label className="hp-label">Zone Name</label>
                        <input className="hp-input" value={zoneForm.name} onChange={e=>setZoneForm(p=>({...p,name:e.target.value}))} placeholder="e.g. Assembly" />
                      </div>
                      <div>
                        <label className="hp-label">Code</label>
                        <input className="hp-input" value={zoneForm.code} onChange={e=>setZoneForm(p=>({...p,code:e.target.value}))} placeholder="e.g. ASM" />
                      </div>
                      <div>
                        <label className="hp-label">Capacity Metric</label>
                        <select className="hp-input" value={zoneForm.capacity_metric} onChange={e=>setZoneForm(p=>({...p,capacity_metric:e.target.value}))}>
                          {CAPACITY_METRICS.map(m=><option key={m} value={m}>{m.replace(/_/g,' ')}</option>)}
                        </select>
                      </div>
                    </div>
                    <div className="flex gap-3 mt-6">
                      <button className="btn btn-primary flex-1 justify-center" onClick={saveZone}>{editingZone ? 'Save Changes' : 'Create Zone'}</button>
                      <button className="btn btn-secondary" onClick={()=>setZoneModal(false)}>Cancel</button>
                    </div>
                  </div>
                </div>
              )}

              {/* Station modal */}
              {stationModal && (
                <div className="overlay" onClick={e=>e.target===e.currentTarget&&setStationModal(null)}>
                  <div className="modal" style={{maxWidth:400}}>
                    <h3 className="font-black text-[#07324C] text-lg mb-4">{stationModal.station ? 'Edit Station' : 'Add Station'}</h3>
                    <div className="space-y-3">
                      <div>
                        <label className="hp-label">Station Name</label>
                        <input className="hp-input" value={stationForm.name} onChange={e=>setStationForm(p=>({...p,name:e.target.value}))} placeholder="e.g. Table 1" />
                      </div>
                      <div>
                        <label className="hp-label">Station Type</label>
                        <select className="hp-input" value={stationForm.station_type} onChange={e=>setStationForm(p=>({...p,station_type:e.target.value}))}>
                          {STATION_TYPES.map(t=><option key={t} value={t}>{t}</option>)}
                        </select>
                      </div>
                      <div>
                        <label className="hp-label">Code (optional)</label>
                        <input className="hp-input" value={stationForm.code} onChange={e=>setStationForm(p=>({...p,code:e.target.value}))} placeholder="e.g. T1" />
                      </div>
                    </div>
                    <div className="flex gap-3 mt-6">
                      <button className="btn btn-primary flex-1 justify-center" onClick={saveStation}>{stationModal.station ? 'Save Changes' : 'Add Station'}</button>
                      <button className="btn btn-secondary" onClick={()=>setStationModal(null)}>Cancel</button>
                    </div>
                  </div>
                </div>
              )}

              {/* Delete confirm */}
              {deleteConfirm && (
                <div className="overlay" onClick={e=>e.target===e.currentTarget&&setDeleteConfirm(null)}>
                  <div className="modal" style={{maxWidth:380}}>
                    <h3 className="font-black text-[#07324C] text-lg mb-3">Delete {deleteConfirm.type === 'zone' ? 'Zone' : 'Station'}?</h3>
                    <p className="text-sm text-gray-600 mb-5">Are you sure you want to delete <strong>{deleteConfirm.name}</strong>? This cannot be undone.</p>
                    <div className="flex gap-3">
                      <button className="btn btn-secondary flex-1 justify-center" onClick={()=>setDeleteConfirm(null)}>Cancel</button>
                      <button className="btn btn-danger flex-1 justify-center" onClick={()=>deleteConfirm.type==='zone'?deleteZone(deleteConfirm.id):deleteStation(deleteConfirm.id)}>Delete</button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* COSTING */}
          {tab === 'costing' && (
            <div className="space-y-4">
              {/* Default labour rate */}
              <div className="hp-card">
                <h2 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4">Labour Rate Config</h2>
                <div className="flex items-end gap-4 mb-6">
                  <div style={{flex:'0 0 220px'}}>
                    <label className="hp-label">Default Labour Rate ($/hr)</label>
                    <input
                      type="number" min="0" step="0.5" className="hp-input"
                      value={labourRateEdit}
                      onChange={e=>setLabourRateEdit(e.target.value)}
                    />
                  </div>
                  <button className="btn btn-primary btn-sm" onClick={saveDefaultRate}>Save Rate</button>
                </div>
                <div className="p-3 bg-blue-50 rounded-lg text-sm text-blue-800 mb-4">
                  Current default: <strong>${labourConfig?.default_rate?.toFixed(2) ?? '55.00'}/hr</strong> — used for all job costing unless overridden per-user below.
                </div>

                {/* Per-user rates table */}
                <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Per-User Rate Overrides</h3>
                {(!labourConfig?.user_rates || labourConfig.user_rates.length === 0) ? (
                  <div className="text-xs text-gray-400 italic">No per-user overrides set. All users use the default rate above.</div>
                ) : (
                  <div className="table-scroll">
                    <table className="hp-table">
                      <thead><tr><th>User</th><th>Rate ($/hr)</th><th></th></tr></thead>
                      <tbody>
                        {labourConfig.user_rates.map(ur => {
                          const u = users.find(x=>x.id===ur.user_id);
                          return (
                            <tr key={ur.user_id}>
                              <td className="font-semibold">{u?.full_name||`User #${ur.user_id}`}</td>
                              <td>
                                <input
                                  type="number" min="0" step="0.5" className="hp-input"
                                  style={{width:90,padding:'2px 6px',fontSize:15}}
                                  defaultValue={ur.rate_per_hour}
                                  onBlur={e=>saveUserRate(ur.user_id, e.target.value)}
                                />
                              </td>
                              <td className="text-xs text-gray-500">(save on blur)</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                )}

                {/* Add override for a user */}
                <div className="mt-5 pt-4 border-t border-gray-100">
                  <h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Add Override for User</h4>
                  <div className="flex gap-3 items-end flex-wrap">
                    <div style={{flex:'0 0 200px'}}>
                      <label className="hp-label">User</label>
                      <select className="hp-input" id="labour-user-select">
                        <option value="">Select user...</option>
                        {users.filter(u=>u.is_active).map(u=><option key={u.id} value={u.id}>{u.full_name}</option>)}
                      </select>
                    </div>
                    <div style={{flex:'0 0 120px'}}>
                      <label className="hp-label">Rate ($/hr)</label>
                      <input type="number" min="0" step="0.5" className="hp-input" id="labour-rate-input" defaultValue="55" />
                    </div>
                    <button className="btn btn-primary btn-sm" onClick={() => {
                      const uid = document.getElementById('labour-user-select').value;
                      const rate = document.getElementById('labour-rate-input').value;
                      if (!uid) { toast('Select a user','error'); return; }
                      saveUserRate(parseInt(uid), rate);
                    }}>Set Rate</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* ACCOUNTING */}
          {tab === 'accounting' && (
            <div className="hp-card">
              <h2 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4">Accounting Integration</h2>
              {accConfig && (
                <div className="space-y-3 mb-6">
                  <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                      <div className="font-bold text-[#07324C]">Provider: {accConfig.provider || 'Mock'}</div>
                      <div className="text-xs text-gray-500 mt-1">Last sync: {accConfig.last_sync_at ? new Date(accConfig.last_sync_at).toLocaleString() : 'Never'}</div>
                    </div>
                    <div className={`px-3 py-1 rounded-full text-xs font-bold ${accConfig.is_connected ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>
                      {accConfig.is_connected ? 'Connected' : 'Not Connected'}
                    </div>
                  </div>
                  <button className="btn btn-primary btn-lg w-full justify-center" onClick={syncNow}>
                    <Icon name="RefreshCw" size={16}/> Sync Now
                  </button>
                </div>
              )}
              <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">Sync History</h3>
              {syncLog.length === 0 ? <Empty msg="No sync history" /> : (
                <div className="table-scroll">
                  <table className="hp-table">
                    <thead><tr><th>Direction</th><th>Entity</th><th>Status</th><th>Details</th><th>Time</th></tr></thead>
                    <tbody>
                      {syncLog.map(l => (
                        <tr key={l.id}>
                          <td className="capitalize">{l.direction}</td>
                          <td>{l.entity_type}</td>
                          <td><span className={`font-bold text-xs ${l.status==='success'?'text-green-600':'text-red-600'}`}>{l.status}</span></td>
                          <td className="text-xs text-gray-500">{l.details}</td>
                          <td className="text-xs text-gray-500">{l.synced_at?.split('T')[0]}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}
        </>
      )}
    </div>
  );
};

// ═══════════════════════════════════════════════════════════════
// MAIN APP
// ═══════════════════════════════════════════════════════════════
const App = () => {
  const [user, setUser] = useState(null);
  const [token, setToken] = useState(null);
  const [page, setPage] = useState('dashboard');
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);

  const handleLogin = (u, t) => {
    if (!u || !u.role) { console.error('Invalid user object:', u); return; }
    setUser(u);
    setToken(t);
    // Redirect floor workers to production, prod managers to station allocation
    if (u.role === 'floor_worker' || u.role === 'team_leader') {
      setPage('floor');
      setSidebarCollapsed(true);
    } else if (u.role === 'production_manager') {
      setPage('allocation');
    } else {
      setPage('dashboard');
    }
  };

  const handleLogout = () => { setUser(null); setToken(null); setPage('dashboard'); };

  const handleNav = (p) => {
    setPage(p);
    if (p === 'floor') setSidebarCollapsed(true);
    else setSidebarCollapsed(false);
  };

  if (!user) return <LoginPage onLogin={handleLogin} />;

  const renderPage = () => {
    switch(page) {
      case 'dashboard': return <Dashboard token={token} />;
      case 'office': return <OfficeDashboard token={token} />;
      case 'planning': return <PlanningBoard token={token} />;
      case 'allocation': return <ProductionManager token={token} />;
      case 'floor': {
        const isFloorWorker = user?.role === 'floor_worker';
        const canAccessWorkerTab = ['team_leader','production_manager','planner','executive'].includes(user?.role);
        if (isFloorWorker) return <FloorTablet token={token} user={user} />;
        if (canAccessWorkerTab) return <ProductionFloorWithWorkerTab token={token} user={user} />;
        return <ProductionFloorOverview token={token} />;
      }
      case 'qa': return <QADashboard token={token} />;
      case 'dispatch': return <DispatchDashboard token={token} />;
      case 'admin': return <AdminPage token={token} />;
      case 'ops': return <Dashboard token={token} isOps={true} />;
      default: return <Dashboard token={token} />;
    }
  };

  return (
    <div style={{display:'flex',height:'100vh',overflow:'hidden'}}>
      <Sidebar page={page} onNav={handleNav} user={user} onLogout={handleLogout} collapsed={sidebarCollapsed} />
      <main style={{flex:1,overflow:'auto',background:'#F5F7FA'}}>
        {renderPage()}
      </main>
    </div>
  );
};

// Error boundary to catch rendering crashes
class ErrorBoundary extends React.Component {
  constructor(props) { super(props); this.state = { error: null, info: null }; }
  static getDerivedStateFromError(error) { return { error }; }
  componentDidCatch(error, info) { this.setState({ info }); console.error('React crash:', error, info); }
  render() {
    if (this.state.error) {
      return React.createElement('div', { style: { padding: '40px', fontFamily: 'monospace' } },
        React.createElement('h1', { style: { color: '#ED1C24' } }, 'Application Error'),
        React.createElement('p', null, this.state.error.toString()),
        React.createElement('pre', { style: { background: '#f5f5f5', padding: '20px', overflow: 'auto', fontSize: '12px' } },
          this.state.info?.componentStack || 'No stack trace')
      );
    }
    return this.props.children;
  }
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<ErrorBoundary><App /></ErrorBoundary>);
</script>
</body>
</html>
